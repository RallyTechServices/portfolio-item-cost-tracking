<!DOCTYPE html>
<html>
<head>
    <title>portfolio-item-cost-tracking</title>

    <script type="text/javascript" src="https://rally1.rallydev.com//apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("PortfolioItemCostTracking",{extend:"Rally.app.App",componentCls:"app",defaults:{startDate:new Date("2015-06-01"),endDate:new Date("2016-05-31"),groupByRelease:!1},config:{defaultSettings:{selectedCalculationType:"points",normalizedCostPerUnit:1e3,projectCostPerUnit:{},currencySign:"$"}},items:[],portfolioItemRollupData:{},launch:function(){var state=Ext.state.Manager.get(this.getContext().getScopedStateId("cb-type")),state_val=state?state.value:null;Deft.Promise.all([PortfolioItemCostTracking.WsapiToolbox.fetchPortfolioItemTypes(),PortfolioItemCostTracking.WsapiToolbox.fetchDoneStates(),PortfolioItemCostTracking.WsapiToolbox.fetchModelTypePathByTypeDefinition(state_val)]).then({scope:this,success:function(results){this._initializeSettings(this.getSettings(),results[1],results[0]),this._createPickers()},failure:function(msg){Rally.ui.notify.Notifier.showError({message:msg})}})},_createPickers:function(){this.fixedHeader=Ext.create("Ext.container.Container",{itemId:"header-controls",width:460,height:50,layout:"hbox",padding:"0 0 20 20",margin:10,items:[{xtype:"rallydatefield",itemId:"dt-start",margin:"0 10 0 0",value:this.defaults.startDate,padding:5,fieldLabel:"Start Date",labelSeparator:"",labelCls:"lbl",labelAlign:"top",listeners:{scope:this,change:this.updateStoreFilters}},{xtype:"rallydatefield",itemId:"dt-end",margin:"0 10 0 0",labelSeparator:"",labelCls:"lbl",value:this.defaults.endDate,fieldLabel:"End Date",labelAlign:"top",listeners:{scope:this,change:this.updateStoreFilters}},{xtype:"rallyportfolioitemtypecombobox",itemId:"cb-type",margin:"0 10 0 0",fieldLabel:"Portfolio Item Type",labelAlign:"top",labelCls:"lbl",listeners:{scope:this,ready:function(picker){console.log("ready")}}}]}),this.fixedHeader.down("#cb-type").on("change",this._onTypeChange,this)},_onTypeChange:function(piPicker){var piType=piPicker.getRecord().get("TypePath");this.modelNames=[piType],this._initializeGrid(this.modelNames)},_initializeSettings:function(settings,doneScheduleStates,portfolioItemTypes){PortfolioItemCostTracking.Settings.notAvailableText="--",PortfolioItemCostTracking.Settings.currencySign=settings.currencySign,PortfolioItemCostTracking.Settings.currencyPrecision=0,PortfolioItemCostTracking.Settings.currencyEnd=!1,doneScheduleStates&&(PortfolioItemCostTracking.Settings.completedScheduleStates=doneScheduleStates),portfolioItemTypes&&(PortfolioItemCostTracking.Settings.portfolioItemTypes=portfolioItemTypes),PortfolioItemCostTracking.Settings.normalizedCostPerUnit=settings.normalizedCostPerUnit;var project_cpu=settings.projectCostPerUnit||{};Ext.isObject(project_cpu)||(project_cpu=Ext.JSON.decode(project_cpu)),PortfolioItemCostTracking.Settings.projectCostPerUnit=project_cpu,PortfolioItemCostTracking.Settings.setCalculationType(settings.selectedCalculationType)},_initializeGrid:function(modelNames){if(this.rollupData&&this.rollupData.clearRollupData(),this.down("treegridcontainer")){if(this.fixedHeader&&this.fixedHeader.rendered){var parent=this.fixedHeader.up();parent&&parent.remove&&parent.remove(this.fixedHeader,!1)}this.down("treegridcontainer").destroy()}var filters=this._getDateFilters();console.log("filters",""+filters),Ext.create("Rally.data.wsapi.TreeStoreBuilder").build({models:modelNames,filters:filters,fetch:PortfolioItemCostTracking.Settings.getTreeFetch(),enableHierarchy:!0,listeners:{scope:this,load:this._setRollupData}}).then({scope:this,success:function(store){console.log("store",store.listeners),store.model.addField({name:"_rollupDataPreliminaryBudget",type:"auto",defaultValue:null,displayName:"Preliminary Budget"}),store.model.addField({name:"_rollupDataTotalCost",type:"auto",defaultValue:null,displayName:"Total Cost"}),store.model.addField({name:"_rollupDataRemainingCost",type:"auto",defaultValue:null,displayName:"Remaining Cost"}),store.model.addField({name:"_rollupDataActualCost",type:"auto",defaultValue:null,displayName:"Actual Cost"}),store.model.addField({name:"_rollupDataToolTip",type:"string",defaultValue:null}),this._updateDisplay(store,modelNames)}})},getStartDate:function(){return this.getDate("dt-start",this.defaults.startDate)},getEndDate:function(){return this.getDate("dt-end",this.defaults.endDate)},getDate:function(itemId,defaultDate){var dt=defaultDate,cmpId="#"+itemId;if(this.down(cmpId))dt=this.down(cmpId).getValue();else{var state=Ext.state.Manager.get(this.getContext().getScopedStateId(itemId));state&&state.value&&(dt=new Date(state.value))}return dt},addHeader:function(gb){var header=gb.getHeader();header&&header.getLeft().add(this.fixedHeader)},_showExportMenu:function(){var filters=this._getDateFilters(),fetch=PortfolioItemCostTracking.Settings.getTreeFetch(),root_model=this.modelNames[0],export_columns=this._getExportColumns();PortfolioItemCostTracking.Utilities.fetchExportData(root_model,filters,fetch,export_columns).then({scope:this,success:function(results){console.log("success",results);var cols=this._getFormattedIDExportColumns(root_model).concat(export_columns),rows=[];_.each(results,function(row_hash){var row=[];_.each(cols,function(c){var col_idx=c;Ext.isObject(c)&&(col_idx=c.dataIndex||c.costField),console.log(c,row_hash),row.push(row_hash[col_idx]||null)}),rows.push(row.join(","))});var csv=rows.join("\r\n");console.log("csv",csv)},failure:function(msg){console.log("failure",msg)}})},_getFormattedIDExportColumns:function(rootModel){var cols=[],pi_types=PortfolioItemCostTracking.Settings.getPortfolioItemTypes(),idx=_.indexOf(pi_types,rootModel.toLowerCase());return idx>=0&&(cols=pi_types.slice(idx)),cols.push("hierarchicalrequirement"),cols},_getExportColumns:function(){var cols=this._getColumnCfgs().concat(this._getCustomColumns());return cols},_getDateFilters:function(){var start_date=this.getStartDate(),end_date=this.getEndDate(),filter_actual=[{property:"ActualEndDate",operator:">=",value:Rally.util.DateTime.toIsoString(start_date)},{property:"ActualEndDate",operator:"<",value:Rally.util.DateTime.toIsoString(end_date)}];filter_actual=Rally.data.wsapi.Filter.and(filter_actual);var filter_planned=[{property:"ActualEndDate",value:null},{property:"PlannedEndDate",operator:"<",value:Rally.util.DateTime.toIsoString(end_date)},{property:"PlannedEndDate",operator:">=",value:Rally.util.DateTime.toIsoString(start_date)}];return filter_planned=Rally.data.wsapi.Filter.and(filter_planned),filter_actual.or(filter_planned)},updateStoreFilters:function(){this.down("treegridcontainer")&&(this.down("treegridcontainer").storeConfig.filters=this._getDateFilters(),this.down("treegridcontainer").applyCustomFilter(this.down("treegridcontainer").currentCustomFilter))},_setRollupData:function(store,node,records,success){var rollup_data=this.rollupData;console.log("_setrollupData",store,node,records.length,success),rollup_data||(this.rollupData=new PortfolioItemCostTracking.RollupData,rollup_data=this.rollupData),_.each(records,function(r){rollup_data.setRollupData(r)},this)},_updateStore:function(fields){var filters=this._getDateFilters(),field_names=Ext.Array.map(fields,function(f){return f.get("name")});Ext.create("Rally.data.wsapi.TreeStoreBuilder").build({models:this.modelNames,filters:filters,fetch:PortfolioItemCostTracking.Settings.getTreeFetch(field_names),enableHierarchy:!0,listeners:{scope:this,load:this._setRollupData}}).then({scope:this,success:function(store){store.model.addField({name:"_rollupDataPreliminaryBudget",type:"auto",defaultValue:null,displayName:"Preliminary Budget"}),store.model.addField({name:"_rollupDataTotalCost",type:"auto",defaultValue:null,displayName:"Total Cost"}),store.model.addField({name:"_rollupDataRemainingCost",type:"auto",defaultValue:null,displayName:"Remaining Cost"}),store.model.addField({name:"_rollupDataActualCost",type:"auto",defaultValue:null,displayName:"Actual Cost"}),store.model.addField({name:"_rollupDataToolTip",type:"string",defaultValue:null}),this.down("treegridcontainer").gridConfig.columnCfgs=this._getColumnCfgs(fields),this.down("treegridcontainer").updateStore(store)}})},_updateDisplay:function(store,modelNames){var me=this;this.add({xtype:"treegridcontainer",context:this.getContext(),gridConfig:{columnCfgs:this._getColumnCfgs(),customColumns:this._getCustomColumns(),store:store},plugins:[{ptype:"treegridcontainercustomfiltercontrol",filterControlConfig:{modelNames:modelNames,margin:"15px 10px 0px 0px"},showOwnerFilter:!0,ownerFilterControlConfig:{margin:"15px 10px 0px 0px"}},{ptype:"treegridcontainerfieldpicker",headerPosition:"left",modelNames:modelNames,alwaysSelectedFields:["_rollupDataPreliminaryBudget","_rollupDataTotalCost","_rollupDataRemainingCost","_rollupDataActualCost"],margin:"15px 0px 10px 10px"},{ptype:"rallygridboardactionsmenu",menuItems:[{text:"Export...",handler:me._showExportMenu,scope:me}],buttonConfig:{iconCls:"icon-export",margin:"15px 10px 0px 0px"}}],listeners:{beforerender:function(gb){this.addHeader(gb)},updatefields:function(fields){this._updateStore(fields)},scope:this},height:this.getHeight()})},_getCustomColumns:function(){return[{text:"Actual Cost To Date",align:"right",xtype:"costtemplatecolumn",costField:"_rollupDataActualCost"},{text:"Remaining Cost",align:"right",xtype:"costtemplatecolumn",costField:"_rollupDataRemainingCost"},{text:"Total Projected",align:"right",xtype:"costtemplatecolumn",costField:"_rollupDataTotalCost"},{text:"Preliminary Budget",align:"right",xtype:"costtemplatecolumn",costField:"_rollupDataPreliminaryBudget"}]},_getColumnCfgs:function(fields){return fields?Ext.Array.map(fields,function(f){return{dataIndex:f.get("name"),text:f.get("displayName")}}):[{dataIndex:"Name",text:"Name",flex:5},{dataIndex:"Project",text:"Project",editor:!1},{dataIndex:"PlanEstimate",text:"Plan Estimate"},{dataIndex:"PercentDoneByStoryPlanEstimate",text:"% Done by Story Points"}]},getSettingsFields:function(){return PortfolioItemCostTracking.Settings.getFields(this.getSettings())},onSettingsUpdate:function(settings){this._initializeSettings(settings),this._initializeGrid(this.modelNames)}});
                Ext.define("PortfolioItemCostTracking.Settings",{singleton:!0,selectedCalculationType:void 0,currencySign:"$",currencyPrecision:0,currencyEnd:!1,normalizedCostPerUnit:1,projectCostPerUnit:{},calculationTypes:{points:{key:"points",label:"Based on Story Points",displayName:"Story Points",defaultColumns:["Name","Project","PlanEstimate","LeafStoryPlanEstimateTotal"],additionalStoryFetch:["PlanEstimate"],actualUnitsForStoryFn:function(data){return data.PlanEstimate&&Ext.Array.contains(PortfolioItemCostTracking.Settings.completedScheduleStates,data.ScheduleState)?data.PlanEstimate||0:0},totalUnitsForStoryFn:function(data){return data.PlanEstimate||0}},taskHours:{key:"taskHours",displayName:"Task Actuals",label:"Based on Task Actuals",defaultColumns:["Name","Project"],additionalStoryFetch:["TaskEstimateTotal","TaskActualTotal","TaskRemainingTotal"],actualUnitsForStoryFn:function(data){return data.TaskActualTotal||0},totalUnitsForStoryFn:function(data){return(data.TaskActualTotal||0)+(data.TaskRemainingTotal||0)},actualUnitsForTaskFn:function(data){return data.Actuals||0},totalUnitsForTaskFn:function(data){return(data.ToDo||0)+(data.Actuals||0)}},timesheets:{key:"timesheets",displayName:"Time Spent",label:"Based on Timesheets",defaultColumns:["Name","Project"],additionalStoryFetch:[],disabled:!0,actualUnitsForStoryFn:function(data){return 0},actualUnitsForTaskFn:function(data){return 0},totalUnitsForStoryFn:function(data){return 0},totalUnitsForTaskFn:function(data){return 0}}},portfolioItemFetch:["ObjectID","FormattedID","Parent","Children","UserStories","PreliminaryEstimate","Value"],storyFetch:["ObjectID","FormattedID","Project","ScheduleState","PortfolioItem"],treeFetch:["ObjectID","FormattedID","Name","Project","PreliminaryEstimate","PlanEstimate","PercentDoneByStoryPlanEstimate","AcceptedLeafStoryPlanEstimateTotal","LeafStoryPlanEstimateTotal","Children","ToDo","Actuals"],notAvailableText:"--",completedScheduleStates:[],currencyData:[{name:"US Dollars",value:"$"},{name:"Euro",value:"&#128;"},{name:"Japanese Yen",value:"&#165;"},{name:"Brazilian Real",value:"R$"}],setCalculationType:function(type){console.log("setCalculationType",type),"taskHours"===type&&Rally.data.ModelFactory.getModel({type:"task",success:function(model){var field=model.getField("Actuals");console.log("validate",field),field&&field.hidden&&Rally.ui.notify.Notifier.showWarning({message:"The Task Actuals field is not visible in the current project.  As a result, Task Actuals values may be 0."})}}),PortfolioItemCostTracking.Settings.selectedCalculationType=PortfolioItemCostTracking.Settings.calculationTypes[type]?type:"points"},getPortfolioItemTypes:function(){return _.map(this.portfolioItemTypes,function(p){return p.toLowerCase()})},getCalculationTypeSettings:function(){return PortfolioItemCostTracking.Settings.calculationTypes[PortfolioItemCostTracking.Settings.selectedCalculationType]||PortfolioItemCostTracking.Settings.calculationTypes.points},getCalculationTypeDisplayName:function(){return PortfolioItemCostTracking.Settings.getCalculationTypeSettings().displayName||"Unknown"},formatCost:function(cost){return Ext.util.Format.currency(cost,PortfolioItemCostTracking.Settings.currencySign,PortfolioItemCostTracking.Settings.currencyPrecision,PortfolioItemCostTracking.Settings.currencyEnd)},getCostPerUnit:function(project_ref){return PortfolioItemCostTracking.Settings.projectCostPerUnit[project_ref]||PortfolioItemCostTracking.Settings.normalizedCostPerUnit},isProjectUsingNormalizedCost:function(project_ref){return PortfolioItemCostTracking.Settings.projectCostPerUnit[project_ref]?!1:!0},getTreeFetch:function(fetch){return fetch||(fetch=[]),Ext.Array.merge(fetch,PortfolioItemCostTracking.Settings.treeFetch)},getStoryFetch:function(fetch){return fetch||(fetch=[]),console.log("Settings.getStoryFetch",fetch),fetch=Ext.Array.merge(fetch,PortfolioItemCostTracking.Settings.storyFetch),console.log("Settings.getStoryFetch 1",fetch),fetch=Ext.Array.merge(fetch,PortfolioItemCostTracking.Settings.getCalculationTypeSettings().additionalStoryFetch),console.log("Settings.getStoryFetch 2",fetch),fetch},getPortfolioItemFetch:function(fetch){return fetch||(fetch=[]),Ext.Array.merge(fetch,PortfolioItemCostTracking.Settings.portfolioItemFetch)},getFields:function(config){var current_calculation_type=config&&config.selectedCalculationType||"points",current_project_costs=config&&config.projectCostPerUnit||{},currency_store=Ext.create("Rally.data.custom.Store",{data:PortfolioItemCostTracking.Settings.currencyData}),labelWidth=100,cost_items=[];return _.each(PortfolioItemCostTracking.Settings.calculationTypes,function(obj,key){cost_items.push({boxLabel:obj.label||key,name:"selectedCalculationType",inputValue:key,disabled:obj.disabled||!1,checked:key===current_calculation_type})}),[{xtype:"rallycombobox",name:"currencySign",store:currency_store,displayField:"name",valueField:"value",fieldLabel:"Currency",labelWidth:labelWidth,margin:"10 0 10 0"},{xtype:"radiogroup",fieldLabel:"Calculate Cost",columns:1,vertical:!0,labelWidth:labelWidth,margin:"10 0 10 0",items:cost_items},{xtype:"rallytextfield",name:"normalizedCostPerUnit",fieldLabel:"Normalized Cost Per Unit",labelWidth:labelWidth,width:200,margin:"25 0 0 0"},{xtype:"costperprojectsettings",name:"projectCostPerUnit",fieldLabel:"Optionally define costs per unit for individual teams (exceptions to the normalized cost)",labelAlign:"top",margin:"25 0 0 0",readyEvent:"ready"}]}});
                Ext.define("PortfolioItemCostTracking.WsapiToolbox",{singleton:!0,fetchWsapiCount:function(model,query_filters){var deferred=Ext.create("Deft.Deferred"),store=Ext.create("Rally.data.wsapi.Store",{model:model,fetch:["ObjectID"],filters:query_filters,limit:1,pageSize:1}).load({callback:function(records,operation,success){success?deferred.resolve(operation.resultSet.totalRecords):deferred.reject(Ext.String.format("Error getting {0} count for {1}: {2}",model,""+query_filters,operation.error.errors.join(",")))}});return deferred},fetchModelTypePathByTypeDefinition:function(typeDef){var deferred=Ext.create("Deft.Deferred"),typeDefId=0;typeDef&&(typeDefId=typeDef.replace("/typedefinition/",""));var store=Ext.create("Rally.data.wsapi.Store",{model:"TypeDefinition",fetch:["TypePath","Name"],filters:[{property:"ObjectID",value:typeDefId}]}).load({callback:function(records,operation,success){success&&records&&records.length>0?deferred.resolve(records[0].get("TypePath")):deferred.resolve(null)}});return deferred},fetchWsapiRecords:function(model,query_filters,fetch_fields,context){var deferred=Ext.create("Deft.Deferred"),store=Ext.create("Rally.data.wsapi.Store",{model:model,fetch:fetch_fields,filters:query_filters,context:context,limit:1/0}).load({callback:function(records,operation,success){success?deferred.resolve(records):deferred.reject(Ext.String.format("Error getting {0} for {1}: {2}",model,""+query_filters,operation.error.errors.join(",")))}});return deferred},fetchReleases:function(timebox){var deferred=Ext.create("Deft.Deferred"),rec=timebox.getRecord(),me=this;return null===rec&&deferred.resolve([]),Ext.create("Rally.data.wsapi.Store",{model:"Release",fetch:["ObjectID"],filters:[{property:"Name",value:rec.get("Name")},{property:"ReleaseStartDate",value:rec.get("ReleaseStartDate")},{property:"ReleaseDate",value:rec.get("ReleaseDate")}],limit:1/0}).load({callback:function(records,operation,success){success?deferred.resolve(records):deferred.reject("Error loading Releases: "+operation.error.errors.join(","))}}),deferred},fetchAllowedValues:function(model,field_name){var deferred=Ext.create("Deft.Deferred");return Rally.data.ModelFactory.getModel({type:model,success:function(model){model.getField(field_name).getAllowedValueStore().load({callback:function(records,operation,success){var values=Ext.Array.map(records,function(record){return record.get("StringValue")});deferred.resolve(values)}})},failure:function(msg){deferred.reject("Error loading field values: "+msg)}}),deferred},fetchPortfolioItemTypes:function(){var deferred=Ext.create("Deft.Deferred"),store=Ext.create("Rally.data.wsapi.Store",{model:"TypeDefinition",fetch:["TypePath","Ordinal"],filters:[{property:"TypePath",operator:"contains",value:"PortfolioItem/"}],sorters:[{property:"Ordinal",direction:"ASC"}]});return store.load({callback:function(records,operation,success){if(success){var portfolioItemTypes=Array(records.length);_.each(records,function(d){var idx=Number(d.get("Ordinal"));portfolioItemTypes[idx]=d.get("TypePath")}),deferred.resolve(portfolioItemTypes)}else{var error_msg="";operation&&operation.error&&operation.error.errors&&(error_msg=operation.error.errors.join(",")),deferred.reject("Error loading Portfolio Item Types:  "+error_msg)}}}),deferred.promise},fetchDoneStates:function(){var deferred=Ext.create("Deft.Deferred");return Rally.data.ModelFactory.getModel({type:"HierarchicalRequirement",success:function(model){var field=model.getField("ScheduleState");field.getAllowedValueStore().load({callback:function(records,operation,success){if(success){for(var values=[],i=records.length-1;i>0;i--)values.push(records[i].get("StringValue")),"Accepted"==records[i].get("StringValue")&&(i=0);deferred.resolve(values)}else deferred.reject("Error loading ScheduleState values for User Story:  "+operation.error.errors.join(","))},scope:this})},failure:function(){var error="Could not load schedule states";deferred.reject(error)}}),deferred.promise}});
                Ext.define("PortfolioItemCostTracking.CostPerProjectSettings",{extend:"Ext.form.field.Base",alias:"widget.costperprojectsettings",config:{value:void 0,decodedValue:{}},fieldSubTpl:'<div id="{id}" class="settings-grid"></div>',width:"100%",cls:"column-settings",store:void 0,onDestroy:function(){this._grid&&(this._grid.destroy(),delete this._grid),this.callParent(arguments)},initComponent:function(){this.callParent(),this.addEvents("ready");var store=Ext.create("Rally.data.wsapi.Store",{model:"Project",fetch:["Name"],context:{project:null},limit:"Infinity"});store.load({scope:this,callback:this._buildProjectGrid})},_buildProjectGrid:function(records,operation,success){var decodedValue={};this.value&&!_.isEmpty(this.value)&&(decodedValue=Ext.isObject(this.value)?this.value:Ext.JSON.decode(this.value),console.log("decodedValue",decodedValue));var data=[],empty_text="No exceptions";success?_.each(records,function(project){var cost=decodedValue[project.get("_ref")]||null;cost&&data.push({projectRef:project.get("_ref"),projectName:project.get("Name"),cost:cost})}):empty_text="Error(s) fetching Project data: <br/>"+operation.error.errors.join("<br/>");var custom_store=Ext.create("Ext.data.Store",{fields:["projectRef","projectName","cost"],data:data});this._grid=Ext.create("Rally.ui.grid.Grid",{autoWidth:!0,renderTo:this.inputEl,columnCfgs:this._getColumnCfgs(),showPagingToolbar:!1,store:custom_store,maxHeight:300,margin:"20 0 0 0",emptyText:empty_text,editingConfig:{publishMessages:!1}});var width=Math.max(this.inputEl.getWidth(!0),300);Ext.create("Rally.ui.Button",{text:"Select Projects",renderTo:this.inputEl,margin:"10 0 0 0",listeners:{scope:this,click:function(){Ext.create("ProjectPickerDialog",{autoShow:!0,maxHeight:400,maxWidth:400,width:Math.min(width,400),title:"Choose Project",selectedRefs:_.pluck(data,"projectRef"),listeners:{scope:this,itemschosen:function(items){var new_data=[],store=this._grid.getStore();_.each(items,function(item){store.findRecord("projectRef",item.get("_ref"))||new_data.push({projectRef:item.get("_ref"),projectName:item.get("Name"),cost:null})}),this._grid.getStore().add(new_data)}}})}}}),this.fireEvent("ready",!0)},_removeProject:function(){this.grid.getStore().remove(this.record)},_getColumnCfgs:function(){var me=this,columns=[{xtype:"rallyrowactioncolumn",scope:this,rowActionsFn:function(record){return[{text:"Remove",record:record,handler:me._removeProject,grid:me._grid}]},_renderGearIcon:function(value,metaData,record){return'<div class="row-action-icon icon-gear"/>'}},{text:"Project",dataIndex:"projectRef",flex:1,editor:!1,renderer:function(v,m,r){return r.get("projectName")},getSortParam:function(v,m,r){return"projectName"}},{text:"Cost Per Unit",dataIndex:"cost",editor:{xtype:"rallynumberfield"},renderer:function(v){return v&&v>0?v:"Use Default"}}];return columns},getSubmitData:function(){var data={};return data[this.name]=Ext.JSON.encode(this._buildSettingValue()),data},_buildSettingValue:function(){var mappings={},store=this._grid.getStore();return store.each(function(record){record.get("cost")&&record.get("projectRef")&&(mappings[record.get("projectRef")]=record.get("cost"))},this),mappings},getErrors:function(){var errors=[];return errors},setValue:function(value){this.callParent(arguments),this._value=value}});
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("PortfolioItemCostTracking.RollupData",{extend:"Ext.Base",mixins:{observable:"Ext.util.Observable"},data:void 0,additionalFetch:void 0,constructor:function(config){this.mixins.observable.constructor.call(this,config),this.additionalFetch=config&&config.fetch||[]},clearRollupData:function(key){key&&this.data?this.data[key]=null:this.data={}},getRollupItem:function(key){return this.data||(this.data={}),this.data[key]||null},addRollupItem:function(record){this.data||(this.data={});var key=record.get("ObjectID");return this.data[key]=new PortfolioItemCostTracking.RollupDataItem({record:record}),this.data[key]},setRollupData:function(record){var rollup_data=this.getRollupItem(record.get("ObjectID"));return console.log("setRollupData",record.get("FormattedID"),rollup_data),rollup_data?(this._setDataOnModel(record,rollup_data),this.fireEvent("dataUpdated",rollup_data),void 0):(this._buildRollupData(record).then({scope:this,success:function(data){this.fireEvent("dataUpdated",data)},failure:function(msg){this.fireEvent("error",msg)}}),void 0)},getExportableRollupData:function(rootObjectIDs,columns){var exportData=[];return _.each(rootObjectIDs,function(oid){var obj=this.getRollupItem(oid);if(obj){var rec=this._getExportDataRow(obj,columns);exportData.push(rec),this._addExportChildren(obj,exportData,columns)}},this),exportData},_addExportChildren:function(obj,exportData,columns){var children=obj.children;children&&children.length>0&&_.each(children,function(c){var row=this._getExportDataRow(this.getRollupItem(c),columns);exportData.push(row),this._addExportChildren(this.getRollupItem(c),exportData,columns)},this)},_getExportDataRow:function(obj,columns){var rec={},type=obj.getData("type");return rec[type]=obj.getData("FormattedID"),_.each(columns,function(c){var field=c.dataIndex||c.costField||null;field&&(rec[field]=obj.getData(field))}),rec},_buildRollupData:function(record){console.log("_buildRollupData");var deferred=Ext.create("Deft.Deferred"),key=record.get("ObjectID"),item=this.addRollupItem(record);if(console.log("item",item,record.get("_type"),record.get("UserStories")),PortfolioItemCostTracking.Utilities.isPortfolioItem(record.get("_type"))){if(record.get("UserStories"))console.log("_fetchTopLevelUserStories"),this._fetchTopLevelUserStories([key]).then({scope:this,success:function(){this._setDataOnModel(record,item),deferred.resolve(item)},failure:function(operation){deferred.reject(operation)}});else if(record.get("Children")&&record.get("Children").Count>0){var child_model_type=this._getChildPortfolioModelType(record.get("_type"));console.log("_fetchChildPortfolioItems"),this._fetchChildPortfolioItems(child_model_type,[key]).then({scope:this,success:function(){this._calculatePortfolioItemRollupData(key),this._setDataOnModel(record,item),deferred.resolve(item)},failure:function(operation){deferred.reject(operation)}})}}else this._setDataOnModel(record,item),deferred.resolve(this.getRollupItem(key));return deferred},_getDataObj:function(record){return new PortfolioItemCostTracking.RollupDataItem({record:record})},_calculatePortfolioItemRollupData:function(key){var data=this.getRollupItem(key);data&&PortfolioItemCostTracking.Utilities.isPortfolioItem(data.type)&&data.type.toLowerCase()!==PortfolioItemCostTracking.Settings.portfolioItemTypes[0].toLowerCase()&&_.each(data.children,function(childKey){this._calculatePortfolioItemRollupData(childKey),data.addChildRollupData(this.getRollupItem(childKey))},this)},_setDataOnModel:function(record,data){record.set("_rollupDataPreliminaryBudget",data._rollupDataPreliminaryBudget),record.set("_rollupDataTotalCost",data._rollupDataTotalCost),record.set("_rollupDataActualCost",data._rollupDataActualCost),record.set("_rollupDataRemainingCost",data._rollupDataRemainingCost),record.set("_rollupDataToolTip",data.getTooltip()||null)},_getChildPortfolioModelType:function(portfolioItemType){var found=Ext.Array.filter(PortfolioItemCostTracking.Settings.portfolioItemTypes,function(item){return item.toLowerCase()===portfolioItemType.toLowerCase()});if(found&&found.length>0){var idx=_.indexOf(PortfolioItemCostTracking.Settings.portfolioItemTypes,found[0]);if(idx>0)return PortfolioItemCostTracking.Settings.portfolioItemTypes[idx-1].toLowerCase()}return null},_fetchChildPortfolioItems:function(portfolioItemType,portfolioItemObjectIDs){var portfolioItemFetch=PortfolioItemCostTracking.Settings.getPortfolioItemFetch(this.additionalFetch);console.log("portfolioItemFetch",portfolioItemFetch,this.additionalFetch);var filters=_.map(portfolioItemObjectIDs,function(poid){return{property:"Parent.ObjectID",value:poid}});return filters=Rally.data.wsapi.Filter.or(filters),PortfolioItemCostTracking.WsapiToolbox.fetchWsapiRecords(portfolioItemType,filters,portfolioItemFetch,{project:null}).then({scope:this,success:function(records){var child_model_type=this._getChildPortfolioModelType(portfolioItemType);_.each(records,function(r){if(r.get("Parent")&&r.get("Parent").ObjectID){var parent=r.get("Parent").ObjectID;this.getRollupItem(parent).addChild(r)}this.addRollupItem(r)},this);var obj_ids=_.map(records,function(r){return r.get("ObjectID")});return records.length>0&&child_model_type?this._fetchChildPortfolioItems(child_model_type,obj_ids):this._fetchTopLevelUserStories(obj_ids)}})},_fetchTopLevelUserStories:function(portfolioItemObjectIDs){var deferred=Ext.create("Deft.Deferred");0===portfolioItemObjectIDs.length&&deferred.resolve();var filters=_.map(portfolioItemObjectIDs,function(pi_oid){return{property:"PortfolioItem.ObjectID",value:pi_oid}});filters=Rally.data.wsapi.Filter.or(filters);var storyFetch=PortfolioItemCostTracking.Settings.getStoryFetch(this.additionalFetch);return console.log("storyFetch",storyFetch,this.additionalFetch),PortfolioItemCostTracking.WsapiToolbox.fetchWsapiRecords("HierarchicalRequirement",filters,storyFetch,{project:null}).then({scope:this,success:function(records){_.each(records,function(r){if(r.get("PortfolioItem")&&r.get("PortfolioItem").ObjectID){var obj_id=r.get("PortfolioItem").ObjectID;this.getRollupItem(obj_id).addChild(r),this.addRollupItem(r)}},this),deferred.resolve()},failure:function(operation){deferred.reject(operation)}}),deferred}})})();
                Ext.define("PortfolioItemCostTracking.RollupDataItem",{children:void 0,type:void 0,totalUnits:null,actualUnits:null,_rollupDataPreliminaryBudget:null,_rollupDataTotalCost:0,_rollupDataActualCost:0,_rollupDataRemainingCost:0,tooltip:void 0,projectCosts:void 0,data:void 0,constructor:function(config){this.data=config.record.getData(),this.type=config.record.get("_type"),this._updateProjectNameAndCostHash(this.data.Project),this._rollupDataPreliminaryBudget=this.calculatePreliminaryBudget(this.data),("hierarchicalrequirement"===this.type.toLowerCase()||"task"===this.type.toLowerCase())&&(this.actualUnits=this.getActualUnits(this.data,this.type.toLowerCase()),this.totalUnits=this.getTotalUnits(this.data,this.type.toLowerCase()),this._rollupDataActualCost=this.calculateCost(this.data,this.actualUnits),this._rollupDataTotalCost=this.calculateCost(this.data,this.totalUnits),console.log("story",this._rollupDataActualCost,this._rollupDataTotalCost),this._rollupDataRemainingCost=null===this._rollupDataActualCost||null===this._rollupDataTotalCost?null:this._rollupDataTotalCost-this._rollupDataActualCost),PortfolioItemCostTracking.Utilities.isPortfolioItem(this.type)&&(this.totalUnits=0,this._rollupDataTotalCost=0,this.actualUnits=0,this._rollupDataActualCost=0,this._rollupDataRemainingCost=0)},getData:function(field){return this[field]||0===this[field]?this[field]:this.data[field]||0===this.data[field]?this.data[field]:null},addChild:function(record){var childType=record.get("_type"),childData=record.getData();if("hierarchicalrequirement"===record.get("_type").toLowerCase()){this._updateProjectNameAndCostHash(childData.Project);var total_units=this.getTotalUnits(childData,childType)||0,actual_units=this.getActualUnits(childData,childType)||0;this.totalUnits=(this.totalUnits||0)+total_units,this.actualUnits=(this.actualUnits||0)+actual_units,this._rollupDataTotalCost=(this._rollupDataTotalCost||0)+(this.calculateCost(childData,total_units)||0),this._rollupDataActualCost=(this._rollupDataActualCost||0)+(this.calculateCost(childData,actual_units)||0),this._rollupDataRemainingCost=this._rollupDataTotalCost-this._rollupDataActualCost,console.log("addchild",this._rollupDataRemainingCost)}this.children||(this.children=[]),this.children.push(childData.ObjectID)},addChildRollupData:function(childData){console.log("addChildRollupData",childData),this.totalUnits=(this.totalUnits||0)+childData.totalUnits,this._rollupDataTotalCost=(this._rollupDataTotalCost||0)+childData._rollupDataTotalCost,this.actualUnits=(this.actualUnits||0)+childData.actualUnits,this._rollupDataActualCost=(this._rollupDataActualCost||0)+childData._rollupDataActualCost,this._rollupDataRemainingCost=(this._rollupDataRemainingCost||0)+childData._rollupDataRemainingCost,this.projectCosts=Ext.merge(this.projectCosts||{},childData.projectCosts||{})},getTooltip:function(){var completed=PortfolioItemCostTracking.Settings.notAvailableText;null!==this.actualUnits&&null!==this.totalUnits&&(completed=Ext.String.format("{0}/{1}",this.actualUnits,this.totalUnits));var calc_type_name=PortfolioItemCostTracking.Settings.getCalculationTypeDisplayName(),html=Ext.String.format("{0} completed {1}<br/><br/>Cost per unit:<br/>",calc_type_name,completed);return _.each(this.projectCosts,function(project_cost,project_name){html+=Ext.String.format("{0} {1}<br/>",PortfolioItemCostTracking.Settings.formatCost(project_cost),project_name)}),html},_updateProjectNameAndCostHash:function(project){this.projectCosts=this.projectCosts||{};var name=project._refObjectName,cost=PortfolioItemCostTracking.Settings.getCostPerUnit(project._ref);PortfolioItemCostTracking.Settings.isProjectUsingNormalizedCost(project._ref)&&(name="normalized (default)"),this.projectCosts[name]=cost},calculateCost:function(data,units){return null===units?null:units*PortfolioItemCostTracking.Settings.getCostPerUnit(data.Project._ref)},getActualUnits:function(data,modelType){var calcType=PortfolioItemCostTracking.Settings.getCalculationTypeSettings(),fn="actualUnitsForStoryFn";return"task"===modelType.toLowerCase()&&(fn="actualUnitsForTaskFn"),calcType[fn]?calcType[fn](data):null},getTotalUnits:function(data,modelType){var calcType=PortfolioItemCostTracking.Settings.getCalculationTypeSettings(),fn="totalUnitsForStoryFn";return"task"===modelType.toLowerCase()&&(fn="totalUnitsForTaskFn"),calcType[fn]?calcType[fn](data):null},calculatePreliminaryBudget:function(data){if(data&&data.PreliminaryEstimate&&data.PreliminaryEstimate.Value){var cpu=PortfolioItemCostTracking.Settings.getCostPerUnit(data.Project._ref);return cpu*data.PreliminaryEstimate.Value}return null}});
                Ext.define("ProjectPickerDialog",{extend:"Rally.ui.dialog.Dialog",alias:"widget.projectpickerdialog",height:400,width:400,layout:"fit",closable:!0,draggable:!0,config:{title:"Choose an Item",multiple:!0,storeConfig:{context:{project:null},sorters:[{property:"FormattedID",direction:"DESC"}]},columns:[{text:"ID",dataIndex:"ObjectID",renderer:_.identity},"Name"],selectionButtonText:"Done",gridConfig:{},selectedRef:void 0,selectedRecords:void 0,initialSelectedRecords:void 0,showRadioButtons:!0},constructor:function(config){this.mergeConfig(config),this.callParent([this.config])},selectionCache:[],initComponent:function(){this.callParent(arguments),this.addEvents("itemschosen"),this.addCls(["chooserDialog","chooser-dialog"])},destroy:function(){this.callParent(arguments)},beforeRender:function(){this.callParent(arguments),this.addDocked({xtype:"toolbar",dock:"bottom",padding:"0 0 10 0",layout:{type:"hbox",pack:"center"},ui:"footer",items:[{xtype:"rallybutton",itemId:"doneButton",text:this.selectionButtonText,cls:"primary rly-small",scope:this,disabled:!0,userAction:"clicked done in dialog",handler:function(){this.fireEvent("itemschosen",this.getSelectedRecords()),this.close()}},{xtype:"rallybutton",text:"Cancel",cls:"secondary rly-small",handler:this.close,scope:this,ui:"link"}]}),this.introText&&this.addDocked({xtype:"component",componentCls:"intro-panel",html:this.introText}),this.addDocked({xtype:"toolbar",itemId:"searchBar",dock:"top",border:!1,padding:"0 0 10px 0",items:this.getSearchBarItems()}),this.buildGrid(),this.selectionCache=this.getInitialSelectedRecords()||[]},getSelectedRecords:function(){return this.multiple?this.selectionCache:this.selectionCache[0]},getSearchBarItems:function(){return[{xtype:"triggerfield",cls:"rui-triggerfield chooser-search-terms",emptyText:"Search Keyword or ID",enableKeyEvents:!0,flex:1,itemId:"searchTerms",listeners:{keyup:function(textField,event){event.getKey()===Ext.EventObject.ENTER&&this._search()},afterrender:function(field){field.focus()},scope:this},triggerBaseCls:"icon-search chooser-search-icon"}]},getStoreFilters:function(){return[]},buildGrid:function(){this.grid&&this.grid.destroy(),Ext.create("Rally.data.wsapi.ProjectTreeStoreBuilder").build({models:["project"],autoLoad:!0,enableHierarchy:!0,filters:[{property:"Parent",value:""}]}).then({scope:this,success:function(store){var mode=this.multiple?"MULTI":"SINGLE",checkbox_model=Ext.create("Rally.ui.selection.CheckboxModel",{mode:mode,enableKeyNav:!1,allowDeselect:!0});this.grid=this.add({xtype:"rallytreegrid",treeColumnDataIndex:"Name",treeColumnHeader:"Name",viewConfig:{cls:"grid-view-bulk-edit"},enableRanking:!1,enableEditing:!1,enableBulkEdit:!1,shouldShowRowActionsColumn:!1,selModel:checkbox_model,_defaultTreeColumnRenderer:function(value,metaData,record,rowIdx,colIdx,store){return store=store.treeStore||store,Rally.ui.renderer.RendererFactory.getRenderTemplate(store.model.getField("Name")).apply(record.data)},columnCfgs:[],store:store}),this.mon(this.grid,{beforeselect:this._onGridSelect,beforedeselect:this._onGridDeselect,load:this._onGridLoad,scope:this}),this.add(this.grid),this._onGridReady()}})},_enableDoneButton:function(){this.down("#doneButton").setDisabled(this.selectionCache.length?!1:!0)},_findRecordInSelectionCache:function(record){return _.findIndex(this.selectionCache,function(cachedRecord){return cachedRecord.get("_ref")===record.get("_ref")})},_onGridSelect:function(selectionModel,record){var index=this._findRecordInSelectionCache(record);console.log("selectionModel",selectionModel,record),-1===index&&(this.multiple||(this.selectionCache=[]),this.selectionCache.push(record)),this._enableDoneButton()},_onGridDeselect:function(selectionModel,record){var index=this._findRecordInSelectionCache(record);-1!==index&&this.selectionCache.splice(index,1),this._enableDoneButton()},_onGridReady:function(){return this.grid.rendered?this.grid.getStore().isLoading()?(this.mon(this.grid,"load",this._onGridReady,this,{single:!0}),void 0):(this._onGridLoad(),this.center(),void 0):(this.mon(this.grid,"afterrender",this._onGridReady,this,{single:!0}),void 0)},_onGridLoad:function(){var store=this.grid.store,records=[];_.each(this.selectionCache,function(record){var foundNode=store.getRootNode().findChild("_ref",record.get("_ref"),!0);foundNode&&records.push(foundNode)}),records.length&&this.grid.getSelectionModel().select(records)},_search:function(){var terms=this._getSearchTerms(),store=this.grid.getStore();terms?store.filter([Ext.create("Rally.data.wsapi.Filter",{property:"Name",operator:"contains",value:terms})]):store.clearFilter()},_getSearchTerms:function(){var textBox=this.down("#searchTerms");return textBox&&textBox.getValue()}}),Ext.override(Rally.data.wsapi.ParentChildMapper,{constructor:function(){this.parentChildTypeMap={project:[{typePath:"project",collectionName:"Children",parentField:"Parent"}],hierarchicalrequirement:[{typePath:"defect",collectionName:"Defects",parentField:"Requirement"},{typePath:"task",collectionName:"Tasks",parentField:"WorkProduct"},{typePath:"testcase",collectionName:"TestCases",parentField:"WorkProduct"},{typePath:"hierarchicalrequirement",collectionName:"Children",parentField:"Parent"}],defect:[{typePath:"task",collectionName:"Tasks",parentField:"WorkProduct"},{typePath:"testcase",collectionName:"TestCases",parentField:"WorkProduct"}],defectsuite:[{typePath:"defect",collectionName:"Defects",parentField:"DefectSuites"},{typePath:"task",collectionName:"Tasks",parentField:"WorkProduct"},{typePath:"testcase",collectionName:"TestCases",parentField:"WorkProduct"}],testset:[{typePath:"task",collectionName:"Tasks",parentField:"WorkProduct"},{typePath:"testcase",collectionName:"TestCases",parentField:"TestSets"}]}}}),Ext.define("Rally.data.wsapi.ProjectTreeStore",{requires:["Deft.promise.Deferred","Rally.data.ModelFactory","Rally.ui.grid.data.NodeInterface","Rally.data.ModelTypes","Rally.data.wsapi.ParentChildMapper"],extend:"Rally.data.wsapi.TreeStore",alias:"store.rallyprojectwsapitreestore",parentTypes:["project"],childLevelSorters:[{property:"Name",direction:"ASC"}],getParentFieldNamesByChildType:function(childType,parentType){var model=this.model;return _.transform(this.mapper.getParentFields(childType,parentType),function(acc,field){var typePath=field.typePath,fieldName=field.fieldName,hasFieldModel=model.hasField(fieldName);hasFieldModel&&acc.push(fieldName.replace(/\s+/g,""))},[],this)},filter:function(filters){this.fireEvent("beforefilter",this),this.filters.clear(),this.filters.addAll(filters),this._resetCurrentPage(),this.load()},clearFilter:function(suppressEvent){this._resetCurrentPage(),this.filters.clear(),this.filters.addAll(Ext.create("Rally.data.wsapi.Filter",{property:"Parent",value:""})),suppressEvent||this.load()}}),Ext.define("Rally.data.wsapi.ProjectTreeStoreBuilder",{extend:"Rally.data.wsapi.TreeStoreBuilder",build:function(config){return config=_.clone(config||{}),config.storeType="Rally.data.wsapi.ProjectTreeStore",this.loadModels(config).then({success:function(models){return models=_.values(models),this._buildStoreWithModels(models,config)},scope:this})}});
                Ext.define("Ext.CostTemplate",{extend:"Ext.grid.column.Template",alias:["widget.costtemplatecolumn"],tpl:"",costField:"",initComponent:function(){var me=this;Ext.QuickTips.init(),me.tpl=new Ext.XTemplate('<tpl><div data-qtip="{[this.getTooltip(values)]}" style="cursor:pointer;">{[this.getCost(values)]}</div></tpl>',{costField:me.costField,getCost:function(values){return null===values[this.costField]?PortfolioItemCostTracking.Settings.notAvailableText:PortfolioItemCostTracking.Settings.formatCost(values[this.costField]||0)},getTooltip:function(values){return values._rollupDataToolTip?values._rollupDataToolTip:""}}),me.hasCustomRenderer=!0,me.callParent(arguments)},getValue:function(){return this.values[this.costField]||0},defaultRenderer:function(value,meta,record){var data=Ext.apply({},record.data,record.getAssociatedData());return this.tpl.apply(data)}}),Ext.override(Rally.ui.grid.TreeGrid,{_isStatefulColumn:function(columnName){if(!this.allColumnsStateful){columnName=columnName.toLowerCase();var found=_.filter(this.nonStatefulColumns,function(c){return c.toLowerCase()===columnName});if(found)return!1;if(this.store.enableHierarchy&&columnName===this.treeColumnDataIndex.toLowerCase())return!1;if(this.enableRanking&&columnName===this.rankColumnDataIndex.toLowerCase())return!1}return!0}});
                Ext.define("TreeGridContainerCustomFilterControl",{alias:"plugin.treegridcontainercustomfiltercontrol",extend:"Rally.ui.gridboard.plugin.GridBoardCustomFilterControl",showControl:function(){return this.controlCmp||this._createControlCmp(),this.controlCmp&&this.controlCmp.show(),this.controlCmp}});
                Ext.define("TreeGridContainerFieldPicker",{alias:"plugin.treegridcontainerfieldpicker",extend:"Ext.AbstractPlugin",mixins:["Rally.ui.gridboard.plugin.GridBoardControlShowable"],requires:["Rally.ui.popover.Popover","Rally.ui.Button","Rally.ui.picker.FieldPicker"],gridAlwaysSelectedValues:["FormattedID","Name"],gridFieldBlackList:["Actuals","Changesets","Children","Description","Notes","ObjectID","Predecessors","RevisionHistory","Subscription","Successors","TaskIndex","Workspace","VersionId"],modelNames:[],stateful:!0,margin:"3 9 10 10",constructor:function(config){config.gridFieldBlackList=_.union(this.gridFieldBlackList,config.gridFieldBlackList),config.gridAlwaysSelectedValues=_.union(this.gridAlwaysSelectedValues,config.gridAlwaysSelectedValues),this.callParent(arguments)},init:function(cmp){this.callParent(arguments),this.cmp=cmp;var rankingEnabled=this.cmp.getContext().getWorkspace().WorkspaceConfiguration.DragDropRankingEnabled&&cmp.gridConfig.enableRanking!==!1;this.gridAlwaysSelectedValues=this._modifyFieldCollection(this.gridAlwaysSelectedValues,["DragAndDropRank"],rankingEnabled),this.gridFieldBlackList=this._modifyFieldCollection(this.gridFieldBlackList,["DragAndDropRank"],!rankingEnabled),this.stateId=this.stateId||this.cmp.getContext().getScopedStateId("shownfields");var state=Ext.state.Manager.get(this.stateId);this._fields=state&&state.fields,this.showControl()},showControl:function(){return this.controlCmp||this._createControlCmp(),this.controlCmp&&this.controlCmp.show(),this.controlCmp},_modifyFieldCollection:function(collection,fields,include){return include?_.union(collection,fields):_.reject(collection,function(field){return _.contains(fields,field)})},getControlCmpConfig:function(){return{xtype:"rallybutton",itemId:"fieldpickerbtn",cls:"field-picker-btn secondary rly-small",margin:this.margin,iconCls:"icon-add-column",toolTipConfig:{html:this.getTitle(),anchor:"top"},listeners:{click:this._onClick,scope:this}}},_onClick:function(btn){this._createPopover(btn.getEl())},_getPickerConfig:function(){var pickerConfig;return pickerConfig=_.extend({value:_.pluck(this.cmp.getGrid().columns,"dataIndex").join(","),fieldBlackList:this.gridFieldBlackList,alwaysSelectedValues:this.gridAlwaysSelectedValues},this.fieldPickerConfig)},_createPopover:function(popoverTarget){this.popover=Ext.create("Rally.ui.popover.Popover",{target:popoverTarget,placement:["bottom","left","top","right"],cls:"field-picker-popover",toFront:Ext.emptyFn,buttonAlign:"center",title:this.getTitle(),listeners:{destroy:function(){this.popover=null},scope:this},buttons:[{xtype:"rallybutton",text:"Apply",cls:"field-picker-apply-btn primary rly-small",listeners:{click:function(){this._onApply(this.popover)},scope:this}},{xtype:"rallybutton",text:"Cancel",cls:"field-picker-cancel-btn secondary dark rly-small",listeners:{click:function(){this.popover.close()},scope:this}}],items:[_.extend({xtype:"rallyfieldpicker",cls:"field-picker",itemId:"fieldpicker",modelTypes:this._getModelTypes(),alwaysExpanded:!0,width:200,placeholderText:"Search",selectedTextLabel:"Selected",availableTextLabel:"Available",listeners:{specialkey:function(field,e){e.getKey()===e.ESC&&this.popover.close()},scope:this}},this._getPickerConfig())]})},_getModelTypes:function(){return _.pluck(this._getModels(),"typePath")},_getModels:function(){return _.reduce(this.cmp.getModels(),function(accum,model){return"artifact"===model.typePath?accum=accum.concat(model.getArtifactComponentModels()):accum.push(model),accum},[])},getTitle:function(){return"Show Columns"},updateFields:function(fields,suspendLoad){this._fields=_.map(fields,function(field){return field.get("name")}),this.cmp.updateFields(fields,!1,suspendLoad),this._updatePickerValue(this._fields),this.cmp.fireEvent("viewstatesave",this)},_updatePickerValue:function(fields){this.popover&&this.popover.down("rallyfieldpicker")&&this.popover.down("rallyfieldpicker").setValue(this._fields.join(","))},_onApply:function(popover){var fieldPicker=popover.down("rallyfieldpicker"),fields=_.map(fieldPicker.getValue(),function(field){return field.get("name")});this.updateFields(fieldPicker.getValue()),popover.close()}});
                Ext.define("TreeGridContainer",{extend:"Ext.Container",mixins:["Rally.app.Scopeable"],requires:["Rally.ui.LeftRight","Rally.ui.grid.TreeGrid"],alias:"widget.treegridcontainer",cls:"rui-gridboard",storeConfig:{},gridConfig:{},modelNames:[],layout:{type:"auto"},currentCustomFilter:[],items:[{itemId:"header",xtype:"rallyleftright",padding:"4 10 10 10",overflowX:"hidden"}],initComponent:function(){this.plugins=this.plugins||[],this.stateId=this.getAppContextOrEnvironmentContext().getScopedStateId(this.stateId),this.callParent(arguments),this.addEvents(["load","recordcreate","recordupdate","preferencesaved","modeltypeschange","updatefields"]),this.on("modeltypeschange",function(gridboard,types){this.modelNames=types},this)},afterRender:function(){this.callParent(arguments),this._addGrid()},destroy:function(){var grid=this.getGrid();grid&&grid.store&&_.isFunction(grid.store.clearData)&&grid.store.clearData(),this.callParent(arguments)},getGrid:function(){return this.down("rallytreegrid")},getHeader:function(){return this.down("#header")},getModelNames:function(){return this.modelNames},getModels:function(){return this.getGrid().getModels()},applyCustomFilter:function(filterObj){var grid=this.getGrid();this.currentCustomFilter=filterObj,grid&&this._applyGridFilters(grid,filterObj)},getFilter:function(){return this.currentFilter},setHeight:function(){this.callParent(arguments);var grid=this.getGrid();grid&&grid.rendered&&grid.getHeight()!==this.getAvailableGridBoardHeight()&&this.grid().setHeight(this.getAvailableGridBoardHeight())},getAvailableGridBoardHeight:function(){return this.getHeight()-this.down("#header").getHeight()-10},_mergeColumnConfigs:function(newColumns,oldColumns){var columns=_.map(newColumns,function(newColumn){var oldColumn=_.find(oldColumns,{dataIndex:this._getDataIndex(newColumn)});return oldColumn?this._getColumnConfigFromColumn(oldColumn):newColumn},this);return _.each(oldColumns,function(c){c.costField&&columns.push(c)}),columns},updateFields:function(fields){var grid=this.getGrid(),new_fields=Ext.Array.filter(fields,function(f){var columnName=f.get("name").toLowerCase();return grid.store.enableHierarchy&&columnName===grid.treeColumnDataIndex.toLowerCase()?!1:grid.enableRanking&&columnName===grid.rankColumnDataIndex.toLowerCase()?!1:!0});this.fireEvent("updatefields",new_fields)},updateStore:function(store){this.gridConfig.store=store,this._addGrid()},_getGridConfig:function(){var context=this.getContext()||Rally.environment.getContext(),columnCfgs=Ext.Array.merge(this.gridConfig.columnCfgs||[],this.gridConfig.customColumns||[]),config=Ext.merge({xtype:"rallytreegrid",context:context,enableRanking:context.getWorkspace().WorkspaceConfiguration.DragDropRankingEnabled,defaultSortToRank:!0,enableBlockedReasonPopover:!0,height:this.getAvailableGridBoardHeight()},this.gridConfig);return config.columnCfgs=columnCfgs,_.isEmpty(config.store)&&Ext.Error.raise("No grid store configured"),config},_getConfiguredFilters:function(extraFilters,types){var filters=_.compact(Ext.Array.merge(this.getGrid().store.filters,this.storeConfig&&this.storeConfig.filters,this.gridConfig&&this.gridConfig.storeConfig&&this.gridConfig.storeConfig.filters,extraFilters));return console.log("_getConfiguredFilters",""+filters,_.isFunction(this.getModels()[0].getArtifactComponentModel)),console.log("_getConfiguredFilters",filters.toString),filters},_addGrid:function(){this.getGrid()&&this.getGrid().destroy();var grid=this.add(this._getGridConfig());return this.mon(grid,"afterproxyload",this._onGridLoad,this),this.currentCustomFilter&&this._applyGridFilters(grid,this.currentCustomFilter),grid},_applyGridFilters:function(grid,filterObj){_.isEmpty(filterObj.types)||(grid.store.parentTypes=filterObj.types),grid.store.clearFilter(!0),console.log("applied filters",this._getConfiguredFilters(filterObj.filters||[],filterObj.types||[])),grid.store.filter(this._getConfiguredFilters(filterObj.filters||[],filterObj.types||[]))},_onGridLoad:function(){this.fireEvent("load",this),Rally.BrowserTest&&Rally.BrowserTest.publishComponentReady(this)}});
                Ext.define("PortfolioItemCostTracking.Utilities",{singleton:!0,isPortfolioItem:function(type){var portfolioItemRegExp=RegExp("^portfolioitem/","i");return portfolioItemRegExp.test(type)},fetchExportData:function(rootModel,rootFilters,fetch,columns){var deferred=Ext.create("Deft.Deferred"),recordCounter=0,rootFetch=Ext.Array.merge(fetch,PortfolioItemCostTracking.Settings.getPortfolioItemFetch());return PortfolioItemCostTracking.WsapiToolbox.fetchWsapiRecords(rootModel,rootFilters||[],rootFetch).then({scope:this,success:function(records){console.log("fetchExportData success",records);var recordTotal=records.length,oids=_.map(records,function(r){return r.get("ObjectID")}),rollupData=Ext.create("PortfolioItemCostTracking.RollupData",{fetch:fetch,listeners:{scope:this,dataUpdated:function(data){if(console.log("dataUpdated",data,recordCounter,recordTotal),recordCounter++,recordCounter==recordTotal){var exportData=rollupData.getExportableRollupData(oids,columns),csv=exportData;deferred.resolve(csv)}},error:function(msg){console.log("error",msg)}}});_.each(records,function(r){rollupData.setRollupData(r)},this)},failure:function(msg){deferred.reject(msg)}}),deferred}});

            Rally.launchApp('PortfolioItemCostTracking', {
                name:"portfolio-item-cost-tracking",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .lbl{text-transform:uppercase;font-family:ProximaNovaSemiBold, Helvetica, Arial;font-size:10px}.x-form-trigger-wrap{margin-top:0px!important}.x-column-header-text{margin-right:0px!important}
    </style>
</head>
<body>
</body>
</html>
