<!DOCTYPE html>
<html>
<head>
    <title>portfolio-item-cost-tracking</title>

    <script type="text/javascript" src="/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("PortfolioItemCostTracking",{extend:"Rally.app.App",componentCls:"app",defaults:{startDate:new Date("2015-06-01"),endDate:new Date("2016-05-31"),groupByRelease:!1},config:{defaultSettings:{calculationType:"points",normalizedCostPerUnit:1e3,projectCostPerUnit:{},currencySign:"$"}},items:[],portfolioItemRollupData:{},launch:function(){var state=Ext.state.Manager.get(this.getContext().getScopedStateId("cb-type")),state_val=state?state.value:null;Deft.Promise.all([PortfolioItemCostTracking.WsapiToolbox.fetchPortfolioItemTypes(),PortfolioItemCostTracking.WsapiToolbox.fetchDoneStates(),PortfolioItemCostTracking.WsapiToolbox.fetchModelTypePathByTypeDefinition(state_val)]).then({scope:this,success:function(results){this.portfolioItemTypes=results[0],this._initializeSettings(this.getSettings(),results[1]),this._createPickers()},failure:function(msg){Rally.ui.notify.Notifier.showError({message:msg})}})},_createPickers:function(){this.fixedHeader=Ext.create("Ext.container.Container",{itemId:"header-controls",width:460,height:50,layout:"hbox",padding:"0 0 20 20",margin:10,items:[{xtype:"rallydatefield",itemId:"dt-start",margin:"0 10 0 0",value:this.defaults.startDate,padding:5,fieldLabel:"Start Date",labelSeparator:"",labelCls:"lbl",labelAlign:"top",listeners:{scope:this,change:this.updateStoreFilters}},{xtype:"rallydatefield",itemId:"dt-end",margin:"0 10 0 0",labelSeparator:"",labelCls:"lbl",value:this.defaults.endDate,fieldLabel:"End Date",labelAlign:"top",listeners:{scope:this,change:this.updateStoreFilters}},{xtype:"rallyportfolioitemtypecombobox",itemId:"cb-type",margin:"0 10 0 0",fieldLabel:"Portfolio Item Type",labelAlign:"top",labelCls:"lbl",listeners:{scope:this,ready:function(picker){console.log("ready")}}}]}),this.fixedHeader.down("#cb-type").on("change",this._onTypeChange,this)},_onTypeChange:function(piPicker){var piType=piPicker.getRecord().get("TypePath");this.modelNames=[piType],this._initializeGrid(this.modelNames)},_initializeSettings:function(settings,doneScheduleStates){PortfolioItemCostTracking.CostCalculator.notAvailableText="--",PortfolioItemCostTracking.CostCalculator.currencySign=settings.currencySign,PortfolioItemCostTracking.CostCalculator.currencyPrecision=0,PortfolioItemCostTracking.CostCalculator.currencyEnd=!1,doneScheduleStates&&(PortfolioItemCostTracking.CostCalculator.completedScheduleStates=doneScheduleStates),PortfolioItemCostTracking.CostCalculator.normalizedCostPerUnit=settings.normalizedCostPerUnit;var project_cpu=settings.projectCostPerUnit||{};Ext.isObject(project_cpu)||(project_cpu=Ext.JSON.decode(project_cpu)),PortfolioItemCostTracking.CostCalculator.projectCostPerUnit=project_cpu,PortfolioItemCostTracking.CostCalculator.calculationType=settings.calculationType||"points"},_initializeGrid:function(modelNames){var me=this;if(this.rollupData&&this.rollupData.clearRollupData(),this.down("treegridcontainer")){if(this.fixedHeader&&this.fixedHeader.rendered){var parent=this.fixedHeader.up();parent&&parent.remove&&parent.remove(this.fixedHeader,!1)}this.down("treegridcontainer").destroy()}var filters=this._getDateFilters();console.log("filters",""+filters),Ext.create("Rally.data.wsapi.TreeStoreBuilder").build({models:modelNames,filters:filters,fetch:["FormattedID","Name","Project","PreliminaryEstimate","PlanEstimate","PercentDoneByStoryPlanEstimate","AcceptedLeafStoryPlanEstimateTotal","LeafStoryPlanEstimateTotal","Children","ToDo","Actuals"],enableHierarchy:!0,listeners:{scope:this,load:this._setRollupData}}).then({scope:this,success:function(store){store.model.addField({name:"_rollupDataPreliminaryBudget",type:"auto",defaultValue:null,displayName:"Preliminary Budget"}),store.model.addField({name:"_rollupDataTotalCost",type:"auto",defaultValue:null,displayName:"Total Cost"}),store.model.addField({name:"_rollupDataRemainingCost",type:"auto",defaultValue:null,displayName:"Remaining Cost"}),store.model.addField({name:"_rollupDataActualCost",type:"auto",defaultValue:null,displayName:"Actual Cost"}),store.model.addField({name:"_rollupDataToolTip",type:"string",defaultValue:null}),this._updateDisplay(store,modelNames)}})},getStartDate:function(){return this.getDate("dt-start",this.defaults.startDate)},getEndDate:function(){return this.getDate("dt-end",this.defaults.endDate)},getDate:function(itemId,defaultDate){var dt=defaultDate,cmpId="#"+itemId;if(this.down(cmpId))dt=this.down(cmpId).getValue();else{var state=Ext.state.Manager.get(this.getContext().getScopedStateId(itemId));state&&state.value&&(dt=new Date(state.value))}return dt},addHeader:function(gb){var header=gb.getHeader();header&&header.getLeft().add(this.fixedHeader)},_showExportMenu:function(button){console.log("export")},_getDateFilters:function(){var start_date=this.getStartDate(),end_date=this.getEndDate(),filter_actual=[{property:"ActualEndDate",operator:">=",value:Rally.util.DateTime.toIsoString(start_date)},{property:"ActualEndDate",operator:"<",value:Rally.util.DateTime.toIsoString(end_date)}];filter_actual=Rally.data.wsapi.Filter.and(filter_actual);var filter_planned=[{property:"ActualEndDate",value:null},{property:"PlannedEndDate",operator:"<",value:Rally.util.DateTime.toIsoString(end_date)},{property:"PlannedEndDate",operator:">=",value:Rally.util.DateTime.toIsoString(start_date)}];return filter_planned=Rally.data.wsapi.Filter.and(filter_planned),filter_actual.or(filter_planned)},updateStoreFilters:function(){this.down("treegridcontainer")&&(this.down("treegridcontainer").storeConfig.filters=this._getDateFilters(),this.down("treegridcontainer").applyCustomFilter(this.down("treegridcontainer").currentCustomFilter))},_setRollupData:function(store,node,records,success){var rollup_data=this.rollupData;console.log("_setrollupData",store,node,records.length,success),rollup_data||(this.rollupData=Ext.create("PortfolioItemCostTracking.RollupData",{portfolioItemTypes:this.portfolioItemTypes}),rollup_data=this.rollupData),_.each(records,function(r){rollup_data.setRollupData(r),r.set("cls","treeItem")},this)},_updateDisplay:function(store,modelNames){var me=this;this.add({xtype:"treegridcontainer",context:this.getContext(),gridConfig:{columnCfgs:this._getColumnCfgs(),customColumns:this._getCustomColumns(),store:store},plugins:[{ptype:"treegridcontainercustomfiltercontrol",filterControlConfig:{modelNames:modelNames,margin:"15px 10px 0px 0px"},showOwnerFilter:!0,ownerFilterControlConfig:{margin:"15px 10px 0px 0px"}},{ptype:"treegridcontainerfieldpicker",headerPosition:"left",modelNames:modelNames,alwaysSelectedFields:["_rollupDataPreliminaryBudget","_rollupDataTotalCost","_rollupDataRemainingCost","_rollupDataActualCost"],margin:"15px 0px 10px 10px"},{ptype:"rallygridboardactionsmenu",menuItems:[{text:"Export...",handler:me._showExportMenu,scope:me}],buttonConfig:{iconCls:"icon-export",margin:"15px 10px 0px 0px"}}],listeners:{beforerender:function(gb){this.addHeader(gb)},scope:this},height:this.getHeight()})},_getCustomColumns:function(){return[{text:"Preliminary Budget",align:"right",xtype:"costtemplatecolumn",costField:"_rollupDataPreliminaryBudget"},{text:"Total Projected",align:"right",xtype:"costtemplatecolumn",costField:"_rollupDataTotalCost"},{text:"Actual Cost To Date",align:"right",xtype:"costtemplatecolumn",costField:"_rollupDataActualCost"},{text:"Remaining Cost",align:"right",xtype:"costtemplatecolumn",costField:"_rollupDataRemainingCost"}]},_getColumnCfgs:function(){return[{dataIndex:"Name",text:"Name",flex:5},{dataIndex:"Project",text:"Project",editor:!1,isCellEditable:!1},{dataIndex:"PlanEstimate",text:"Plan Estimate"},{dataIndex:"PercentDoneByStoryPlanEstimate",text:"% Done by Story Points"}]},getSettingsFields:function(){return PortfolioItemCostTracking.Settings.getFields()},onSettingsUpdate:function(settings){this._initializeSettings(settings),this._initializeGrid(this.modelNames)}});
                Ext.define("PortfolioItemCostTracking.Settings",{singleton:!0,currencyData:[{name:"US Dollars",value:"$"},{name:"Euro",value:"&#128;"},{name:"Japanese Yen",value:"&#165;"},{name:"Brazilian Real",value:"R$"}],getFields:function(config){var currency_store=Ext.create("Rally.data.custom.Store",{data:this.currencyData}),labelWidth=100;return[{xtype:"rallycombobox",name:"currencySign",store:currency_store,displayField:"name",valueField:"value",fieldLabel:"Currency",labelWidth:labelWidth,margin:"10 0 10 0"},{xtype:"radiogroup",fieldLabel:"Calculate Cost",columns:1,vertical:!0,labelWidth:labelWidth,margin:"10 0 10 0",items:[{boxLabel:"Based on Story Points",name:"calculationType",inputValue:"points",checked:!0},{boxLabel:"Based on Task Actuals",name:"calculationType",inputValue:"taskHours"},{boxLabel:"Using Timesheets",name:"calculationType",inputValue:"timesheets",disabled:!0}]},{xtype:"rallytextfield",name:"normalizedCostPerUnit",fieldLabel:"Normalized Cost Per Unit",labelWidth:labelWidth,width:200,margin:"25 0 0 0"},{xtype:"costperprojectsettings",name:"projectCostPerUnit",fieldLabel:"Optionally define costs per unit for individual teams (exceptions to the normalized cost)",labelAlign:"top",margin:"25 0 0 0",readyEvent:"ready"}]}});
                Ext.define("PortfolioItemCostTracking.WsapiToolbox",{singleton:!0,fetchWsapiCount:function(model,query_filters){var deferred=Ext.create("Deft.Deferred"),store=Ext.create("Rally.data.wsapi.Store",{model:model,fetch:["ObjectID"],filters:query_filters,limit:1,pageSize:1}).load({callback:function(records,operation,success){success?deferred.resolve(operation.resultSet.totalRecords):deferred.reject(Ext.String.format("Error getting {0} count for {1}: {2}",model,""+query_filters,operation.error.errors.join(",")))}});return deferred},fetchModelTypePathByTypeDefinition:function(typeDef){var deferred=Ext.create("Deft.Deferred"),typeDefId=0;typeDef&&(typeDefId=typeDef.replace("/typedefinition/",""));var store=Ext.create("Rally.data.wsapi.Store",{model:"TypeDefinition",fetch:["TypePath","Name"],filters:[{property:"ObjectID",value:typeDefId}]}).load({callback:function(records,operation,success){success&&records&&records.length>0?deferred.resolve(records[0].get("TypePath")):deferred.resolve(null)}});return deferred},fetchWsapiRecords:function(model,query_filters,fetch_fields,context){var deferred=Ext.create("Deft.Deferred"),store=Ext.create("Rally.data.wsapi.Store",{model:model,fetch:fetch_fields,filters:query_filters,context:context,limit:1/0}).load({callback:function(records,operation,success){success?deferred.resolve(records):deferred.reject(Ext.String.format("Error getting {0} for {1}: {2}",model,""+query_filters,operation.error.errors.join(",")))}});return deferred},fetchReleases:function(timebox){var deferred=Ext.create("Deft.Deferred"),rec=timebox.getRecord(),me=this;return null===rec&&deferred.resolve([]),Ext.create("Rally.data.wsapi.Store",{model:"Release",fetch:["ObjectID"],filters:[{property:"Name",value:rec.get("Name")},{property:"ReleaseStartDate",value:rec.get("ReleaseStartDate")},{property:"ReleaseDate",value:rec.get("ReleaseDate")}],limit:1/0}).load({callback:function(records,operation,success){success?deferred.resolve(records):deferred.reject("Error loading Releases: "+operation.error.errors.join(","))}}),deferred},fetchAllowedValues:function(model,field_name){var deferred=Ext.create("Deft.Deferred");return Rally.data.ModelFactory.getModel({type:model,success:function(model){model.getField(field_name).getAllowedValueStore().load({callback:function(records,operation,success){var values=Ext.Array.map(records,function(record){return record.get("StringValue")});deferred.resolve(values)}})},failure:function(msg){deferred.reject("Error loading field values: "+msg)}}),deferred},fetchPortfolioItemTypes:function(){var deferred=Ext.create("Deft.Deferred"),store=Ext.create("Rally.data.wsapi.Store",{model:"TypeDefinition",fetch:["TypePath","Ordinal"],filters:[{property:"TypePath",operator:"contains",value:"PortfolioItem/"}],sorters:[{property:"Ordinal",direction:"ASC"}]});return store.load({callback:function(records,operation,success){if(success){var portfolioItemTypes=Array(records.length);_.each(records,function(d){var idx=Number(d.get("Ordinal"));portfolioItemTypes[idx]=d.get("TypePath")}),deferred.resolve(portfolioItemTypes)}else{var error_msg="";operation&&operation.error&&operation.error.errors&&(error_msg=operation.error.errors.join(",")),deferred.reject("Error loading Portfolio Item Types:  "+error_msg)}}}),deferred.promise},fetchDoneStates:function(){var deferred=Ext.create("Deft.Deferred");return Rally.data.ModelFactory.getModel({type:"HierarchicalRequirement",success:function(model){var field=model.getField("ScheduleState");field.getAllowedValueStore().load({callback:function(records,operation,success){if(success){for(var values=[],i=records.length-1;i>0;i--)values.push(records[i].get("StringValue")),"Accepted"==records[i].get("StringValue")&&(i=0);deferred.resolve(values)}else deferred.reject("Error loading ScheduleState values for User Story:  "+operation.error.errors.join(","))},scope:this})},failure:function(){var error="Could not load schedule states";deferred.reject(error)}}),deferred.promise}});
                Ext.define("PortfolioItemCostTracking.CostCalculator",{singleton:!0,calculationTypeStoryPoints:"points",calculationTypeTaskHours:"taskHours",calculationTypeTimesheets:"timesheets",notAvailableText:"--",completedScheduleStates:[],calculationType:void 0,currencySign:"$",currencyPrecision:0,currencyEnd:!1,normalizedCostPerUnit:1,projectCostPerUnit:{},getCostPerUnit:function(project_ref){return PortfolioItemCostTracking.CostCalculator.projectCostPerUnit[project_ref]||PortfolioItemCostTracking.CostCalculator.normalizedCostPerUnit},isProjectUsingNormalizedCost:function(project_ref){return PortfolioItemCostTracking.CostCalculator.projectCostPerUnit[project_ref]?!1:!0},getActualUnitsForTask:function(data){switch(PortfolioItemCostTracking.CostCalculator.calculationType){case"points":return null;case"taskHours":return data.Actuals||0;case"timesheets":return 1}return null},getTotalUnitsForTask:function(data){switch(PortfolioItemCostTracking.CostCalculator.calculationType){case"points":return null;case"taskHours":return data.ToDo||0+data.Actuals||0;case"timesheets":return 1}return null},getActualUnitsForStory:function(data){switch(PortfolioItemCostTracking.CostCalculator.calculationType){case"points":return data.PlanEstimate&&Ext.Array.contains(PortfolioItemCostTracking.CostCalculator.completedScheduleStates,data.ScheduleState)?data.PlanEstimate:0;case"taskHours":return data.TaskActualTotal||0;case"timesheets":return 1}return null},getTotalUnitsForStory:function(data){switch(PortfolioItemCostTracking.CostCalculator.calculationType){case"points":return data.PlanEstimate||0;case"taskHours":return(data.TaskActualTotal||0)+(data.TaskRemainingTotal||0);case"timesheets":return 1}return null},calculateTotalCostForStory:function(data){switch(PortfolioItemCostTracking.CostCalculator.calculationType){case"points":return data.PlanEstimate?data.PlanEstimate*PortfolioItemCostTracking.CostCalculator.getCostPerUnit(data.Project._ref):0;case"taskHours":return(data.TaskActualTotal+data.TaskRemainingTotal)*PortfolioItemCostTracking.CostCalculator.getCostPerUnit(data.Project._ref);case"timesheets":return 2}return null},calculateActualCostForStory:function(data){switch(PortfolioItemCostTracking.CostCalculator.calculationType){case"points":return data.PlanEstimate&&Ext.Array.contains(PortfolioItemCostTracking.CostCalculator.completedScheduleStates,data.ScheduleState)?data.PlanEstimate*PortfolioItemCostTracking.CostCalculator.getCostPerUnit(data.Project._ref):0;case"taskHours":return(data.TaskActualTotal||0)*PortfolioItemCostTracking.CostCalculator.getCostPerUnit(data.Project._ref);case"timesheets":return 1}return null},calculateTotalCostForTask:function(data){switch(PortfolioItemCostTracking.CostCalculator.calculationType){case"points":break;case"taskHours":return(data.ToDo||0+data.Actuals||0)*PortfolioItemCostTracking.CostCalculator.getCostPerUnit(data.Project._ref);case"timesheets":return 1}return null},calculateActualCostForTask:function(data){switch(PortfolioItemCostTracking.CostCalculator.calculationType){case"points":break;case"taskHours":return(data.Actuals||0)*PortfolioItemCostTracking.CostCalculator.getCostPerUnit(data.Project._ref);case"timesheets":return 1}return null},calculatePreliminaryBudget:function(data){var pb=0;if(data&&data.PreliminaryEstimate&&data.PreliminaryEstimate.Value){var cpu=PortfolioItemCostTracking.CostCalculator.getCostPerUnit(data.Project._ref);pb=cpu*data.PreliminaryEstimate.Value}return pb},formatCost:function(cost){return Ext.util.Format.currency(cost,this.currencySign,this.currencyPrecision,this.currencyEnd)},getStoryFetch:function(fetch){return fetch||(fetch=[]),fetch=Ext.Array.merge(fetch,["ObjectID","Project","ScheduleState","PortfolioItem"]),"points"===PortfolioItemCostTracking.CostCalculator.calculationType&&(fetch=Ext.Array.merge(fetch,["PlanEstimate"])),"taskHours"===PortfolioItemCostTracking.CostCalculator.calculationType&&(fetch=Ext.Array.merge(fetch,["TaskEstimateTotal","TaskActualTotal","TaskRemainingTotal"])),fetch},getPortfolioItemFetch:function(fetch){return fetch||(fetch=[]),fetch=Ext.Array.merge(fetch,["ObjectID","Parent","Children","UserStories","PreliminaryEstimate","Value"])}});
                Ext.define("PortfolioItemCostTracking.CostPerProjectSettings",{extend:"Ext.form.field.Base",alias:"widget.costperprojectsettings",config:{value:void 0,decodedValue:{}},fieldSubTpl:'<div id="{id}" class="settings-grid"></div>',width:"100%",cls:"column-settings",store:void 0,onDestroy:function(){this._grid&&(this._grid.destroy(),delete this._grid),this.callParent(arguments)},initComponent:function(){this.callParent(),this.addEvents("ready");var store=Ext.create("Rally.data.wsapi.Store",{model:"Project",fetch:["Name"],context:{project:null},limit:"Infinity"});store.load({scope:this,callback:this._buildProjectGrid})},_buildProjectGrid:function(records,operation,success){var decodedValue={};this.value&&!_.isEmpty(this.value)&&(decodedValue=Ext.JSON.decode(this.value),console.log("decodedValue",decodedValue));var data=[],empty_text="No exceptions";success?_.each(records,function(project){var cost=decodedValue[project.get("_ref")]||null;cost&&data.push({projectRef:project.get("_ref"),projectName:project.get("Name"),cost:cost})}):empty_text="Error(s) fetching Project data: <br/>"+operation.error.errors.join("<br/>");var custom_store=Ext.create("Ext.data.Store",{fields:["projectRef","projectName","cost"],data:data});this._grid=Ext.create("Rally.ui.grid.Grid",{autoWidth:!0,renderTo:this.inputEl,columnCfgs:this._getColumnCfgs(),showPagingToolbar:!1,store:custom_store,maxHeight:300,margin:"20 0 0 0",emptyText:empty_text,editingConfig:{publishMessages:!1}});var width=Math.max(this.inputEl.getWidth(!0),300);Ext.create("Rally.ui.Button",{text:"Select Projects",renderTo:this.inputEl,margin:"10 0 0 0",listeners:{scope:this,click:function(){Ext.create("ProjectPickerDialog",{autoShow:!0,maxHeight:400,maxWidth:400,width:Math.min(width,400),title:"Choose Project",selectedRefs:_.pluck(data,"projectRef"),listeners:{scope:this,itemschosen:function(items){var new_data=[],store=this._grid.getStore();_.each(items,function(item){store.findRecord("projectRef",item.get("_ref"))||new_data.push({projectRef:item.get("_ref"),projectName:item.get("Name"),cost:null})}),this._grid.getStore().add(new_data)}}})}}}),this.fireEvent("ready",!0)},_removeProject:function(){this.grid.getStore().remove(this.record)},_getColumnCfgs:function(){var me=this,columns=[{xtype:"rallyrowactioncolumn",scope:this,rowActionsFn:function(record){return[{text:"Remove",record:record,handler:me._removeProject,grid:me._grid}]},_renderGearIcon:function(value,metaData,record){return'<div class="row-action-icon icon-gear"/>'}},{text:"Project",dataIndex:"projectRef",flex:1,editor:!1,renderer:function(v,m,r){return r.get("projectName")},getSortParam:function(v,m,r){return"projectName"}},{text:"Cost Per Unit",dataIndex:"cost",editor:{xtype:"rallynumberfield"},renderer:function(v){return v&&v>0?v:"Use Default"}}];return columns},getSubmitData:function(){var data={};return data[this.name]=Ext.JSON.encode(this._buildSettingValue()),data},_buildSettingValue:function(){var mappings={},store=this._grid.getStore();return store.each(function(record){record.get("cost")&&record.get("projectRef")&&(mappings[record.get("projectRef")]=record.get("cost"))},this),mappings},getErrors:function(){var errors=[];return errors},setValue:function(value){this.callParent(arguments),this._value=value}});
                Ext.define("PortfolioItemCostTracking.RollupData",{mixins:{observable:"Ext.util.Observable"},data:{},keyField:"ObjectID",portfolioItemTypes:void 0,constructor:function(config){this.portfolioItemTypes=_.map(config.portfolioItemTypes,function(p){return p.toLowerCase()}),this.mixins.observable.constructor.call(this,config),this.addEvents("dataUpdated","error")},clearRollupData:function(key){key?this.data[key]=null:this.data={}},setRollupData:function(record){var rollup_data=this.data[record.get(this.keyField)]||null;return rollup_data?(this._setDataOnModel(record,rollup_data),void 0):(this._buildRollupData(record),void 0)},_buildRollupData:function(record){console.log("_buildRollupData",record.get("FormattedID"),record);var key=record.get(this.keyField);if(this.data[key]=this._getDataObj(record.getData(),record.get("_type")),record.get("UserStories"))return this._fetchTopLevelUserStories([key]).then({scope:this,success:function(){console.log("_buildRollupData._fetchTopLevelUserStories success",this.data),this._calculateRollupData(key),this._setDataOnModel(record,this.data[key])},failure:function(operation){console.log("_buildRollupData._fetchTopLevelUserStories failure",operation)}}),void 0;if(this._isPortfolioItem(record.get("_type"))&&record.get("Children")&&record.get("Children").Count>0){var child_model_type=this._getChildPortfolioModelType(record.get("_type"));this._fetchChildPortfolioItems(child_model_type,[key]).then({scope:this,success:function(){console.log("_buildRollupData._fetchChildPortfolioItems success",this.data),this._calculateRollupData(key),this._setDataOnModel(record,this.data[key])},failure:function(operation){console.log("_buildRollupData._fetchChildPortfolioItems failure",operation)}})}else console.log("_buildRollupData else",record),this._calculateRollupData(key),this._setDataOnModel(record,this.data[key])},_getDataObj:function(data,type){return new PortfolioItemCostTracking.RollupDataItem({data:data,type:type})},_isPortfolioItem:function(type){var portfolioItemRegExp=RegExp("^portfolioitem/","i");return portfolioItemRegExp.test(type)},_calculateRollupData:function(key){var data=this.data[key]||null;console.log("_calculateRollupData key, data, this.data",key,data,this.data),data&&this._isPortfolioItem(data.type)&&(console.log("data",data.data.FormattedID),data.type.toLowerCase()===this.portfolioItemTypes[0].toLowerCase()?(data.calculateRollupFromChildren(),data.preliminaryBudget=PortfolioItemCostTracking.CostCalculator.calculatePreliminaryBudget(data.data),console.log("--data",data,data.projects)):(data.totalCost=0,data.actualCost=0,data.remainingCost=0,data.projects=[],data.preliminaryBudget=PortfolioItemCostTracking.CostCalculator.calculatePreliminaryBudget(data.data),_.each(data.children,function(c){var child_key=c[this.keyField];this._calculateRollupData(child_key);var child_data=this.data[child_key];data.totalCost+=child_data.totalCost,data.actualCost+=child_data.actualCost,data.remainingCost+=child_data.remainingCost,data.projects=Ext.Array.merge(data.projects,child_data.projects||[])},this)))},_setDataOnModel:function(record,data){record.set("_rollupDataPreliminaryBudget",data.preliminaryBudget),record.set("_rollupDataTotalCost",data.totalCost),record.set("_rollupDataActualCost",data.actualCost),record.set("_rollupDataRemainingCost",data.remainingCost),record.set("_rollupDataToolTip",data.getTooltip()||null)},_getChildPortfolioModelType:function(portfolioItemType){var found=Ext.Array.filter(this.portfolioItemTypes,function(item){return item.toLowerCase()===portfolioItemType.toLowerCase()});if(found&&found.length>0){var idx=_.indexOf(this.portfolioItemTypes,found[0]);if(idx>0)return this.portfolioItemTypes[idx-1].toLowerCase()}return null},_fetchChildPortfolioItems:function(portfolioItemType,portfolioItemObjectIDs){var portfolioItemFetch=["ObjectID","Parent","Children","UserStories","PreliminaryEstimate","Value"],filters=_.map(portfolioItemObjectIDs,function(poid){return{property:"Parent.ObjectID",value:poid}});return filters=Rally.data.wsapi.Filter.or(filters),console.log("_fetchChildPortfolioItems",portfolioItemType,filters),PortfolioItemCostTracking.WsapiToolbox.fetchWsapiRecords(portfolioItemType,filters,portfolioItemFetch,{project:null}).then({scope:this,success:function(records){var child_model_type=this._getChildPortfolioModelType(portfolioItemType);_.each(records,function(r){if(r.get("Parent")&&r.get("Parent").ObjectID){var parent=r.get("Parent").ObjectID;this.data[parent].addChild(r.getData()),console.log(this.data[parent].children.length)}var obj_id=r.get("ObjectID");this.data[obj_id]=this._getDataObj(r.getData(),portfolioItemType)},this);var obj_ids=_.map(records,function(r){return r.get("ObjectID")});return records.length>0&&child_model_type?this._fetchChildPortfolioItems(child_model_type,obj_ids):this._fetchTopLevelUserStories(obj_ids)}})},_fetchTopLevelUserStories:function(portfolioItemObjectIDs){var deferred=Ext.create("Deft.Deferred");0===portfolioItemObjectIDs.length&&deferred.resolve();var filters=_.map(portfolioItemObjectIDs,function(pi_oid){return{property:"PortfolioItem.ObjectID",value:pi_oid}});filters=Rally.data.wsapi.Filter.or(filters);var storyFetch=PortfolioItemCostTracking.CostCalculator.getStoryFetch();return PortfolioItemCostTracking.WsapiToolbox.fetchWsapiRecords("HierarchicalRequirement",filters,storyFetch,{project:null}).then({scope:this,success:function(records){_.each(records,function(r){if(r.get("PortfolioItem")&&r.get("PortfolioItem").ObjectID){var obj_id=r.get("PortfolioItem").ObjectID;this.data[obj_id].addChild(r.getData()),console.log("adding children",this.data[obj_id].children.length),this.data[r.get("ObjectID")]=this._getDataObj(r.getData(),r.get("_type"))}},this),console.log("data",this.data),deferred.resolve()},failure:function(operation){console.log("_fetchTopLevelUserStories failed",operation),deferred.reject(operation)}}),deferred}});
                Ext.define("PortfolioItemCostTracking.RollupDataItem",{children:void 0,type:void 0,totalUnits:null,actualUnits:null,preliminaryBudget:null,actualCost:0,remainingCost:0,totalCost:0,tooltip:void 0,projects:void 0,data:void 0,constructor:function(config){this.data=config.data,this.type=config.type,this._updateProjectNameAndCostHash(this.data.Project),this.data.PreliminaryEstimate&&this.data.PreliminaryEstimate.Value&&(this.preliminaryBudget=this.data.PreliminaryEstimate.Value*PortfolioItemCostTracking.CostCalculator.getCostPerUnit(this.data.Project._ref)),"hierarchicalrequirement"===this.type.toLowerCase()&&(this.actualCost=PortfolioItemCostTracking.CostCalculator.calculateActualCostForStory(this.data),this.remainingCost=PortfolioItemCostTracking.CostCalculator.calculateTotalCostForStory(this.data)-this.actualCost,this.totalCost=PortfolioItemCostTracking.CostCalculator.calculateTotalCostForStory(this.data),this.actualUnits=PortfolioItemCostTracking.CostCalculator.getActualUnitsForStory(this.data),this.totalUnits=PortfolioItemCostTracking.CostCalculator.getTotalUnitsForStory(this.data)),"task"===this.type.toLowerCase()&&(this.actualCost=PortfolioItemCostTracking.CostCalculator.calculateActualCostForTask(this.data),this.totalCost=PortfolioItemCostTracking.CostCalculator.calculateTotalCostForTask(this.data),this.actualUnits=PortfolioItemCostTracking.CostCalculator.getActualUnitsForTask(this.data),this.totalUnits=PortfolioItemCostTracking.CostCalculator.getTotalUnitsForTask(this.data),this.remainingCost=null===this.actualCost||null===this.totalCost?null:this.totalCost-this.actualCost)},addChild:function(child){this.children||(this.children=[]),this.children.push(child)},calculateRollupFromChildren:function(){var noRollups=["task","hierarchicalrequirement"];if(!Ext.Array.contains(noRollups,this.type.toLowerCase())){var actual_value=0,total_value=0,actual_units=0,total_units=0;_.each(this.children,function(s){total_value+=PortfolioItemCostTracking.CostCalculator.calculateTotalCostForStory(s),actual_value+=PortfolioItemCostTracking.CostCalculator.calculateActualCostForStory(s),this._updateProjectNameAndCostHash(s.Project),actual_units+=PortfolioItemCostTracking.CostCalculator.getActualUnitsForStory(s),total_units+=PortfolioItemCostTracking.CostCalculator.getTotalUnitsForStory(s)},this),this.actualUnits=actual_units,this.totalUnits=total_units,this.totalCost=total_value,this.actualCost=actual_value,this.remainingCost=total_value-actual_value}},getTooltip:function(){var actual_units=null===this.actualUnits?"--":this.actualUnits,total_units=null===this.totalUnits?"--":this.totalUnits,html=Ext.String.format("[{0}] completed {1}/{2}<br/><br/>Cost per unit:<br/>",this.getType(),actual_units,total_units);return _.each(this.projectCosts,function(project_cost,project_name){html+=Ext.String.format("{0} {1}<br/>",PortfolioItemCostTracking.CostCalculator.formatCost(project_cost),project_name)}),html},_updateProjectNameAndCostHash:function(project){this.projectCosts=this.projectCosts||{};var name=project._refObjectName,cost=PortfolioItemCostTracking.CostCalculator.getCostPerUnit(project._ref);PortfolioItemCostTracking.CostCalculator.isProjectUsingNormalizedCost(project._ref)&&(name="normalized (default)"),console.log("--updateProjectNameandCostHash",name,cost),this.projectCosts[name]=cost,console.log("--updateProjectNameandCostHash",this.data.FormattedID,this.projectCosts)},getType:function(){switch(PortfolioItemCostTracking.CostCalculator.calculationType){case PortfolioItemCostTracking.CostCalculator.calculationTypeStoryPoints:return"Story points";case PortfolioItemCostTracking.CostCalculator.calculationTypeTaskHours:return"Task actuals";case PortfolioItemCostTracking.CostCalculator.calculationTypeTimesheets:return"Time spent"}return"Unknown"}});
                Ext.define("ProjectPickerDialog",{extend:"Rally.ui.dialog.Dialog",alias:"widget.projectpickerdialog",height:400,width:400,layout:"fit",closable:!0,draggable:!0,config:{title:"Choose an Item",multiple:!0,storeConfig:{context:{project:null},sorters:[{property:"FormattedID",direction:"DESC"}]},columns:[{text:"ID",dataIndex:"ObjectID",renderer:_.identity},"Name"],selectionButtonText:"Done",gridConfig:{},selectedRef:void 0,selectedRecords:void 0,initialSelectedRecords:void 0,showRadioButtons:!0},constructor:function(config){this.mergeConfig(config),this.callParent([this.config])},selectionCache:[],initComponent:function(){this.callParent(arguments),this.addEvents("itemschosen"),this.addCls(["chooserDialog","chooser-dialog"])},destroy:function(){this.callParent(arguments)},beforeRender:function(){this.callParent(arguments),this.addDocked({xtype:"toolbar",dock:"bottom",padding:"0 0 10 0",layout:{type:"hbox",pack:"center"},ui:"footer",items:[{xtype:"rallybutton",itemId:"doneButton",text:this.selectionButtonText,cls:"primary rly-small",scope:this,disabled:!0,userAction:"clicked done in dialog",handler:function(){this.fireEvent("itemschosen",this.getSelectedRecords()),this.close()}},{xtype:"rallybutton",text:"Cancel",cls:"secondary rly-small",handler:this.close,scope:this,ui:"link"}]}),this.introText&&this.addDocked({xtype:"component",componentCls:"intro-panel",html:this.introText}),this.addDocked({xtype:"toolbar",itemId:"searchBar",dock:"top",border:!1,padding:"0 0 10px 0",items:this.getSearchBarItems()}),this.buildGrid(),this.selectionCache=this.getInitialSelectedRecords()||[]},getSelectedRecords:function(){return this.multiple?this.selectionCache:this.selectionCache[0]},getSearchBarItems:function(){return[{xtype:"triggerfield",cls:"rui-triggerfield chooser-search-terms",emptyText:"Search Keyword or ID",enableKeyEvents:!0,flex:1,itemId:"searchTerms",listeners:{keyup:function(textField,event){event.getKey()===Ext.EventObject.ENTER&&this._search()},afterrender:function(field){field.focus()},scope:this},triggerBaseCls:"icon-search chooser-search-icon"}]},getStoreFilters:function(){return[]},buildGrid:function(){this.grid&&this.grid.destroy(),Ext.create("Rally.data.wsapi.ProjectTreeStoreBuilder").build({models:["project"],autoLoad:!0,enableHierarchy:!0,filters:[{property:"Parent",value:""}]}).then({scope:this,success:function(store){var mode=this.multiple?"MULTI":"SINGLE",checkbox_model=Ext.create("Rally.ui.selection.CheckboxModel",{mode:mode,enableKeyNav:!1,allowDeselect:!0});this.grid=this.add({xtype:"rallytreegrid",treeColumnDataIndex:"Name",treeColumnHeader:"Name",viewConfig:{cls:"grid-view-bulk-edit"},enableRanking:!1,enableEditing:!1,enableBulkEdit:!1,shouldShowRowActionsColumn:!1,selModel:checkbox_model,_defaultTreeColumnRenderer:function(value,metaData,record,rowIdx,colIdx,store){return store=store.treeStore||store,Rally.ui.renderer.RendererFactory.getRenderTemplate(store.model.getField("Name")).apply(record.data)},columnCfgs:[],store:store}),this.mon(this.grid,{beforeselect:this._onGridSelect,beforedeselect:this._onGridDeselect,load:this._onGridLoad,scope:this}),this.add(this.grid),this._onGridReady()}})},_enableDoneButton:function(){this.down("#doneButton").setDisabled(this.selectionCache.length?!1:!0)},_findRecordInSelectionCache:function(record){return _.findIndex(this.selectionCache,function(cachedRecord){return cachedRecord.get("_ref")===record.get("_ref")})},_onGridSelect:function(selectionModel,record){var index=this._findRecordInSelectionCache(record);console.log("selectionModel",selectionModel,record),-1===index&&(this.multiple||(this.selectionCache=[]),this.selectionCache.push(record)),this._enableDoneButton()},_onGridDeselect:function(selectionModel,record){var index=this._findRecordInSelectionCache(record);-1!==index&&this.selectionCache.splice(index,1),this._enableDoneButton()},_onGridReady:function(){return this.grid.rendered?this.grid.getStore().isLoading()?(this.mon(this.grid,"load",this._onGridReady,this,{single:!0}),void 0):(this._onGridLoad(),this.center(),void 0):(this.mon(this.grid,"afterrender",this._onGridReady,this,{single:!0}),void 0)},_onGridLoad:function(){var store=this.grid.store,records=[];_.each(this.selectionCache,function(record){var foundNode=store.getRootNode().findChild("_ref",record.get("_ref"),!0);foundNode&&records.push(foundNode)}),records.length&&this.grid.getSelectionModel().select(records)},_search:function(){var terms=this._getSearchTerms(),store=this.grid.getStore();terms?store.filter([Ext.create("Rally.data.wsapi.Filter",{property:"Name",operator:"contains",value:terms})]):store.clearFilter()},_getSearchTerms:function(){var textBox=this.down("#searchTerms");return textBox&&textBox.getValue()}}),Ext.override(Rally.data.wsapi.ParentChildMapper,{constructor:function(){this.parentChildTypeMap={project:[{typePath:"project",collectionName:"Children",parentField:"Parent"}],hierarchicalrequirement:[{typePath:"defect",collectionName:"Defects",parentField:"Requirement"},{typePath:"task",collectionName:"Tasks",parentField:"WorkProduct"},{typePath:"testcase",collectionName:"TestCases",parentField:"WorkProduct"},{typePath:"hierarchicalrequirement",collectionName:"Children",parentField:"Parent"}],defect:[{typePath:"task",collectionName:"Tasks",parentField:"WorkProduct"},{typePath:"testcase",collectionName:"TestCases",parentField:"WorkProduct"}],defectsuite:[{typePath:"defect",collectionName:"Defects",parentField:"DefectSuites"},{typePath:"task",collectionName:"Tasks",parentField:"WorkProduct"},{typePath:"testcase",collectionName:"TestCases",parentField:"WorkProduct"}],testset:[{typePath:"task",collectionName:"Tasks",parentField:"WorkProduct"},{typePath:"testcase",collectionName:"TestCases",parentField:"TestSets"}]}}}),Ext.define("Rally.data.wsapi.ProjectTreeStore",{requires:["Deft.promise.Deferred","Rally.data.ModelFactory","Rally.ui.grid.data.NodeInterface","Rally.data.ModelTypes","Rally.data.wsapi.ParentChildMapper"],extend:"Rally.data.wsapi.TreeStore",alias:"store.rallyprojectwsapitreestore",parentTypes:["project"],childLevelSorters:[{property:"Name",direction:"ASC"}],getParentFieldNamesByChildType:function(childType,parentType){var model=this.model;return _.transform(this.mapper.getParentFields(childType,parentType),function(acc,field){var typePath=field.typePath,fieldName=field.fieldName,hasFieldModel=model.hasField(fieldName);hasFieldModel&&acc.push(fieldName.replace(/\s+/g,""))},[],this)},filter:function(filters){this.fireEvent("beforefilter",this),this.filters.clear(),this.filters.addAll(filters),this._resetCurrentPage(),this.load()},clearFilter:function(suppressEvent){this._resetCurrentPage(),this.filters.clear(),this.filters.addAll(Ext.create("Rally.data.wsapi.Filter",{property:"Parent",value:""})),suppressEvent||this.load()}}),Ext.define("Rally.data.wsapi.ProjectTreeStoreBuilder",{extend:"Rally.data.wsapi.TreeStoreBuilder",build:function(config){return config=_.clone(config||{}),config.storeType="Rally.data.wsapi.ProjectTreeStore",this.loadModels(config).then({success:function(models){return models=_.values(models),this._buildStoreWithModels(models,config)},scope:this})}});
                Ext.define("Ext.CostTemplate",{extend:"Ext.grid.column.Template",alias:["widget.costtemplatecolumn"],tpl:"",costField:"",initComponent:function(){var me=this;Ext.QuickTips.init(),me.tpl=new Ext.XTemplate('<tpl><div data-qtip="{[this.getTooltip(values)]}">{[this.getCost(values)]}</div></tpl>',{costField:me.costField,getCost:function(values){return null===values[this.costField]?PortfolioItemCostTracking.CostCalculator.notAvailableText:PortfolioItemCostTracking.CostCalculator.formatCost(values[this.costField]||0)},getTooltip:function(values){return values._rollupDataToolTip?values._rollupDataToolTip:""}}),me.hasCustomRenderer=!0,me.callParent(arguments)},getValue:function(){return this.values[this.costField]||0},defaultRenderer:function(value,meta,record){var data=Ext.apply({},record.data,record.getAssociatedData());return this.tpl.apply(data)}});
                Ext.define("TreeGridContainerCustomFilterControl",{alias:"plugin.treegridcontainercustomfiltercontrol",extend:"Rally.ui.gridboard.plugin.GridBoardCustomFilterControl",showControl:function(){return this.controlCmp||this._createControlCmp(),this.controlCmp&&this.controlCmp.show(),this.controlCmp}});
                Ext.define("TreeGridContainerFieldPicker",{alias:"plugin.treegridcontainerfieldpicker",extend:"Ext.AbstractPlugin",mixins:["Rally.ui.gridboard.plugin.GridBoardControlShowable"],requires:["Rally.ui.popover.Popover","Rally.ui.Button","Rally.ui.picker.FieldPicker"],gridAlwaysSelectedValues:["FormattedID","Name"],gridFieldBlackList:["Actuals","Changesets","Children","Description","Notes","ObjectID","Predecessors","RevisionHistory","Subscription","Successors","TaskIndex","Workspace","VersionId"],modelNames:[],stateful:!0,margin:"3 9 10 10",constructor:function(config){config.gridFieldBlackList=_.union(this.gridFieldBlackList,config.gridFieldBlackList),config.gridAlwaysSelectedValues=_.union(this.gridAlwaysSelectedValues,config.gridAlwaysSelectedValues),this.callParent(arguments)},init:function(cmp){this.callParent(arguments),this.cmp=cmp;var rankingEnabled=this.cmp.getContext().getWorkspace().WorkspaceConfiguration.DragDropRankingEnabled&&cmp.gridConfig.enableRanking!==!1;this.gridAlwaysSelectedValues=this._modifyFieldCollection(this.gridAlwaysSelectedValues,["DragAndDropRank"],rankingEnabled),this.gridFieldBlackList=this._modifyFieldCollection(this.gridFieldBlackList,["DragAndDropRank"],!rankingEnabled),this.stateId=this.stateId||this.cmp.getContext().getScopedStateId("shownfields");var state=Ext.state.Manager.get(this.stateId);this._fields=state&&state.fields,this.showControl()},showControl:function(){return this.controlCmp||this._createControlCmp(),this.controlCmp&&this.controlCmp.show(),this.controlCmp},_modifyFieldCollection:function(collection,fields,include){return include?_.union(collection,fields):_.reject(collection,function(field){return _.contains(fields,field)})},getControlCmpConfig:function(){return{xtype:"rallybutton",itemId:"fieldpickerbtn",cls:"field-picker-btn secondary rly-small",margin:this.margin,iconCls:"icon-add-column",toolTipConfig:{html:this.getTitle(),anchor:"top"},listeners:{click:this._onClick,scope:this}}},_onClick:function(btn){this._createPopover(btn.getEl())},_getPickerConfig:function(){var pickerConfig;return pickerConfig=_.extend({value:_.pluck(this.cmp.getGrid().columns,"dataIndex").join(","),fieldBlackList:this.gridFieldBlackList,alwaysSelectedValues:this.gridAlwaysSelectedValues},this.fieldPickerConfig)},_createPopover:function(popoverTarget){this.popover=Ext.create("Rally.ui.popover.Popover",{target:popoverTarget,placement:["bottom","left","top","right"],cls:"field-picker-popover",toFront:Ext.emptyFn,buttonAlign:"center",title:this.getTitle(),listeners:{destroy:function(){this.popover=null},scope:this},buttons:[{xtype:"rallybutton",text:"Apply",cls:"field-picker-apply-btn primary rly-small",listeners:{click:function(){this._onApply(this.popover)},scope:this}},{xtype:"rallybutton",text:"Cancel",cls:"field-picker-cancel-btn secondary dark rly-small",listeners:{click:function(){this.popover.close()},scope:this}}],items:[_.extend({xtype:"rallyfieldpicker",cls:"field-picker",itemId:"fieldpicker",modelTypes:this._getModelTypes(),alwaysExpanded:!0,width:200,placeholderText:"Search",selectedTextLabel:"Selected",availableTextLabel:"Available",listeners:{specialkey:function(field,e){e.getKey()===e.ESC&&this.popover.close()},scope:this}},this._getPickerConfig())]})},_getModelTypes:function(){return _.pluck(this._getModels(),"typePath")},_getModels:function(){return _.reduce(this.cmp.getModels(),function(accum,model){return"artifact"===model.typePath?accum=accum.concat(model.getArtifactComponentModels()):accum.push(model),accum},[])},getTitle:function(){return"Show Columns"},updateFields:function(fields,suspendLoad){this._fields=fields,console.log("updateFields",fields),this.cmp.updateFields(fields),this._updatePickerValue(fields)},_updatePickerValue:function(fields){this.popover&&this.popover.down("rallyfieldpicker")&&this.popover.down("rallyfieldpicker").setValue(this._fields.join(","))},_onApply:function(popover){var fieldPicker=popover.down("rallyfieldpicker"),fields=_.map(fieldPicker.getValue(),function(field){return field.get("name")});this.updateFields(fields),popover.close()}});
                Ext.define("TreeGridContainer",{extend:"Ext.Container",mixins:["Rally.app.Scopeable"],requires:["Rally.ui.LeftRight","Rally.ui.grid.TreeGrid"],alias:"widget.treegridcontainer",cls:"rui-gridboard",storeConfig:{},gridConfig:{},modelNames:[],layout:{type:"auto"},currentCustomFilter:[],items:[{itemId:"header",xtype:"rallyleftright",padding:"4 10 10 10",overflowX:"hidden"}],initComponent:function(){this.plugins=this.plugins||[],this.stateId=this.getAppContextOrEnvironmentContext().getScopedStateId(this.stateId),this.callParent(arguments),this.addEvents(["load","recordcreate","recordupdate","preferencesaved","modeltypeschange"]),this.on("modeltypeschange",function(gridboard,types){this.modelNames=types},this)},afterRender:function(){this.callParent(arguments),this._addGrid()},destroy:function(){var grid=this.getGrid();grid&&grid.store&&_.isFunction(grid.store.clearData)&&grid.store.clearData(),this.callParent(arguments)},getGrid:function(){return this.down("rallytreegrid")},getHeader:function(){return this.down("#header")},getModelNames:function(){return this.modelNames},getModels:function(){return this.getGrid().getModels()},applyCustomFilter:function(filterObj){var grid=this.getGrid();this.currentCustomFilter=filterObj,console.log("grid",grid),grid&&this._applyGridFilters(grid,filterObj)},getFilter:function(){return this.currentFilter},setHeight:function(){this.callParent(arguments);var grid=this.getGrid();grid&&grid.rendered&&grid.getHeight()!==this.getAvailableGridBoardHeight()&&this.grid().setHeight(this.getAvailableGridBoardHeight())},getAvailableGridBoardHeight:function(){return this.getHeight()-this.down("#header").getHeight()-10},updateFields:function(fields){console.log("updateFields",fields);var grid=this.getGrid();columnCfgs=grid._getStatefulColumns(fields),fieldscolumnCfgs=grid._mergeColumnConfigs(columnCfgs,this.columns),columnCfgs=Ext.Array.merge(columnCfgs,this.gridConfig.customColumns||[]),console.log("columnCfgs",columnCfgs),grid.columnCfgs=columnCfgs},_getGridConfig:function(){var context=this.getContext()||Rally.environment.getContext(),columnCfgs=Ext.Array.merge(this.gridConfig.columnCfgs||[],this.gridConfig.customColumns||[]),config=Ext.merge({xtype:"rallytreegrid",context:context,enableRanking:!1,defaultSortToRank:!0,enableBlockedReasonPopover:!0,height:this.getAvailableGridBoardHeight()},this.gridConfig);return config.columnCfgs=columnCfgs,_.isEmpty(config.store)&&Ext.Error.raise("No grid store configured"),config},_getConfiguredFilters:function(extraFilters,types){var filters=_.compact(Ext.Array.merge(this.getGrid().store.filters,this.storeConfig&&this.storeConfig.filters,this.gridConfig&&this.gridConfig.storeConfig&&this.gridConfig.storeConfig.filters,extraFilters));return console.log("_getConfiguredFilters",""+filters,_.isFunction(this.getModels()[0].getArtifactComponentModel)),console.log("_getConfiguredFilters",filters.toString),filters},_addGrid:function(){var grid=this.add(this._getGridConfig());return this.mon(grid,"afterproxyload",this._onGridLoad,this),this.currentCustomFilter&&this._applyGridFilters(grid,this.currentCustomFilter),grid},_applyGridFilters:function(grid,filterObj){_.isEmpty(filterObj.types)||(grid.store.parentTypes=filterObj.types),grid.store.clearFilter(!0),console.log("applied filters",this._getConfiguredFilters(filterObj.filters||[],filterObj.types||[])),grid.store.filter(this._getConfiguredFilters(filterObj.filters||[],filterObj.types||[]))},_onGridLoad:function(){this.fireEvent("load",this),Rally.BrowserTest&&Rally.BrowserTest.publishComponentReady(this)}});
                Ext.define("HierarchyExporter",{parentModel:null,descendantModels:null,fetch:null,filters:null,constructor:function(config){Ext.merge(this,config)},fetchResults:function(){var deferred=Ext.create("Deft.Deferred");return PortfolioItemCostTracking.WsapiToolbox.fetchWsapiRecords(this.parentModel,this.filters,this.fetch).then({success:function(records){deferred.resolve(records)},failure:function(msg){deferred.reject(msg)}}),deferred}});

            Rally.launchApp('PortfolioItemCostTracking', {
                name:"portfolio-item-cost-tracking",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .lbl{text-transform:uppercase;font-family:ProximaNovaSemiBold, Helvetica, Arial;font-size:10px}.x-form-trigger-wrap{margin-top:0px!important}
    </style>
</head>
<body>
</body>
</html>
