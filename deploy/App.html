<!DOCTYPE html>
<html>
<head>
    <title>portfolio-item-cost-tracking</title>

    <script type="text/javascript" src="/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("PortfolioItemCostTracking",{extend:"Rally.app.App",componentCls:"app",defaults:{margin:10,startDate:new Date("2015-01-01"),endDate:new Date("2015-12-31"),groupByRelease:!1},items:[{xtype:"container",cls:"header",layout:{type:"hbox"}},{xtype:"container",cls:"body"}],config:{defaultSettings:{calculationType:"points",normalizedCostPerUnit:1e3,projectCostPerUnit:{},currencySign:"$"}},portfolioItemRollupData:{},launch:function(){Deft.Promise.all([PortfolioItemCostTracking.WsapiToolbox.fetchPortfolioItemTypes(),PortfolioItemCostTracking.WsapiToolbox.fetchDoneStates()]).then({scope:this,success:function(results){this.portfolioItemTypes=results[0],this._initializeSettings(this.getSettings(),results[1]),this._initializeUI()},failure:function(msg){Rally.ui.notify.Notifier.showError({message:msg})}})},_initializeSettings:function(settings,doneScheduleStates){PortfolioItemCostTracking.CostCalculator.notAvailableText="N/A",PortfolioItemCostTracking.CostCalculator.currencySign=settings.currencySign,PortfolioItemCostTracking.CostCalculator.currencyPrecision=0,PortfolioItemCostTracking.CostCalculator.currencyEnd=!1,doneScheduleStates&&(PortfolioItemCostTracking.CostCalculator.completedScheduleStates=doneScheduleStates),PortfolioItemCostTracking.CostCalculator.normalizedCostPerUnit=settings.normalizedCostPerUnit;var project_cpu=settings.projectCostPerUnit||{};Ext.isObject(project_cpu)||(project_cpu=Ext.JSON.decode(project_cpu)),PortfolioItemCostTracking.CostCalculator.projectCostPerUnit=project_cpu,console.log("projectCostPerUnit",project_cpu,"completedScheduleStates",doneScheduleStates),PortfolioItemCostTracking.CostCalculator.calculationType=settings.calculationType||"points"},_initializeUI:function(){var header=this.down("container[cls=header]");header.removeAll(),header.add({xtype:"rallydatefield",itemId:"dt-start",stateful:!0,stateId:this.getContext().getScopedStateId("dt-start"),stateEvents:["change"],value:this.defaults.startDate,margin:this.defaults.margin,fieldLabel:"Start Date",labelSeparator:"",labelAlign:"top",listeners:{scope:this,change:this.refreshData}}),header.add({xtype:"rallydatefield",itemId:"dt-end",stateful:!0,stateId:this.getContext().getScopedStateId("dt-end"),stateEvents:["change"],value:this.defaults.endDate,margin:this.defaults.margin,labelSeparator:"",fieldLabel:"End Date",labelAlign:"top",listeners:{scope:this,change:this.refreshData}}),header.add({xtype:"rallyportfolioitemtypecombobox",itemId:"cb-type",stateful:!0,stateId:this.getContext().getScopedStateId("cb-type"),stateEvents:["change"],margin:this.defaults.margin,fieldLabel:"Portfolio Item Type",labelAlign:"top",listeners:{scope:this,change:this.refreshData,ready:this.refreshData}}),header.add({xtype:"rallybutton",cls:"rly-small secondary",iconCls:"icon-export",iconOnly:!0,margin:this.defaults.margin})},_getCmpValue:function(scope,item_id){var cmp=scope.down(item_id)||null;return cmp?cmp.getValue()||null:null},_getModel:function(){var cmp=this.down("#cb-type")||null;return cmp?cmp.getRecord().get("TypePath").toLowerCase():null},_getDateFilters:function(start_date,end_date){var filter_actual=[{property:"ActualEndDate",operator:">=",value:Rally.util.DateTime.toIsoString(start_date)},{property:"ActualEndDate",operator:"<",value:Rally.util.DateTime.toIsoString(end_date)}];filter_actual=Rally.data.wsapi.Filter.and(filter_actual);var filter_planned=[{property:"ActualEndDate",value:null},{property:"PlannedEndDate",operator:"<",value:Rally.util.DateTime.toIsoString(end_date)},{property:"PlannedEndDate",operator:">=",value:Rally.util.DateTime.toIsoString(start_date)}];return filter_planned=Rally.data.wsapi.Filter.and(filter_planned),filter_actual.or(filter_planned)},refreshData:function(cmp){var start_date=this._getCmpValue(this,"#dt-start"),end_date=this._getCmpValue(this,"#dt-end"),model=this._getModel();if(this.getBody().removeAll(),null===start_date||null===end_date||null===model)return this.getBody().add({xtype:"container",html:"Please select a Start Date, End Date and Portfolio Item Type."}),void 0;cmp.suspendEvents(!1);var filters=this._getDateFilters(start_date,end_date),me=this;Ext.create("Rally.data.wsapi.TreeStoreBuilder").build({models:[model],filters:filters,autoLoad:!0,fetch:["FormattedID","Name","Project","PercentDoneByStoryPlanEstimate","AcceptedLeafStoryPlanEstimateTotal","LeafStoryPlanEstimateTotal","Children"],enableHierarchy:!0,listeners:{scope:me,load:me._setRollupData}}).then({scope:this,success:function(store){store.model.addField({name:"_rollupDataPreliminaryBudget",type:"auto",defaultValue:null}),store.model.addField({name:"_rollupDataTotalCost",type:"auto",defaultValue:null}),store.model.addField({name:"_rollupDataRemainingCost",type:"auto",defaultValue:null}),store.model.addField({name:"_rollupDataToolTip",type:"string",defaultValue:null}),this._updateDisplay(store)}}).always(function(){cmp.resumeEvents()})},_setRollupData:function(store,node,records,success){console.log("app.js _setRollupData",store,node,records,success);var rollup_data=this.rollupData;rollup_data||(this.rollupData=Ext.create("PortfolioItemCostTracking.RollupData",{portfolioItemTypes:this.portfolioItemTypes,listeners:{scope:this,dataUpdated:function(record){console.log("dataChanged",this.rollupData.data,this.down("rallytreegrid").getStore())}}}),rollup_data=this.rollupData),_.each(records,function(r){rollup_data.setRollupData(r)},this)},_updateDisplay:function(store){this.getBody().add({xtype:"rallytreegrid",columnCfgs:this._getColumnCfgs(),store:store})},_getColumnCfgs:function(){return[{dataIndex:"Name",text:"Name",flex:5},{dataIndex:"Project",text:"Project",editor:!1},{dataIndex:"PreliminaryEstimate",text:"Preliminary Budget",align:"right",editor:!1,renderer:PortfolioItemCostTracking.CostCalculator.preliminaryBudgetRenderer},{dataIndex:"PercentDoneByStoryPlanEstimate",text:"% Done by Story Points"},{dataIndex:"FormattedID",text:"Actual Cost",renderer:PortfolioItemCostTracking.CostCalculator.actualCostRenderer},{dataIndex:"FormattedID",text:"Remaining Cost",renderer:PortfolioItemCostTracking.CostCalculator.costRemainingRenderer}]},getBody:function(){return this.down("container[cls=body]")},getSettingsFields:function(){return PortfolioItemCostTracking.Settings.getFields()},onSettingsUpdate:function(settings){this.rollupData.clearRollupData(),this._initializeSettings(settings),this._initializeUI()}});
                Ext.define("PortfolioItemCostTracking.Settings",{singleton:!0,currencyData:[{name:"US Dollars",value:"$"}],getFields:function(config){var currency_store=Ext.create("Rally.data.custom.Store",{data:this.currencyData});return[{xtype:"rallycombobox",name:"currencySign",store:currency_store,displayField:"name",valueField:"value",fieldLabel:"Currency",labelAlign:"top",labelCls:"lbl",margin:"10 0 10 0"},{xtype:"radiogroup",fieldLabel:"Calculate Cost",labelAlign:"top",labelCls:"lbl",columns:1,vertical:!0,margin:"10 0 10 0",items:[{boxLabel:"Based on Story Points",name:"calculationType",inputValue:"points",checked:!0},{boxLabel:"Based on Task Hours",name:"calculationType",inputValue:"taskHours"},{boxLabel:"Using Timesheets",name:"calculationType",inputValue:"timesheets"}]},{xtype:"rallytextfield",name:"normalizedCostPerUnit",fieldLabel:"Normalized Cost Per Unit",labelAlign:"top",labelCls:"lbl",width:175,margin:"25 0 0 0"},{xtype:"costperprojectsettings",name:"projectCostPerUnit",fieldLabel:"Cost Per Unit by Team",labelAlign:"top",labelCls:"lbl",margin:"25 0 0 0",readyEvent:"ready"}]}});
                Ext.define("PortfolioItemCostTracking.WsapiToolbox",{singleton:!0,fetchWsapiCount:function(model,query_filters){var deferred=Ext.create("Deft.Deferred"),store=Ext.create("Rally.data.wsapi.Store",{model:model,fetch:["ObjectID"],filters:query_filters,limit:1,pageSize:1}).load({callback:function(records,operation,success){success?deferred.resolve(operation.resultSet.totalRecords):deferred.reject(Ext.String.format("Error getting {0} count for {1}: {2}",model,""+query_filters,operation.error.errors.join(",")))}});return deferred},fetchWsapiRecords:function(model,query_filters,fetch_fields,context){var deferred=Ext.create("Deft.Deferred"),store=Ext.create("Rally.data.wsapi.Store",{model:model,fetch:fetch_fields,filters:query_filters,context:context,limit:1/0}).load({callback:function(records,operation,success){success?deferred.resolve(records):deferred.reject(Ext.String.format("Error getting {0} for {1}: {2}",model,""+query_filters,operation.error.errors.join(",")))}});return deferred},fetchReleases:function(timebox){var deferred=Ext.create("Deft.Deferred"),rec=timebox.getRecord(),me=this;return null===rec&&deferred.resolve([]),Ext.create("Rally.data.wsapi.Store",{model:"Release",fetch:["ObjectID"],filters:[{property:"Name",value:rec.get("Name")},{property:"ReleaseStartDate",value:rec.get("ReleaseStartDate")},{property:"ReleaseDate",value:rec.get("ReleaseDate")}],limit:1/0}).load({callback:function(records,operation,success){success?deferred.resolve(records):deferred.reject("Error loading Releases: "+operation.error.errors.join(","))}}),deferred},fetchAllowedValues:function(model,field_name){var deferred=Ext.create("Deft.Deferred");return Rally.data.ModelFactory.getModel({type:model,success:function(model){model.getField(field_name).getAllowedValueStore().load({callback:function(records,operation,success){var values=Ext.Array.map(records,function(record){return record.get("StringValue")});deferred.resolve(values)}})},failure:function(msg){deferred.reject("Error loading field values: "+msg)}}),deferred},fetchPortfolioItemTypes:function(){var deferred=Ext.create("Deft.Deferred"),store=Ext.create("Rally.data.wsapi.Store",{model:"TypeDefinition",fetch:["TypePath","Ordinal"],filters:[{property:"TypePath",operator:"contains",value:"PortfolioItem/"}],sorters:[{property:"Ordinal",direction:"ASC"}]});return store.load({callback:function(records,operation,success){if(success){var portfolioItemTypes=Array(records.length);_.each(records,function(d){var idx=Number(d.get("Ordinal"));portfolioItemTypes[idx]=d.get("TypePath")}),deferred.resolve(portfolioItemTypes)}else{var error_msg="";operation&&operation.error&&operation.error.errors&&(error_msg=operation.error.errors.join(",")),deferred.reject("Error loading Portfolio Item Types:  "+error_msg)}}}),deferred.promise},fetchDoneStates:function(){var deferred=Ext.create("Deft.Deferred");return Rally.data.ModelFactory.getModel({type:"HierarchicalRequirement",success:function(model){var field=model.getField("ScheduleState");field.getAllowedValueStore().load({callback:function(records,operation,success){if(success){for(var values=[],i=records.length-1;i>0;i--)values.push(records[i].get("StringValue")),"Accepted"==records[i].get("StringValue")&&(i=0);deferred.resolve(values)}else deferred.reject("Error loading ScheduleState values for User Story:  "+operation.error.errors.join(","))},scope:this})},failure:function(){var error="Could not load schedule states";deferred.reject(error)}}),deferred.promise}});
                Ext.define("PortfolioItemCostTracking.CostCalculator",{singleton:!0,calculationTypeStoryPoints:"points",calculationTypeTaskHours:"taskHours",calculationTypeTimesheets:"timesheets",calculationType:void 0,currencySign:"$",currencyPrecision:0,currencyEnd:!1,notAvailableText:"",normalizedCostPerUnit:1,projectCostPerUnit:{},completedScheduleStates:[],getCostPerUnit:function(project_ref){return PortfolioItemCostTracking.CostCalculator.projectCostPerUnit[project_ref]||PortfolioItemCostTracking.CostCalculator.normalizedCostPerUnit},calculateTotalCostForStory:function(data){switch(PortfolioItemCostTracking.CostCalculator.calculationType){case"points":return data.PlanEstimate?data.PlanEstimate*PortfolioItemCostTracking.CostCalculator.getCostPerUnit(data.Project._ref):null;case"taskHours":return data.TaskEstimateTotal*PortfolioItemCostTracking.CostCalculator.getCostPerUnit(data.Project._ref);case"timesheets":return 2}return null},calculateActualCostForStory:function(data){switch(console.log("calculateActualCostForStory",data,PortfolioItemCostTracking.CostCalculator.getCostPerUnit(data.Project._ref),PortfolioItemCostTracking.CostCalculator.completedScheduleStates),PortfolioItemCostTracking.CostCalculator.calculationType){case"points":if(data.PlanEstimate&&Ext.Array.contains(PortfolioItemCostTracking.CostCalculator.completedScheduleStates,data.ScheduleState))return data.PlanEstimate*PortfolioItemCostTracking.CostCalculator.getCostPerUnit(data.Project._ref);break;case"taskHours":return(data.TaskEstimateTotal-data.TaskRemainingTotal)*PortfolioItemCostTracking.CostCalculator.getCostPerUnit(data.Project._ref);case"timesheets":return 1}return null},formatCost:function(cost){return Ext.util.Format.currency(cost,this.currencySign,this.currencyPrecision,this.currencyEnd)},actualCostRenderer:function(value,metaData,record){var cr=PortfolioItemCostTracking.CostCalculator.notAvailableText;return isNaN(record.get("_rollupDataTotalCost"))?cr:PortfolioItemCostTracking.CostCalculator.formatCost(record.get("_rollupDataTotalCost"))},costRemainingRenderer:function(value,metaData,record){var cr=PortfolioItemCostTracking.CostCalculator.notAvailableText;return isNaN(record.get("_rollupDataRemainingCost"))?cr:PortfolioItemCostTracking.CostCalculator.formatCost(record.get("_rollupDataRemainingCost"))},preliminaryBudgetRenderer:function(value,metaData,record){var pb=PortfolioItemCostTracking.CostCalculator.notAvailableText;if(value&&value.Value){var cpu=PortfolioItemCostTracking.CostCalculator.getCostPerUnit(record.get("Project")._ref);pb=PortfolioItemCostTracking.CostCalculator.formatCost(cpu*value.Value)}return pb},getStoryFetch:function(){var fetch=["ObjectID","Project","ScheduleState","PortfolioItem"];return"points"===PortfolioItemCostTracking.CostCalculator.calculationType&&fetch.push("PlanEstimate"),"taskHours"===PortfolioItemCostTracking.CostCalculator.calculationType&&(fetch=fetch.concat(["TaskEstimateTotal","TaskActualTotal","TaskRemainingTotal"])),fetch}});
                Ext.define("PortfolioItemCostTracking.CostPerProjectSettings",{extend:"Ext.form.field.Base",alias:"widget.costperprojectsettings",config:{value:void 0,decodedValue:{}},fieldSubTpl:'<div id="{id}" class="settings-grid"></div>',width:"100%",cls:"column-settings",store:void 0,onDestroy:function(){this._grid&&(this._grid.destroy(),delete this._grid),this.callParent(arguments)},initComponent:function(){this.callParent(),this.addEvents("ready");var store=Ext.create("Rally.data.wsapi.Store",{model:"Project",fetch:["Name"],context:{project:null},limit:"Infinity"});store.load({scope:this,callback:this._buildProjectGrid})},_buildProjectGrid:function(records,operation,success){var decodedValue={};this.value&&!_.isEmpty(this.value)&&(decodedValue=Ext.JSON.decode(this.value),console.log("decodedValue",decodedValue));var data=[],empty_text="No Projects with exception cost data (All projects use the Normalized Cost Per Unit)";success?_.each(records,function(project){var cost=decodedValue[project.get("_ref")]||null;cost&&data.push({projectRef:project.get("_ref"),projectName:project.get("Name"),cost:cost})}):empty_text="Error(s) fetching Project data: <br/>"+operation.error.errors.join("<br/>");var custom_store=Ext.create("Ext.data.Store",{fields:["projectRef","projectName","cost"],data:data});this._grid=Ext.create("Rally.ui.grid.Grid",{autoWidth:!0,renderTo:this.inputEl,columnCfgs:this._getColumnCfgs(),showRowActionsColumn:!1,showPagingToolbar:!1,store:custom_store,maxHeight:300,emptyText:empty_text,editingConfig:{publishMessages:!1}}),Ext.create("Rally.ui.Button",{text:"Add Project(s)...",listeners:{click:function(){Ext.create("ProjectPickerDialog",{selectedRefs:_.pluck(data,"projectRef"),listeners:{itemschosen:function(items){console.log("items",items)}}})}}}),this.fireEvent("ready",!0)},_getColumnCfgs:function(){var columns=[{text:"Project",dataIndex:"projectRef",flex:1,editor:!1,renderer:function(v,m,r){return r.get("projectName")},getSortParam:function(v,m,r){return"projectName"}},{text:"Cost Per Unit",dataIndex:"cost",editor:{xtype:"rallynumberfield"},renderer:function(v){return v&&v>0?v:"Use Default"}}];return columns},getSubmitData:function(){var data={};return data[this.name]=Ext.JSON.encode(this._buildSettingValue()),data},_buildSettingValue:function(){var mappings={},store=this._grid.getStore();return store.each(function(record){record.get("cost")&&record.get("projectRef")&&(mappings[record.get("projectRef")]=record.get("cost"))},this),mappings},getErrors:function(){var errors=[];return errors},setValue:function(value){this.callParent(arguments),this._value=value}});
                Ext.define("PortfolioItemCostTracking.RollupData",{mixins:{observable:"Ext.util.Observable"},data:{},keyField:"ObjectID",portfolioItemTypes:void 0,sourceType:"hierarchicalrequirement",constructor:function(config){this.portfolioItemTypes=_.map(config.portfolioItemTypes,function(p){return p.toLowerCase()}),this.mixins.observable.constructor.call(this,config),this.addEvents("dataUpdated","error")},clearRollupData:function(key){key?this.data[key]=null:this.data={}},setRollupData:function(record){var rollup_data=this.data[record.get(this.keyField)]||null;return rollup_data?(this._setDataOnModel(record,rollup_data),void 0):(this._buildRollupData(record),void 0)},_buildRollupData:function(record){console.log("_buildRollupData",record.get("FormattedID"),record);var key=record.get(this.keyField);if(this.data[key]=this._getDataObj(record.getData(),record.get("_type")),record.get("UserStories"))return this._fetchTopLevelUserStories([key]).then({scope:this,success:function(){console.log("_buildRollupData._fetchTopLevelUserStories success",this.data),this._calculateRollupData(key),this._setDataOnModel(record,this.data[key])},failure:function(operation){console.log("_buildRollupData._fetchTopLevelUserStories failure",operation)}}),void 0;if(record.get("Children")&&record.get("Children").Count>0){var child_model_type=this._getChildPortfolioModelType(record.get("_type"));this._fetchChildPortfolioItems(child_model_type,[key]).then({scope:this,success:function(){console.log("_buildRollupData._fetchChildPortfolioItems success",this.data),this._calculateRollupData(record),this._setDataOnModel(record,this.data[key])},failure:function(operation){console.log("_buildRollupData._fetchChildPortfolioItems failure",operation)}})}else console.log("_buildRollupData else",record),this._calculateRollupData(record),this._setDataOnModel(record,this.data[key])},_getDataObj:function(data,type){return new PortfolioItemCostTracking.RollupDataItem({data:data,type:type})},_calculateRollupData:function(key){var data=this.data[key]||null;console.log("_calculateRollupData key, data, this.data",key,data,this.data),data&&(data.type.toLowerCase()===this.portfolioItemTypes[0].toLowerCase()?data.calculateRollupFromChildren():(data.preliminaryBudget=0,data.totalCost=0,data.remainingCost=0,_.each(data.children,function(c){this._calculateRollupData(c[this.keyField]),data.preliminaryBudget+=c.preliminaryBudget,data.totalCost+=c.totalCost,data.remainingCost+=c.remainingCost},this)))},_setDataOnModel:function(record,data){record.set("_rollupDataPreliminaryBudget",data.preliminaryBudget||0),record.set("_rollupDataTotalCost",data.actualCost||0),record.set("_rollupDataRemainingCost",data.remainingCost||0),record.set("_rollupDataToolTip",data.tooltip||null)},_getChildPortfolioModelType:function(portfolioItemType){var idx=_.indexOf(this.portfolioItemTypes,portfolioItemType.toLowerCase());return console.log("__getChildPortfolioModelType",portfolioItemType,this.portfolioItemTypes,idx),idx>0?this.portfolioItemTypes[idx-1]:null},_fetchChildPortfolioItems:function(portfolioItemType,portfolioItemObjectIDs){var portfolioItemFetch=["ObjectID","Parent","Children","UserStories"],filters=_.map(portfolioItemObjectIDs,function(poid){return{property:"Parent.ObjectID",value:poid}});return filters=Rally.data.wsapi.Filter.or(filters),PortfolioItemCostTracking.WsapiToolbox.fetchWsapiRecords(portfolioItemType,filters,portfolioItemFetch,{project:null}).then({scope:this,success:function(records){var child_model_type=this._getChildPortfolioModelType(portfolioItemType);_.each(records,function(r){if(r.get("Parent")&&r.get("Parent").ObjectID){var parent=r.get("Parent").ObjectID;this.data[parent].addChild(r.getData()),console.log(this.data[parent].children.length)}var obj_id=r.get("ObjectID");this.data[obj_id]=this._getDataObj(r.getData(),portfolioItemType)},this);var obj_ids=_.map(records,function(r){return r.get("ObjectID")});return records.length>0&&child_model_type?this._fetchChildPortfolioItems(child_model_type,obj_ids):this._fetchTopLevelUserStories(obj_ids)}})},_fetchTopLevelUserStories:function(portfolioItemObjectIDs){var deferred=Ext.create("Deft.Deferred");0===portfolioItemObjectIDs.length&&deferred.resolve();var filters=_.map(portfolioItemObjectIDs,function(pi_oid){return{property:"PortfolioItem.ObjectID",value:pi_oid}});filters=Rally.data.wsapi.Filter.or(filters);var storyFetch=PortfolioItemCostTracking.CostCalculator.getStoryFetch();return console.log("storyFetch",storyFetch),PortfolioItemCostTracking.WsapiToolbox.fetchWsapiRecords("HierarchicalRequirement",filters,storyFetch,{project:null}).then({scope:this,success:function(records){_.each(records,function(r){if(r.get("PortfolioItem")&&r.get("PortfolioItem").ObjectID){var obj_id=r.get("PortfolioItem").ObjectID;this.data[obj_id].addChild(r.getData()),console.log("adding children",this.data[obj_id].children.length),this.data[r.get("ObjectID")]=this._getDataObj(r.getData(),r.get("_type"))}},this),console.log("data",this.data),deferred.resolve()},failure:function(operation){console.log("_fetchTopLevelUserStories failed",operation),deferred.reject(operation)}}),deferred},_fetchChildStories:function(){},_fetchTasks:function(storyIDs){var fetch=["ObjectID","TimeSpent","ToDo","Actuals","Estimate"]}});
                Ext.define("PortfolioItemCostTracking.RollupDataItem",{children:void 0,type:void 0,preliminaryBudget:null,actualCost:0,remainingCost:0,tooltip:void 0,data:void 0,constructor:function(config){this.data=config.data,this.type=config.type,this.data.PreliminaryEstimate&&this.data.PreliminaryEstimate.Value&&(this.preliminaryBudget=this.data.PreliminaryEstimate.Value*PortfolioItemCostTracking.CostCalculator.getCostPerUnit(this.data.Project._ref)),"hierarchicalrequirement"===this.type.toLowerCase()&&(this.actualCost=PortfolioItemCostTracking.CostCalculator.calculateActualCostForStory(this.data),this.remainingCost=PortfolioItemCostTracking.CostCalculator.calculateTotalCostForStory(this.data)-this.actualCost)},addChild:function(child){this.children||(this.children=[]),this.children.push(child)},calculateRollupFromChildren:function(){var actual_value=0,total_value=0;_.each(this.children,function(s){total_value+=PortfolioItemCostTracking.CostCalculator.calculateTotalCostForStory(s),actual_value+=PortfolioItemCostTracking.CostCalculator.calculateActualCostForStory(s)},this),this.actualCost=actual_value,this.remainingCost=total_value-actual_value}});
                Ext.define("ProjectPickerDialog",{extend:"Rally.ui.dialog.Dialog",alias:"widget.projectpickerdialog",height:400,width:600,layout:"fit",closable:!0,draggable:!0,config:{title:"Choose an Item",multiple:!0,storeConfig:{context:{project:null},sorters:[{property:"FormattedID",direction:"DESC"}]},columns:[{text:"ID",dataIndex:"ObjectID",renderer:_.identity},"Name"],selectionButtonText:"Done",gridConfig:{},selectedRef:void 0,selectedRecords:void 0,initialSelectedRecords:void 0,showRadioButtons:!0},constructor:function(config){this.mergeConfig(config),this.callParent([this.config])},selectionCache:[],initComponent:function(){this.callParent(arguments),this.addEvents("itemschosen"),this.addCls(["chooserDialog","chooser-dialog"])},destroy:function(){this.callParent(arguments)},beforeRender:function(){this.callParent(arguments),this.addDocked({xtype:"toolbar",dock:"bottom",padding:"0 0 10 0",layout:{type:"hbox",pack:"center"},ui:"footer",items:[{xtype:"rallybutton",itemId:"doneButton",text:this.selectionButtonText,cls:"primary rly-small",scope:this,disabled:!0,userAction:"clicked done in dialog",handler:function(){this.fireEvent("itemschosen",this,this.getSelectedRecords()),this.close()}},{xtype:"rallybutton",text:"Cancel",cls:"secondary rly-small",handler:this.close,scope:this,ui:"link"}]}),this.introText&&this.addDocked({xtype:"component",componentCls:"intro-panel",html:this.introText}),this.addDocked({xtype:"toolbar",itemId:"searchBar",dock:"top",border:!1,padding:"0 0 10px 0",items:this.getSearchBarItems()}),this.buildGrid(),this.selectionCache=this.getInitialSelectedRecords()||[]},getSelectedRecords:function(){return this.multiple?this.selectionCache:this.selectionCache[0]},getSearchBarItems:function(){return[{xtype:"triggerfield",cls:"rui-triggerfield chooser-search-terms",emptyText:"Search Keyword or ID",enableKeyEvents:!0,flex:1,itemId:"searchTerms",listeners:{keyup:function(textField,event){event.getKey()===Ext.EventObject.ENTER&&this._search()},afterrender:function(field){field.focus()},scope:this},triggerBaseCls:"icon-search chooser-search-icon"}]},getStoreFilters:function(){return[]},buildGrid:function(){this.grid&&this.grid.destroy(),Ext.create("Rally.data.wsapi.ProjectTreeStoreBuilder").build({models:["project"],autoLoad:!0,enableHierarchy:!0,filters:[{property:"Parent",value:""}]}).then({scope:this,success:function(store){this.grid=this.add({xtype:"rallytreegrid",treeColumnDataIndex:"Name",treeColumnHeader:"Name",enableRanking:!1,enableBulkEdit:!1,shouldShowRowActionsColumn:!1,selType:"checkboxmodel",selModel:{injectCheckbox:0,mode:"MULTI"},_defaultTreeColumnRenderer:function(value,metaData,record,rowIdx,colIdx,store){return store=store.treeStore||store,Rally.ui.renderer.RendererFactory.getRenderTemplate(store.model.getField("Name")).apply(record.data)},columnCfgs:[],store:store}),this.mon(this.grid,{beforeselect:this._onGridSelect,beforedeselect:this._onGridDeselect,load:this._onGridLoad,scope:this}),this.add(this.grid),this._onGridReady()}})},_enableDoneButton:function(){this.down("#doneButton").setDisabled(this.selectionCache.length?!1:!0)},_findRecordInSelectionCache:function(record){return _.findIndex(this.selectionCache,function(cachedRecord){return cachedRecord.get("_ref")===record.get("_ref")})},_onGridSelect:function(selectionModel,record){var index=this._findRecordInSelectionCache(record);-1===index&&(this.multiple||(this.selectionCache=[]),this.selectionCache.push(record)),this._enableDoneButton()},_onGridDeselect:function(selectionModel,record){var index=this._findRecordInSelectionCache(record);-1!==index&&this.selectionCache.splice(index,1),this._enableDoneButton()},_onGridReady:function(){return this.grid.rendered?this.grid.getStore().isLoading()?(this.mon(this.grid,"load",this._onGridReady,this,{single:!0}),void 0):(this._onGridLoad(),this.center(),void 0):(this.mon(this.grid,"afterrender",this._onGridReady,this,{single:!0}),void 0)},_onGridLoad:function(){var store=this.grid.store,records=[];_.each(this.selectionCache,function(record){var foundNode=store.getRootNode().findChild("_ref",record.get("_ref"),!0);foundNode&&records.push(foundNode)}),records.length&&this.grid.getSelectionModel().select(records)},_search:function(){var terms=this._getSearchTerms(),store=this.grid.getStore();terms?store.filter([Ext.create("Rally.data.wsapi.Filter",{property:"Name",operator:"contains",value:terms})]):store.clearFilter()},_getSearchTerms:function(){var textBox=this.down("#searchTerms");return textBox&&textBox.getValue()}}),Ext.override(Rally.data.wsapi.ParentChildMapper,{constructor:function(){this.parentChildTypeMap={project:[{typePath:"project",collectionName:"Children",parentField:"Parent"}],hierarchicalrequirement:[{typePath:"defect",collectionName:"Defects",parentField:"Requirement"},{typePath:"task",collectionName:"Tasks",parentField:"WorkProduct"},{typePath:"testcase",collectionName:"TestCases",parentField:"WorkProduct"},{typePath:"hierarchicalrequirement",collectionName:"Children",parentField:"Parent"}],defect:[{typePath:"task",collectionName:"Tasks",parentField:"WorkProduct"},{typePath:"testcase",collectionName:"TestCases",parentField:"WorkProduct"}],defectsuite:[{typePath:"defect",collectionName:"Defects",parentField:"DefectSuites"},{typePath:"task",collectionName:"Tasks",parentField:"WorkProduct"},{typePath:"testcase",collectionName:"TestCases",parentField:"WorkProduct"}],testset:[{typePath:"task",collectionName:"Tasks",parentField:"WorkProduct"},{typePath:"testcase",collectionName:"TestCases",parentField:"TestSets"}]}}}),Ext.define("Rally.data.wsapi.ProjectTreeStore",{requires:["Deft.promise.Deferred","Rally.data.ModelFactory","Rally.ui.grid.data.NodeInterface","Rally.data.ModelTypes","Rally.data.wsapi.ParentChildMapper"],extend:"Rally.data.wsapi.TreeStore",alias:"store.rallyprojectwsapitreestore",parentTypes:["project"],childLevelSorters:[{property:"Name",direction:"ASC"}],getParentFieldNamesByChildType:function(childType,parentType){var model=this.model;return _.transform(this.mapper.getParentFields(childType,parentType),function(acc,field){var typePath=field.typePath,fieldName=field.fieldName,hasFieldModel=model.hasField(fieldName);hasFieldModel&&acc.push(fieldName.replace(/\s+/g,""))},[],this)},filter:function(filters){this.fireEvent("beforefilter",this),this.filters.clear(),this.filters.addAll(filters),this._resetCurrentPage(),this.load()},clearFilter:function(suppressEvent){this._resetCurrentPage(),this.filters.clear(),this.filters.addAll(Ext.create("Rally.data.wsapi.Filter",{property:"Parent",value:""})),suppressEvent||this.load()}}),Ext.define("Rally.data.wsapi.ProjectTreeStoreBuilder",{extend:"Rally.data.wsapi.TreeStoreBuilder",build:function(config){return config=_.clone(config||{}),config.storeType="Rally.data.wsapi.ProjectTreeStore",this.loadModels(config).then({success:function(models){return models=_.values(models),this._buildStoreWithModels(models,config)},scope:this})}});

            Rally.launchApp('PortfolioItemCostTracking', {
                name:"portfolio-item-cost-tracking",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .lbl{text-transform:uppercase;font-family:ProximaNovaSemiBold, Helvetica, Arial;font-size:10px}
    </style>
</head>
<body>
</body>
</html>
