<!DOCTYPE html>
<html>
<head>
    <title>Portfolio Item Cost Tracking</title>

    <script type="text/javascript" src="/apps/x/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("Rally.apps.common.PortfolioItemsGridBoardApp",{extend:"Rally.app.GridBoardApp",requires:["Rally.ui.cardboard.plugin.CollapsibleColumns","Rally.ui.cardboard.plugin.FixedHeader"],constructor:function(config){var defaultConfig={piTypePickerConfig:{renderInGridHeader:!1}};this.callParent([Ext.Object.merge(defaultConfig,config)])},initComponent:function(){this.callParent(arguments),this.addCls("portfolio-items-grid-board-app")},addGridBoard:function(){if(this.gridboard&&this.piTypePicker&&this.piTypePicker.rendered){var parent=this.piTypePicker.up();parent&&parent.remove&&parent.remove(this.piTypePicker,!1)}this.callParent(arguments)},launch:function(){Rally.environment.getContext().getSubscription().isModuleEnabled("Rally Portfolio Manager")?this.callParent(arguments):(this.add({xtype:"container",html:'<div class="rpm-turned-off" style="padding: 50px; text-align: center;">You do not have RPM enabled for your subscription</div>'}),this.publishComponentReady())},loadModelNames:function(){return this._createPITypePicker().then({success:function(selectedType){return this.currentType=selectedType,[selectedType.get("TypePath")]},scope:this})},getFilterControlConfig:function(){return{blackListFields:["PortfolioItemType"],whiteListFields:["Milestones"]}},getFieldPickerConfig:function(){return _.merge(this.callParent(arguments),{boardFieldBlackList:["Predecessors","Successors"],margin:"3 9 14 0"})},getCardBoardColumns:function(){return this._getStates().then({success:function(states){return this._buildColumns(states)},scope:this})},_buildColumns:function(states){if(!states.length)return void 0;var columns=[{columnHeaderConfig:{headerTpl:"No Entry"},value:null,plugins:["rallycardboardcollapsiblecolumns"].concat(this.getCardBoardColumnPlugins(null))}];return columns.concat(_.map(states,function(state){return{value:state.get("_ref"),wipLimit:state.get("WIPLimit"),enableWipLimit:!0,columnHeaderConfig:{record:state,fieldToDisplay:"Name",editable:!1},plugins:["rallycardboardcollapsiblecolumns"].concat(this.getCardBoardColumnPlugins(state))}},this))},_getStates:function(){var deferred=new Deft.Deferred;return Ext.create("Rally.data.wsapi.Store",{model:Ext.identityFn("State"),context:this.getContext().getDataContext(),autoLoad:!0,fetch:["Name","WIPLimit","Description"],filters:[{property:"TypeDef",value:this.currentType.get("_ref")},{property:"Enabled",value:!0}],sorters:[{property:"OrderIndex",direction:"ASC"}],listeners:{load:function(store,records){deferred.resolve(records)}}}),deferred.promise},getCardBoardColumnPlugins:function(state){return[]},getCardConfig:function(){return{}},getCardBoardConfig:function(options){options=options||{};var currentTypePath=this.currentType.get("TypePath"),filters=[];if(this.getSetting("query"))try{filters.push(Rally.data.QueryFilter.fromQueryString(this.getSetting("query")))}catch(e){Rally.ui.notify.Notifier.showError({message:e.message})}return{attribute:"State",cardConfig:_.merge({editable:!0,showColorIcon:!0},this.getCardConfig()),columnConfig:{xtype:"rallycardboardcolumn",enableWipLimit:!0,fields:(this.getSetting("fields")||"").split(",")},columns:options.columns,ddGroup:currentTypePath,listeners:{load:this.publishComponentReady,cardupdated:this._publishContentUpdatedNoDashboardLayout,scope:this},plugins:[{ptype:"rallyfixedheadercardboard"}],storeConfig:{filters:filters,context:this.getContext().getDataContext()}}},getGridStoreConfig:function(){return _.merge({},this.gridStoreConfig,{models:this.piTypePicker.getAllTypeNames()})},_createPITypePicker:function(){this.piTypePicker&&this.piTypePicker.destroy&&this.piTypePicker.destroy();var deferred=new Deft.Deferred,piTypePickerConfig={preferenceName:this.getStateId("typepicker"),fieldLabel:"",labelWidth:0,value:this.getSetting("type"),context:this.getContext(),listeners:{change:this._onTypeChange,ready:{fn:function(picker){deferred.resolve(picker.getSelectedType())},single:!0},scope:this}};return this.config.piTypePickerConfig.renderInGridHeader||(piTypePickerConfig.renderTo=Ext.query("#content .titlebar .dashboard-timebox-container")[0]),this.piTypePicker=Ext.create("Rally.ui.combobox.PortfolioItemTypeComboBox",piTypePickerConfig),this.config.piTypePickerConfig.renderInGridHeader&&this.on("gridboardadded",function(){var headerContainer=this.gridboard.getHeader().getLeft();headerContainer.add(this.piTypePicker)}),deferred.promise},_onTypeChange:function(picker){var newType=picker.getSelectedType();this._pickerTypeChanged(picker)&&(this.currentType=newType,this.modelNames=[newType.get("TypePath")],this.gridboard.fireEvent("modeltypeschange",this.gridboard,[newType]))},_pickerTypeChanged:function(picker){var newType=picker.getSelectedType();return newType&&this.currentType&&newType.get("_ref")!==this.currentType.get("_ref")},_publishContentUpdatedNoDashboardLayout:function(){this.fireEvent("contentupdated",{dashboardLayout:!1})},onDestroy:function(){this.callParent(arguments),this.piTypePicker&&(this.piTypePicker.destroy(),delete this.piTypePicker)}})})();
                Ext.define("Rally.apps.portfolioitemcosttracking.CostPerProjectSettings",{extend:"Ext.form.field.Base",alias:"widget.costperprojectsettings",fieldSubTpl:'<div id="{id}" class="settings-grid"></div>',width:"100%",cls:"column-settings",store:void 0,onDestroy:function(){this._grid&&(this._grid.destroy(),delete this._grid),this.callParent(arguments)},initComponent:function(){this.callParent(),this.addEvents("ready");var store=Ext.create("Rally.data.wsapi.Store",{model:Ext.identityFn("Project"),fetch:["Name"],context:{project:null},limit:"Infinity"});store.load({scope:this,callback:this._buildProjectGrid})},_buildProjectGrid:function(records,operation,success){var decodedValue={};this.initialConfig&&this.initialConfig.value&&!_.isEmpty(this.initialConfig.value)&&(decodedValue=Ext.isObject(this.initialConfig.value)?this.initialConfig.value:Ext.JSON.decode(this.initialConfig.value));var data=[],empty_text="No exceptions";success?_.each(records,function(project){var cost=decodedValue[project.get("_ref")]||null;cost&&data.push({projectRef:project.get("_ref"),projectName:project.get("Name"),cost:cost})}):empty_text="Error(s) fetching Project data: <br/>"+operation.error.errors.join("<br/>");var custom_store=Ext.create("Ext.data.Store",{fields:["projectRef","projectName","cost"],data:data});this._grid=Ext.create("Rally.ui.grid.Grid",{autoWidth:!0,renderTo:this.inputEl,columnCfgs:this._getColumnCfgs(),showPagingToolbar:!1,store:custom_store,maxHeight:300,margin:"20 0 0 0",emptyText:empty_text,editingConfig:{publishMessages:!1}});var width=Math.max(this.inputEl.getWidth(!0),300);Ext.create("Rally.ui.Button",{text:"Select Projects",renderTo:this.inputEl,margin:"10 0 0 0",listeners:{scope:this,click:function(){Ext.create("Rally.apps.portfolioitemcosttracking.ProjectPickerDialog",{autoShow:!0,maxHeight:400,maxWidth:400,width:Math.min(width,400),title:"Choose Project",selectedRefs:_.pluck(data,"projectRef"),listeners:{scope:this,itemschosen:function(items){var new_data=[],store=this._grid.getStore();_.each(items,function(item){store.findRecord("projectRef",item.get("_ref"))||new_data.push({projectRef:item.get("_ref"),projectName:item.get("Name"),cost:null})}),this._grid.getStore().add(new_data)}}})}}}),this.fireEvent("ready",!0)},_removeProject:function(){this.grid.getStore().remove(this.record)},_getColumnCfgs:function(){var me=this,columns=[{xtype:"rallyrowactioncolumn",scope:this,rowActionsFn:function(record){return[{text:"Remove",record:record,handler:me._removeProject,grid:me._grid}]},_renderGearIcon:function(value,metaData,record){return'<div class="row-action-icon icon-gear"/>'}},{text:"Project",dataIndex:"projectRef",flex:1,editor:!1,renderer:function(v,m,r){return r.get("projectName")},getSortParam:function(v,m,r){return"projectName"}},{text:"Cost Per Unit",dataIndex:"cost",editor:{xtype:"rallynumberfield"},renderer:function(v){return v&&v>0?v:"Use Default"}}];return columns},getSubmitData:function(){var data={};return data[this.name]=Ext.JSON.encode(this._buildSettingValue()),data},_buildSettingValue:function(){var mappings={},store=this._grid.getStore();return store.each(function(record){record.get("cost")&&record.get("projectRef")&&(mappings[record.get("projectRef")]=record.get("cost"))},this),mappings},getErrors:function(){var errors=[];return errors},setValue:function(value){this.callParent(arguments),this._value=value}});
                Ext.define("Rally.apps.portfolioitemcosttracking.CostTemplateColumn",{extend:"Ext.grid.column.Template",alias:["widget.costtemplatecolumn"],align:"right",initComponent:function(){var me=this;Ext.QuickTips.init(),me.tpl=new Ext.XTemplate('<tpl><div data-qtip="{[this.getTooltip(values)]}" style="cursor:pointer;text-align:right;">{[this.getCost(values)]}</div></tpl>',{costField:me.costField,getCost:function(values){if(null===values[this.costField])return Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.notAvailableText;var html=Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.formatCost(values[this.costField]||0);return values._notEstimated&&"_rollupDataTotalCost"===this.costField&&(html='<span class="picto icon-warning warning" style="color:#FAD200;font-size:10px;"></span>'+html),html},getTooltip:function(values){return values._rollupDataToolTip?values._rollupDataToolTip:""}}),me.hasCustomRenderer=!0,me.callParent(arguments)},getValue:function(){return values[this.costField]||0},defaultRenderer:function(value,meta,record){var data=Ext.apply({},record.data._rollupData);return this.tpl.apply(data)}});
                Ext.define("Rally.apps.portfolioitemcosttracking.Exporter",{mixins:{observable:"Ext.util.Observable"},constructor:function(config){this.mixins.observable.constructor.call(this,config)},saveCSVToFile:function(csv,file_name,type_object){void 0===type_object&&(type_object={type:"text/csv;charset=utf-8"}),this.saveAs(csv,file_name,type_object)},saveAs:function(textToWrite,fileName){if(Ext.isIE9m)return Rally.ui.notify.Notifier.showWarning({message:"Export is not supported for IE9 and below."}),void 0;var textFileAsBlob=null;try{textFileAsBlob=new Blob([textToWrite],{type:"text/plain"})}catch(e){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,window.BlobBuilder&&"TypeError"===e.name&&(bb=new BlobBuilder,bb.append([textToWrite]),textFileAsBlob=bb.getBlob("text/plain"))}if(!textFileAsBlob)return Rally.ui.notify.Notifier.showWarning({message:"Export is not supported for this browser."}),void 0;var fileNameToSaveAs=fileName;if(Ext.isIE10p)return window.navigator.msSaveOrOpenBlob(textFileAsBlob,fileNameToSaveAs),void 0;var url=this.createObjectURL(textFileAsBlob);if(url){var downloadLink=document.createElement("a");"download"in downloadLink?downloadLink.download=fileNameToSaveAs:downloadLink.target="_blank",downloadLink.innerHTML="Download File",downloadLink.href=url,Ext.isChrome||(downloadLink.onclick=this.destroyClickedElement,downloadLink.style.display="none",document.body.appendChild(downloadLink)),downloadLink.click()}else Rally.ui.notify.Notifier.showError({message:"Export is not supported "})},createObjectURL:function(file){return window.webkitURL?window.webkitURL.createObjectURL(file):window.URL&&window.URL.createObjectURL?window.URL.createObjectURL(file):null},destroyClickedElement:function(event){document.body.removeChild(event.target)},fetchExportData:function(rootModel,rootFilters,fetch,columns){var deferred=Ext.create("Deft.Deferred"),rootFetch=Ext.Array.merge(fetch,Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.getPortfolioItemFetch()),me=this,loader=Ext.create("Rally.apps.portfolioitemcosttracking.RollupDataLoader",{portfolioItemTypes:Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.getPortfolioItemTypes(),featureName:Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.getFeatureName(),listeners:{rollupdataloaded:function(portfolioHash,stories){var rollupData=Ext.create("Rally.apps.portfolioitemcosttracking.RollupCalculator",{portfolioItemType:rootModel});rollupData.addRollupRecords(portfolioHash,stories);var exportData=me._getExportableRollupData(portfolioHash[rootModel.toLowerCase()],columns,rollupData);columns=me._getAncestorTypeColumns(rootModel).concat(columns);var csv=me._transformExportableRollupDataToDelimitedString(exportData,columns);this.fireEvent("statusupdate",null),deferred.resolve(csv)},loaderror:function(msg){deferred.reject(msg)},statusupdate:function(status){this.fireEvent("statusupdate",status)},scope:this}});return loader.loadTree({model:rootModel,fetch:rootFetch,filters:rootFilters||[]}),deferred},_transformExportableRollupDataToDelimitedString:function(rollupData,columns){var csvArray=[],delimiter=",",rowDelimiter="\r\n",re=RegExp(delimiter+'|"|\r|\n',"g"),column_keys=_.map(columns,function(c){return c.costField||c.dataIndex}),column_headers=_.pluck(columns,"text");return csvArray.push(column_headers.join(delimiter)),Ext.Array.each(rollupData,function(obj){var data=[];Ext.Array.each(column_keys,function(key){var val=obj[key];val&&re.test(val)&&(val=val.replace('"','""'),val=Ext.String.format('"{0}"',val)),data.push(val)}),csvArray.push(data.join(delimiter))}),csvArray.join(rowDelimiter)},_getExportableRollupData:function(records,columns,rollupData){var exportData=[],me=this;return _.each(records,function(r){var obj=rollupData.getRollupData(r);if(obj){var ancestors={},rec=obj.getExportRow(columns,ancestors);exportData.push(rec),me._addExportChildren(obj,exportData,columns,rollupData,ancestors)}},this),exportData},_addExportChildren:function(obj,exportData,columns,rollupData,ancestors){var new_ancestors=Ext.clone(ancestors),me=this;new_ancestors[obj._type]=obj.FormattedID;var children=obj.children;children&&children.length>0&&_.each(children,function(c){var row=c.getExportRow(columns,new_ancestors);exportData.push(row),me._addExportChildren(c,exportData,columns,rollupData,new_ancestors)},this)},_getAncestorTypeColumns:function(rootModel){var piTypes=Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.getPortfolioItemTypeObjects(),piIdx=-1;Ext.Array.each(piTypes,function(piObj,idx){piObj.typePath.toLowerCase()===rootModel.toLowerCase()&&(piIdx=idx)});var columns=[{dataIndex:"hierarchicalrequirement",text:"User Story"}];return piIdx>=0&&(columns=columns.concat(Ext.Array.map(piTypes.slice(0,piIdx+1),function(piObj){return{dataIndex:piObj.typePath.toLowerCase(),text:piObj.name}})),columns.push({dataIndex:"type",text:"Artifact Type"}),columns.reverse()),columns},fetchWsapiRecords:function(model,query_filters,fetch_fields,context){var deferred=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:model,fetch:fetch_fields,filters:query_filters,context:context,limit:1/0}).load({callback:function(records,operation,success){success?deferred.resolve(records):deferred.reject(Ext.String.format("Error getting {0} for {1}: {2}",model,""+query_filters,operation.error.errors.join(",")))}}),deferred}});
                Ext.define("Rally.apps.portfolioitemcosttracking.RollupItem",{_rollupDataPreliminaryBudget:void 0,_rollupDataTotalCost:void 0,_rollupDataActualCost:void 0,_rollupDataRemainingCost:void 0,_rollupDataToolTip:null,_notEstimated:!0,children:void 0,projectCosts:void 0,useBudgetCalc:!1,constructor:function(record){this._rollupDataTotalCost=0,this._rollupDataActualCost=0,this.parent=record.get("Parent")&&record.get("Parent").ObjectID||null,this.objectID=record.get("ObjectID"),this._rollupDataPreliminaryBudget=this._calculatePreliminaryBudget(record.getData()),this._rollupDataTotalCost=this.getPreliminaryBudget()||0,this._rollupDataToolTip=this.getTooltip(),this._rollupDataRemainingCost=this.getRemainingCostRollup(),Ext.apply(this,record.getData())},addChild:function(objectID){this.children||(this.children=[]),this.children.push(objectID)},getExportRow:function(columns,ancestors){var rec=Ext.clone(ancestors);return rec[this._type]=this.FormattedID,rec.type=Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.getTypePathDisplayName(this._type),_.each(columns,function(c){var field=c.costField||c.dataIndex||null;if(field){var data=this[field];rec[field]=Ext.isObject(data)?data._refObjectName:Ext.isDate(data)?Rally.util.DateTime.formatWithDefaultDateTime(data):data}},this),rec},_calculatePreliminaryBudget:function(data){var preliminaryBudgetField=Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.preliminaryBudgetField;if(data&&data[preliminaryBudgetField]){var val=data[preliminaryBudgetField].Value||data[preliminaryBudgetField],cpu=Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.getCostPerUnit(data.Project._ref);return cpu*val}return null},getTooltip:function(){var completed=Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.notAvailableText;this.__actualUnits>=0&&this.__totalUnits>=0&&(completed=Ext.String.format("{0}/{1}",this.__actualUnits,this.__totalUnits));var calc_type_name=Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.getCalculationTypeDisplayName(),html=Ext.String.format("{0} completed {1}<br/>",calc_type_name,completed);return this.projectCosts&&(html+="<br/>Cost per unit:<br/>",_.each(this.projectCosts,function(project_cost,project_name){html+=Ext.String.format("{0} {1}<br/>",Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.formatCost(project_cost),project_name)})),this._notEstimated&&(html+="<br/><p>Portfolio Item has missing "+calc_type_name+".  Preliminary Budget is being used to calculate Projected and Remaining costs.</p>"),html},getTotalCostRollup:function(){return this._notEstimated?this.getActualCostRollup()+this.getRemainingCostRollup():this._rollupDataTotalCost},getActualCostRollup:function(){return this._rollupDataActualCost},getRemainingCostRollup:function(){return this._notEstimated?Math.max(this.getPreliminaryBudget()||0-this.getActualCostRollup(),0):this._rollupDataRemainingCost},getPreliminaryBudget:function(){return this._rollupDataPreliminaryBudget}});
                Ext.define("Rally.apps.portfolioitemcosttracking.LowestLevelPortfolioRollupItem",{extend:"Rally.apps.portfolioitemcosttracking.RollupItem",processChildren:function(){this._rollupDataToolTip=this.getTooltip(),this._notEstimated&&this.getPreliminaryBudget()>this.getActualCostRollup()?(this._rollupDataRemainingCost=this.getPreliminaryBudget()-this.getActualCostRollup(),this._rollupDataTotalCost=this._rollupDataActualCost+this._rollupDataRemainingCost):this._rollupDataRemainingCost=this._rollupDataTotalCost-this._rollupDataActualCost},addChild:function(child){this.children||(this.children=[],this._rollupDataTotalCost=0,this._rollupDataActualCost=0,this._rollupDataRemainingCost=0,this.__totalUnits=0,this.__actualUnits=0),this.children.push(child),this.__totalUnits+=child.__totalUnits||0,this.__actualUnits+=child.__actualUnits||0,this._notEstimated=0===this.__totalUnits,this._rollupDataActualCost+=child._rollupDataActualCost,this._rollupDataTotalCost+=child._rollupDataTotalCost,this._rollupDataRemainingCost=this._rollupDataTotalCost-this._rollupDataActualCost,this.projectCosts&&this.projectCosts[child.Project._ref]||(this.projectCosts=this._updateProjectNameAndCostHash(this.projectCosts,child.Project))},_updateProjectNameAndCostHash:function(projectCosts,project){projectCosts=projectCosts||{};var name=project._refObjectName,cost=Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.getCostPerUnit(project._ref);return Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.isProjectUsingNormalizedCost(project._ref)&&(name="normalized (default)"),projectCosts[name]=cost,projectCosts}});
                Ext.define("Rally.apps.portfolioitemcosttracking.NumberFieldComboBox",{requires:[],extend:"Rally.ui.combobox.FieldComboBox",alias:"widget.numberfieldcombobox",_isNotHidden:function(field){var validFields=["PreliminaryEstimate","RefinedEstimate"],allowCustomNumberFields=!1;if(!field.hidden){if(Ext.Array.contains(validFields,field.name))return!0;if(allowCustomNumberFields&&field.custom&&field.attributeDefinition)return"INTEGER"===field.attributeDefinition.AttributeType||"DECIMAL"===field.attributeDefinition.AttributeType}return!1}});
                Ext.define("Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingApp",{extend:"Rally.apps.common.PortfolioItemsGridBoardApp",printHeaderLabel:"Portfolio Items",statePrefix:"portfolio-tree",componentCls:"app",config:{defaultSettings:{piTypePickerConfig:{renderInGridHeader:!0},selectedCalculationType:"points",normalizedCostPerUnit:1e3,projectCostPerUnit:{},currencySign:"$",preliminaryBudgetField:"PreliminaryEstimate"}},toggleState:"grid",enableAddNew:!1,enableGridBoardToggle:!1,allowExpansionStateToBeSaved:!1,items:[],portfolioItemRollupData:{},launch:function(){this.callParent()},loadModelNames:function(){var promises=[this.fetchDoneStates(),this._createPITypePicker()];return Deft.Promise.all(promises).then({success:function(results){return this.currentType=results[1],this._initializeSettings(this.getSettings(),results[0],this.piTypePicker),this._initializeRollupData(this.currentType.get("TypePath")),[this.currentType.get("TypePath")]},scope:this})},_createPITypePicker:function(){this.piTypePicker&&this.piTypePicker.destroy&&this.piTypePicker.destroy();var deferred=new Deft.Deferred,piTypePickerConfig={preferenceName:this.getStateId("typepicker"),context:this.getContext(),listeners:{change:this._onTypeChange,ready:{fn:function(picker){deferred.resolve(picker.getSelectedType())},single:!0},scope:this}};return this.piTypePicker=Ext.create("Rally.ui.combobox.PortfolioItemTypeComboBox",piTypePickerConfig),this.on("gridboardadded",function(){var headerContainer=this.gridboard.getHeader().getLeft();headerContainer.add(this.piTypePicker)}),deferred.promise},getGridStoreConfig:function(){return this.gridStoreConfig||{}},getGridConfig:function(options){var customColumns=this.getDerivedColumns()||[],columnCfgs=Ext.Array.merge(this.getColumnCfgs()||[],customColumns),config={xtype:"rallytreegrid",alwaysShowDefaultColumns:!1,bufferedRenderer:!0,columnCfgs:columnCfgs,derivedColumns:customColumns,enableBulkEdit:!0,allowExpansionStateToBeSaved:this.allowExpansionStateToBeSaved,enableInlineAdd:Rally.data.ModelTypes.areArtifacts(this.modelNames),enableRanking:!1,enableSummaryRow:Rally.data.ModelTypes.areArtifacts(this.modelNames),expandAllInColumnHeaderEnabled:!0,plugins:this.getGridPlugins(),stateId:this.getScopedStateId("portfolio-cost-tracking-grid"),stateful:!1,store:options&&options.gridStore,storeConfig:{filters:this.getPermanentFilters()}};1!==this.modelNames.length||Rally.data.ModelTypes.isArtifact(this.modelNames[0])||(config.noDataItemName=this.modelNames[0].toLowerCase());var cols=_.merge(config,this.gridConfig);return cols},_initializeRollupData:function(newType){this.rollupData&&this.rollupData.destroy(),this.rollupData=Ext.create("Rally.apps.portfolioitemcosttracking.RollupCalculator",{portfolioItemType:newType})},_initializePortfolioItemTypes:function(cb){var items=cb.getStore().data.items,portfolioItemTypes=Array(items.length);Ext.Array.each(items,function(item){var idx=Number(item.get("Ordinal"));portfolioItemTypes[idx]={typePath:item.get("TypePath"),name:item.get("Name"),ordinal:idx}}),Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.portfolioItemTypes=portfolioItemTypes},_onTypeChange:function(picker){var newType=picker.getSelectedType();this._pickerTypeChanged(picker)&&(this.currentType=newType,this.modelNames=[newType.get("TypePath")],this._initializeRollupData(newType.get("TypePath")),this.gridboard.fireEvent("modeltypeschange",this.gridboard,[newType]))},_initializeSettings:function(settings,doneScheduleStates,piTypePicker){Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.notAvailableText="--",Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.currencySign=settings.currencySign,Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.currencyPrecision=0,Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.currencyEnd=!1,doneScheduleStates&&(Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.completedScheduleStates=doneScheduleStates),Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.normalizedCostPerUnit=settings.normalizedCostPerUnit;var project_cpu=settings.projectCostPerUnit||{};Ext.isObject(project_cpu)||(project_cpu=Ext.JSON.decode(project_cpu)),Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.projectCostPerUnit=project_cpu,Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.preliminaryBudgetField=settings.preliminaryBudgetField,Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.setCalculationType(settings.selectedCalculationType),this._initializePortfolioItemTypes(piTypePicker)},_showExportMenu:function(){var columnCfgs=this.down("rallytreegrid").columnCfgs,additionalFields=_.filter(columnCfgs,function(c){return"rallyfieldcolumn"===c.xtype}),costFields=this.getDerivedColumns(),columns=Ext.Array.merge(additionalFields,costFields);additionalFields=_.pluck(additionalFields,"dataIndex");var filters=this.down("rallygridboard").currentCustomFilter.filters||[],fetch=Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.getTreeFetch(additionalFields),root_model=this.currentType.get("TypePath"),exporter=new Rally.apps.portfolioitemcosttracking.Exporter;exporter.on("statusupdate",this._showStatus,this),exporter.fetchExportData(root_model,filters,fetch,columns).then({scope:this,success:function(csv){var filename=Ext.String.format("export-{0}.csv",Ext.Date.format(new Date,"Y-m-d-h-i-s"));exporter.saveCSVToFile(csv,filename)},failure:function(msg){Rally.ui.notify.Notifier.showError({message:"An error occurred fetching the data to export:  "+msg})}})},_loadRollupData:function(records){var loader=Ext.create("Rally.apps.portfolioitemcosttracking.RollupDataLoader",{context:this.getContext(),portfolioItemTypes:Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.getPortfolioItemTypes(),featureName:Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.getFeatureName(),listeners:{rollupdataloaded:function(portfolioHash,stories){this._processRollupData(portfolioHash,stories,records)},loaderror:this._handleLoadError,statusupdate:this._showStatus,scope:this}});loader.loadDescendants(records)},_handleLoadError:function(msg){Rally.ui.notify.Notifier.showError({message:msg})},_processRollupData:function(portfolioHash,stories,records){var me=this;portfolioHash[records[0].get("_type").toLowerCase()]=records,this.rollupData.addRollupRecords(portfolioHash,stories),this.rollupData.updateModels(records),me._showStatus(null)},_showStatus:function(message){message?Rally.ui.notify.Notifier.showStatus({message:message,showForever:!0,closable:!1,animateShowHide:!1}):Rally.ui.notify.Notifier.hide()},_getExportItems:function(){return[{text:"Export to CSV...",handler:this._showExportMenu,scope:this}]},_getImportItems:function(){return[]},_getPrintItems:function(){return[]},_getTreeGridStore:function(){var fetch=Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.getTreeFetch([]);return Ext.create("Rally.data.wsapi.TreeStoreBuilder").build(_.merge({autoLoad:!1,childPageSizeEnabled:!0,context:this.getContext().getDataContext(),enableHierarchy:!0,fetch:_.union(["Workspace"],this.columnNames,fetch),models:_.clone(this.models),pageSize:25,remoteSort:!0,root:{expanded:!0}},this.getGridStoreConfig())).then({success:function(treeGridStore){return treeGridStore.model.addField({name:"_rollupData",type:"auto",defaultValue:null}),treeGridStore.on("load",this._fireTreeGridReady,this,{single:!0}),treeGridStore.on("load",this.updateDerivedColumns,this),{gridStore:treeGridStore}},scope:this})},updateDerivedColumns:function(store,node,records){store.model.getField("_rollupData")||store.model.addField({name:"_rollupData",type:"auto",defaultValue:null});var unloadedRecords=this.rollupData.updateModels(records);unloadedRecords&&unloadedRecords.length>0&&null===node.parentNode&&this._loadRollupData(unloadedRecords)},getDerivedColumns:function(){return[{text:"Actual Cost To Date",xtype:"costtemplatecolumn",dataIndex:"_rollupData",costField:"_rollupDataActualCost",sortable:!1,tooltip:Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.getHeaderTooltip("_rollupDataActualCost")},{text:"Remaining Cost",xtype:"costtemplatecolumn",dataIndex:"_rollupData",sortable:!1,costField:"_rollupDataRemainingCost",tooltip:Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.getHeaderTooltip("_rollupDataRemainingCost")},{text:"Total Projected",xtype:"costtemplatecolumn",dataIndex:"_rollupData",sortable:!1,costField:"_rollupDataTotalCost",tooltip:Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.getHeaderTooltip("_rollupDataTotalCost")},{text:"Preliminary Budget",xtype:"costtemplatecolumn",dataIndex:"_rollupData",sortable:!1,costField:"_rollupDataPreliminaryBudget",tooltip:Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.getHeaderTooltip("_rollupDataPreliminaryBudget")}]},getColumnCfgs:function(){return[{dataIndex:"Name",text:"Name",flex:5},{dataIndex:"Project",text:"Project",editor:!1},{dataIndex:"LeafStoryPlanEstimateTotal",text:"Plan Estimate Total"},{dataIndex:"PercentDoneByStoryPlanEstimate",text:"% Done by Story Points"}]},getSettingsFields:function(){return Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.getFields(this.getSettings())},onSettingsUpdate:function(settings){this._initializeSettings(settings,null,this.piTypePicker),this._initializeRollupData(this.currentType.get("TypePath")),this.loadGridBoard()},onDestroy:function(){this.callParent(arguments),this.rollupData&&delete this.rollupData},fetchDoneStates:function(){var deferred=Ext.create("Deft.Deferred");return Rally.data.ModelFactory.getModel({type:"HierarchicalRequirement",success:function(model){var field=model.getField("ScheduleState");field.getAllowedValueStore().load({callback:function(records,operation,success){if(success){for(var values=[],i=records.length-1;i>0;i--)values.push(records[i].get("StringValue")),"Accepted"===records[i].get("StringValue")&&(i=0);deferred.resolve(values)}else deferred.reject("Error loading ScheduleState values for User Story:  "+operation.error.errors.join(","))},scope:this})},failure:function(){var error="Could not load schedule states";deferred.reject(error)}}),deferred.promise}});
                Ext.define("Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings",{singleton:!0,selectedCalculationType:void 0,currencySign:"$",currencyPrecision:0,currencyEnd:!1,normalizedCostPerUnit:1,projectCostPerUnit:{},preliminaryBudgetField:"PreliminaryEstimate",tooltipActualCost:"actualcost ",tooltipTotalCost:"totalcost",tooltipRemainingCost:"remaining cost",tooltipPreliminaryBudget:"preliminary budget",calculationTypes:{points:{key:"points",label:"Based on Story Points",displayName:"Story Points",defaultColumns:["Name","Project","PlanEstimate","LeafStoryPlanEstimateTotal","AcceptedLeafStoryPlanEstimateTotal"],requiredStoryFetch:["ScheduleState","PortfolioItem","PlanEstimate"],requiredTaskFetch:[],tooltips:{_rollupDataActualCost:"Actual Cost is the sum of the Accepted Story Plan Estimates <i>for all stories in scope</i> * Cost Per Unit for the project that the top level story resides in.",_rollupDataRemainingCost:"Remaining Cost is the Total Projected Cost - Actual Cost",_rollupDataTotalCost:"Total Projected Cost is the sum of the Plan Estimate <i>for each story in scope</i>* Cost Per Unit for the project that the top level story resides in.  <br/><br/> If a Portfolio Item does not have any estimated stories and the Preliminary Budget is greater than the Portfolio Item's Actual Cost, then the Preliminary Budget will be used for the Total Projected Cost.",_rollupDataPreliminaryBudget:"The prelimary budget will be calculated by multiplying the value of the selected field by the Cost per Unit for the project of the portfolio item. <br/><br/> Note that for portfolio item types beyond the lowest level, this is calculated from the preliminary estimate of the portfolio item, not from the sum of the portfolio item children.  If the selected field value is null, then -- will be displayed."},actualUnitsForStoryFn:function(data){return data&&data.PlanEstimate&&Ext.Array.contains(Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.completedScheduleStates,data.ScheduleState)?data&&data.PlanEstimate||0:0},totalUnitsForStoryFn:function(data){return data&&data.PlanEstimate||0}},taskHours:{key:"taskHours",displayName:"Task Actuals",label:"Based on Task Actuals",defaultColumns:["Name","Project"],requiredStoryFetch:["ScheduleState","PortfolioItem","TaskEstimateTotal","TaskActualTotal","TaskRemainingTotal"],requiredTaskFetch:["ToDo","Actuals"],tooltips:{_rollupDataActualCost:"Actual Cost is the sum of the Task Actuals <i>for all stories in scope</i> * Cost Per Unit for the project that the top level story resides in.",_rollupDataRemainingCost:"Remaining Cost is the sum of the ToDo <i>for all stories in scope</i> * Cost Per Unit for the project that the top level story resides in.",_rollupDataTotalCost:"Total Projected Cost is the sum of the Task Estimate Total <i>for each story in scope</i> * Cost Per Unit for the project that the top level story resides in.  <br/><br/> If a Portfolio Item does not have any estimated stories and the Preliminary Budget is greater than the Portfolio Item's Actual Cost, then the Preliminary Budget will be used for the Total Projected Cost.",_rollupDataPreliminaryBudget:"The prelimary budget will be calculated by multiplying the value of the selected field by the Cost per Unit for the project of the portfolio item. <br/><br/> Note that for portfolio item types beyond the lowest level, this is calculated from the preliminary estimate of the portfolio item, not from the sum of the portfolio item children.  If the selected field value is null, then -- will be displayed."},actualUnitsForStoryFn:function(data){return data.TaskActualTotal||0},totalUnitsForStoryFn:function(data){return(data&&data.TaskActualTotal||0)+(data&&data.TaskRemainingTotal||0)},actualUnitsForTaskFn:function(data){return data&&data.Actuals||0},totalUnitsForTaskFn:function(data){return(data&&data.ToDo||0)+(data&&data.Actuals||0)}},timesheets:{key:"timesheets",displayName:"Time Spent",label:"Based on Timesheets",defaultColumns:["Name","Project"],requiredStoryFetch:[],requiredTaskFetch:[],disabled:!0,actualUnitsForStoryFn:function(data){return 0},actualUnitsForTaskFn:function(data){return 0},totalUnitsForStoryFn:function(data){return 0},totalUnitsForTaskFn:function(data){return 0}}},requiredPortfolioItemFetch:["UserStories"],requiredFetch:["ObjectID","FormattedID","Project","Parent","Children","Release","Name"],notAvailableText:"--",completedScheduleStates:[],portfolioItemTypes:[],currencyData:[{name:"US Dollars",value:"$"},{name:"Euro",value:"&#128;"},{name:"Japanese Yen",value:"&#165;"},{name:"Brazilian Real",value:"R$"},{name:"South African Rand",value:"R"}],getFeatureName:function(){return this.portfolioItemTypes[0].name.replace(/\s/g,"")},getHeaderTooltip:function(field){var settings=Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.getCalculationTypeSettings();return settings.tooltips[field]||null},setCalculationType:function(type){"taskHours"===type&&Rally.data.ModelFactory.getModel({type:"task",success:function(model){var field=model.getField("Actuals");field&&field.hidden&&Rally.ui.notify.Notifier.showWarning({message:"The Task Actuals field is not visible in the current project.  As a result, Task Actuals values may be 0."})}}),Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.selectedCalculationType=Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.calculationTypes[type]?type:"points"},getPortfolioItemTypeLevel:function(modelName){var idx=_.indexOf(Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.getPortfolioItemTypes(),modelName.toLowerCase());return idx},getRollupItemType:function(type){var idx=_.indexOf(Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.getPortfolioItemTypes(),type.toLowerCase());return idx>0?"Rally.apps.portfolioitemcosttracking.UpperLevelPortfolioRollupItem":0===idx?"Rally.apps.portfolioitemcosttracking.LowestLevelPortfolioRollupItem":null},getPortfolioItemTypes:function(){return _.map(this.portfolioItemTypes,function(p){return p.typePath.toLowerCase()})},getPortfolioItemTypeObjects:function(){return this.portfolioItemTypes},getTypePathDisplayName:function(piTypePath){if("hierarchicalrequirement"===piTypePath.toLowerCase())return"User Story";var piDisplayName="";return Ext.Array.each(this.portfolioItemTypes,function(p){return p.typePath.toLowerCase()===piTypePath.toLowerCase()?(piDisplayName=p.name,!1):void 0}),piDisplayName},getCalculationTypeSettings:function(){return Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.calculationTypes[Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.selectedCalculationType]||Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.calculationTypes.points},getCalculationTypeDisplayName:function(){return Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.getCalculationTypeSettings().displayName||"Unknown"},formatCost:function(cost){return Ext.util.Format.currency(cost,Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.currencySign,Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.currencyPrecision,Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.currencyEnd)},getCostPerUnit:function(project_ref){return Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.projectCostPerUnit[project_ref]||Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.normalizedCostPerUnit},isProjectUsingNormalizedCost:function(project_ref){return Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.projectCostPerUnit[project_ref]?!1:!0},getTreeFetch:function(fetch){return fetch||(fetch=[]),Ext.Array.merge(fetch,Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.getStoryFetch(),Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.getPortfolioItemFetch(),Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.getCalculationTypeSettings().requiredTaskFetch||[])},getStoryFetch:function(fetch){return fetch||(fetch=[]),Ext.Array.merge(fetch,Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.requiredFetch,Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.getCalculationTypeSettings().requiredStoryFetch)},getPortfolioItemFetch:function(fetch){return fetch||(fetch=[]),Ext.Array.merge(Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.requiredFetch,Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings._getPreliminaryBudgetFields(),Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.requiredPortfolioItemFetch)},_getPreliminaryBudgetFields:function(){var preliminaryBudgetFields=[Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.preliminaryBudgetField];return"PreliminaryEstimate"===Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.preliminaryBudgetField&&preliminaryBudgetFields.push("Value"),preliminaryBudgetFields},getFields:function(config){var current_calculation_type=config&&config.selectedCalculationType||"points",current_project_costs=config&&config.projectCostPerUnit||{},currency_store=Ext.create("Rally.data.custom.Store",{data:Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.currencyData}),labelWidth=100,cost_items=[];return _.each(Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.calculationTypes,function(obj,key){cost_items.push({boxLabel:obj.label||key,name:"selectedCalculationType",inputValue:key,disabled:obj.disabled||!1,checked:key===current_calculation_type})}),[{xtype:"rallycombobox",name:"currencySign",store:currency_store,displayField:"name",valueField:"value",fieldLabel:"Currency",labelWidth:labelWidth,margin:"10 0 10 0"},{xtype:"numberfieldcombobox",name:"preliminaryBudgetField",fieldLabel:"Calculate Preliminary Budget using",model:"PortfolioItem",labelWidth:labelWidth,margin:"10 0 10 0"},{xtype:"radiogroup",fieldLabel:"Calculate Cost",columns:1,vertical:!0,labelWidth:labelWidth,margin:"10 0 10 0",items:cost_items},{xtype:"rallytextfield",name:"normalizedCostPerUnit",fieldLabel:"Normalized Cost Per Unit",labelWidth:labelWidth,width:200,value:config.normalizedCostPerUnit,margin:"25 0 0 0"},{xtype:"costperprojectsettings",name:"projectCostPerUnit",fieldLabel:"Optionally define costs per unit for individual teams (exceptions to the normalized cost)",labelAlign:"top",margin:"25 0 0 0",value:current_project_costs,readyEvent:"ready"}]}});
                Ext.define("Rally.apps.portfolioitemcosttracking.ProjectPickerDialog",{extend:"Rally.ui.dialog.Dialog",alias:"widget.projectpickerdialog",height:400,width:400,layout:"fit",closable:!0,draggable:!0,config:{title:"Choose an Item",multiple:!0,storeConfig:{context:{project:null},sorters:[{property:"FormattedID",direction:"DESC"}]},columns:[{text:"ID",dataIndex:"ObjectID",renderer:_.identity},"Name"],selectionButtonText:"Done",gridConfig:{},selectedRef:void 0,selectedRecords:void 0,initialSelectedRecords:void 0,showRadioButtons:!0},constructor:function(config){this.mergeConfig(config),this.callParent([this.config])},selectionCache:[],initComponent:function(){this.callParent(arguments),this.addEvents("itemschosen"),this.addCls(["chooserDialog","chooser-dialog"])},destroy:function(){this.callParent(arguments)},beforeRender:function(){this.callParent(arguments),this.addDocked({xtype:"toolbar",dock:"bottom",padding:"0 0 10 0",layout:{type:"hbox",pack:"center"},ui:"footer",items:[{xtype:"rallybutton",itemId:"doneButton",text:this.selectionButtonText,cls:"primary rly-small",scope:this,disabled:!0,userAction:"clicked done in dialog",handler:function(){this.fireEvent("itemschosen",this.getSelectedRecords()),this.close()}},{xtype:"rallybutton",text:"Cancel",cls:"secondary rly-small",handler:this.close,scope:this,ui:"link"}]}),this.introText&&this.addDocked({xtype:"component",componentCls:"intro-panel",html:this.introText}),this.addDocked({xtype:"toolbar",itemId:"searchBar",dock:"top",border:!1,padding:"0 0 10px 0",items:this.getSearchBarItems()}),this.buildGrid(),this.selectionCache=this.getInitialSelectedRecords()||[]},getSelectedRecords:function(){return this.multiple?this.selectionCache:this.selectionCache[0]},getSearchBarItems:function(){return[{xtype:"triggerfield",cls:"rui-triggerfield chooser-search-terms",emptyText:"Search Keyword or ID",enableKeyEvents:!0,flex:1,itemId:"searchTerms",listeners:{keyup:function(textField,event){event.getKey()===Ext.EventObject.ENTER&&this._search()},afterrender:function(field){field.focus()},scope:this},triggerBaseCls:"icon-search chooser-search-icon"}]},getStoreFilters:function(){return[]},_buildTreeStore:function(){return Ext.create("Rally.data.wsapi.ProjectTreeStoreBuilder").build({models:["project"],autoLoad:!0,enableHierarchy:!0,filters:[{property:"Parent",value:""}]})},buildGrid:function(){this.grid&&this.grid.destroy(),this._buildTreeStore().then({success:function(store){var mode=this.multiple?"MULTI":"SINGLE",checkbox_model=Ext.create("Rally.ui.selection.CheckboxModel",{mode:mode,enableKeyNav:!1,allowDeselect:!0});this.grid=this.add({xtype:"rallytreegrid",treeColumnDataIndex:"Name",treeColumnHeader:"Name",viewConfig:{cls:"grid-view-bulk-edit"},enableRanking:!1,enableEditing:!1,enableBulkEdit:!1,shouldShowRowActionsColumn:!1,showRowActionsColumn:!1,selModel:checkbox_model,_defaultTreeColumnRenderer:function(value,metaData,record,rowIdx,colIdx,store){return store=store.treeStore||store,Rally.ui.renderer.RendererFactory.getRenderTemplate(store.model.getField("Name")).apply(record.data)},columnCfgs:[],store:store}),this.mon(this.grid,{beforeselect:this._onGridSelect,beforedeselect:this._onGridDeselect,load:this._onGridLoad,scope:this}),this.add(this.grid),this._onGridReady()},failure:function(msg){},scope:this})},_enableDoneButton:function(){this.down("#doneButton").setDisabled(this.selectionCache.length?!1:!0)},_findRecordInSelectionCache:function(record){return _.findIndex(this.selectionCache,function(cachedRecord){return cachedRecord.get("_ref")===record.get("_ref")})},_onGridSelect:function(selectionModel,record){var index=this._findRecordInSelectionCache(record);-1===index&&(this.multiple||(this.selectionCache=[]),this.selectionCache.push(record)),this._enableDoneButton()},_onGridDeselect:function(selectionModel,record){var index=this._findRecordInSelectionCache(record);-1!==index&&this.selectionCache.splice(index,1),this._enableDoneButton()},_onGridReady:function(){return this.grid.rendered?this.grid.getStore().isLoading()?(this.mon(this.grid,"load",this._onGridReady,this,{single:!0}),void 0):(this._onGridLoad(),this.center(),void 0):(this.mon(this.grid,"afterrender",this._onGridReady,this,{single:!0}),void 0)},_onGridLoad:function(){var store=this.grid.store,records=[];_.each(this.selectionCache,function(record){var foundNode=store.getRootNode().findChild("_ref",record.get("_ref"),!0);foundNode&&records.push(foundNode)}),records.length&&this.grid.getSelectionModel().select(records)},_search:function(){var terms=this._getSearchTerms(),store=this.grid.getStore();terms?store.filter([Ext.create("Rally.data.wsapi.Filter",{property:"Name",operator:"contains",value:terms})]):store.clearFilter()},_getSearchTerms:function(){var textBox=this.down("#searchTerms");return textBox&&textBox.getValue()}}),Ext.override(Rally.data.wsapi.ParentChildMapper,{constructor:function(){this.parentChildTypeMap={project:[{typePath:"project",collectionName:"Children",parentField:"Parent"}],hierarchicalrequirement:[{typePath:"defect",collectionName:"Defects",parentField:"Requirement"},{typePath:"task",collectionName:"Tasks",parentField:"WorkProduct"},{typePath:"testcase",collectionName:"TestCases",parentField:"WorkProduct"},{typePath:"hierarchicalrequirement",collectionName:"Children",parentField:"Parent"}],defect:[{typePath:"task",collectionName:"Tasks",parentField:"WorkProduct"},{typePath:"testcase",collectionName:"TestCases",parentField:"WorkProduct"}],defectsuite:[{typePath:"defect",collectionName:"Defects",parentField:"DefectSuites"},{typePath:"task",collectionName:"Tasks",parentField:"WorkProduct"},{typePath:"testcase",collectionName:"TestCases",parentField:"WorkProduct"}],testset:[{typePath:"task",collectionName:"Tasks",parentField:"WorkProduct"},{typePath:"testcase",collectionName:"TestCases",parentField:"TestSets"}]}}}),Ext.define("Rally.data.wsapi.ProjectTreeStore",{requires:["Deft.promise.Deferred","Rally.data.ModelFactory","Rally.ui.grid.data.NodeInterface","Rally.data.ModelTypes","Rally.data.wsapi.ParentChildMapper"],extend:"Rally.data.wsapi.TreeStore",alias:"store.rallyprojectwsapitreestore",parentTypes:["project"],childLevelSorters:[{property:"Name",direction:"ASC"}],getParentFieldNamesByChildType:function(childType,parentType){var model=this.model;return _.transform(this.mapper.getParentFields(childType,parentType),function(acc,field){var fieldName=field.fieldName,hasFieldModel=model.hasField(fieldName);hasFieldModel&&acc.push(fieldName.replace(/\s+/g,""))},[],this)},filter:function(filters){this.fireEvent("beforefilter",this),this.filters.clear(),this.filters.addAll(filters),this._resetCurrentPage(),this.load()},clearFilter:function(suppressEvent){this._resetCurrentPage(),this.filters.clear(),this.filters.addAll(Ext.create("Rally.data.wsapi.Filter",{property:"Parent",value:""})),suppressEvent||this.load()},load:function(options){this.recordLoadBegin({description:"tree store load",component:this.requester}),this._hasErrors=!1,this.on("beforeload",function(store,operation){delete operation.id},this,{single:!0}),options=this._configureLoad(options),options.originalCallback=options.callback;var deferred=Ext.create("Deft.Deferred"),me=this;return options.callback=function(records,operation,success){me.dataLoaded=!0,me.isRootNode(options.node)&&operation.resultSet&&operation.resultSet.sums&&me.setSums(operation.resultSet.sums),me._pageIsEmpty(operation)?me._reloadEmptyPage(options).then({success:function(records){me._resolveLoadingRecords(deferred,records,options,operation,success)},failure:function(){me._rejectLoadingRecord(deferred,options,operation)}}):me._resolveLoadingRecords(deferred,records,options,operation,success)},this._isViewReady()&&this._beforeInitialLoad(options),this.callParent([options]),deferred.promise}}),Ext.define("Rally.data.wsapi.ProjectTreeStoreBuilder",{extend:"Rally.data.wsapi.TreeStoreBuilder",build:function(config){return config=_.clone(config||{}),config.storeType="Rally.data.wsapi.ProjectTreeStore",this.loadModels(config).then({success:function(models){return models=_.values(models),this._buildStoreWithModels(models,config)},scope:this})}});
                Ext.define("Rally.apps.portfolioitemcosttracking.UserStoryRollupItem",{extend:"Rally.apps.portfolioitemcosttracking.RollupItem",constructor:function(record,totalFn,actualFn){var data=record.data;if(record.getData&&record.getData()&&(data=record.getData()),data){this.__totalUnits=totalFn(data),this.__actualUnits=actualFn(data),this._notEstimated=!1;var costPerUnit=Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.getCostPerUnit(data.Project._ref);this._rollupDataTotalCost=this.__totalUnits*costPerUnit||0,this._rollupDataActualCost=this.__actualUnits*costPerUnit||0,this._rollupDataRemainingCost=this._rollupDataTotalCost-this._rollupDataActualCost,this.parent=record.get("PortfolioItem")&&record.get("PortfolioItem").ObjectID||null,this.objectID=data.ObjectID,this._rollupDataPreliminaryBudget=null,this._rollupDataToolTip=null,Ext.apply(this,data)}}});
                Ext.define("Rally.apps.portfolioitemcosttracking.UpperLevelPortfolioRollupItem",{extend:"Rally.apps.portfolioitemcosttracking.RollupItem",processChildren:function(){if(this.children&&this.children.length>0){for(var rollupDataTotal=0,rollupDataActual=0,rollupDataRemaining=0,totalUnitsSum=0,actualUnitsSum=0,projectCosts={},rollupItems=this.children||[],notEstimated=!0,i=0;rollupItems.length>i;i++){var item=rollupItems[i];item.processChildren(),rollupDataTotal+=item.getTotalCostRollup(),rollupDataActual+=item.getActualCostRollup(),rollupDataRemaining+=item.getRemainingCostRollup(),totalUnitsSum+=item.__totalUnits||0,actualUnitsSum+=item.__actualUnits||0,projectCosts=Ext.merge(projectCosts,item.projectCosts||{}),notEstimated=notEstimated&&item._notEstimated}this._notEstimated=notEstimated,this._rollupDataTotalCost=rollupDataTotal,this._rollupDataActualCost=rollupDataActual,this._rollupDataRemainingCost=rollupDataRemaining,this.projectCosts=projectCosts,this.__totalUnits=totalUnitsSum,this.__actualUnits=actualUnitsSum,this._rollupDataToolTip=this.getTooltip()}}});
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("Rally.apps.portfolioitemcosttracking.RollupCalculator",{extend:"Ext.Base",requires:["Rally.apps.portfolioitemcosttracking.RollupItem","Rally.apps.portfolioitemcosttracking.UserStoryRollupItem","Rally.apps.portfolioitemcosttracking.LowestLevelPortfolioRollupItem","Rally.apps.portfolioitemcosttracking.UpperLevelPortfolioRollupItem"],mixins:{observable:"Ext.util.Observable"},rollupItems:void 0,constructor:function(config){this.mixins.observable.constructor.call(this,config),this.rollupItems={},this.portfolioItemType=config.portfolioItemType},addRollupRecords:function(portfolioItemRecordHash,stories){var portfolioItemTypes=Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.getPortfolioItemTypes();this.rootObjectIDs=[];for(var i=portfolioItemTypes.length-1;i>=0;i--){var portfolioRecords=portfolioItemRecordHash[portfolioItemTypes[i]]||[];this._addPortfolioRecords(portfolioRecords)}this._addStories(stories),this._calculatePortfolioItemRollups()},getRollupData:function(record){if(!record)return null;var objectID=record.ObjectID||record.get("ObjectID");return this.rollupItems[objectID]||null},_addPortfolioRecords:function(records){if(records&&0!==records.length){var type=records[0].get("_type").toLowerCase(),rollupItemType=Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.getRollupItemType(type),rootPortfolioItem=this.portfolioItemType.toLowerCase();if(rollupItemType)for(var i=0;records.length>i;i++){var r=records[i],oid=r.get("ObjectID"),parentObjectID=r.get("Parent")&&r.get("Parent").ObjectID,item=Ext.create(rollupItemType,r);this.rollupItems[oid]=item,parentObjectID&&this.rollupItems[parentObjectID]&&this.rollupItems[parentObjectID].addChild(item),type===rootPortfolioItem&&this.rootObjectIDs.push(oid)}}},_addStories:function(stories){for(var parents=[],totalFn=Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.getCalculationTypeSettings().totalUnitsForStoryFn,actualFn=Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.getCalculationTypeSettings().actualUnitsForStoryFn,i=0;stories.length>i;i++){var item=Ext.create("Rally.apps.portfolioitemcosttracking.UserStoryRollupItem",stories[i],totalFn,actualFn);this.rollupItems[item.ObjectID]=item,item.parent&&this.rollupItems[item.parent]&&(parents.push(item.parent),this.rollupItems[item.parent].addChild(item))}},_calculatePortfolioItemRollups:function(){for(var i=0;this.rootObjectIDs.length>i;i++){var item=this.rollupItems[this.rootObjectIDs[i]];item&&item._type.toLowerCase()===this.portfolioItemType.toLowerCase()&&item.processChildren()}},updateModels:function(records){records=records||[];for(var unloadedModels=[],rollupItems=this.rollupItems,i=0;records.length>i;i++){var r=records[i],rollupItem=rollupItems[r.get("ObjectID")]||null;rollupItem?r.set("_rollupData",rollupItem):unloadedModels.push(r)}return unloadedModels},destroy:function(){this.rollupItems={}}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("Rally.apps.portfolioitemcosttracking.RollupDataLoader",{storyModelName:"hierarchicalrequirement",mixins:{observable:"Ext.util.Observable"},model:void 0,filters:void 0,fetch:void 0,maxParallelCalls:6,maxListSize:50,constructor:function(config){this.mixins.observable.constructor.call(this,config),this.portfolioItemTypes=config.portfolioItemTypes||[]},loadTree:function(config){this.rootConfig=config,this.additionalFetch=config.fetch,this.load(config.model)},loadDescendants:function(rootRecords,additionalFetch){if(this.rootRecords=rootRecords,this.additionalFetch=additionalFetch||[],!rootRecords||0===rootRecords.length)return this.fireEvent("loaderror","No root records to load descendents for."),void 0;var model=this.getChildPortfolioItemType(rootRecords[0].get("_type"));this.load(model)},load:function(model){if(0===this.portfolioItemTypes.length)return this.fireEvent("loaderror","Portfolio Item Types not initialized."),void 0;this.storyFetch=Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.getStoryFetch(this.additionalFetch),this.portfolioItemFetch=Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingSettings.getPortfolioItemFetch(this.additionalFetch);for(var idx=_.indexOf(this.portfolioItemTypes,model.toLowerCase()),fns=[],i=idx;i>=0;i--)fns.push(this.fetchPortfolioItems);fns.push(this.fetchUserStories),this.recordsHash={},Deft.Chain.pipeline(fns,this).then({success:function(stories){this.fireEvent("rollupdataloaded",this.recordsHash,_.flatten(stories))},failure:function(msg){this.fireEvent("loaderror",msg)},scope:this})},fetchRoot:function(){this.fireEvent("statusupdate","Loading artifacts");var config=this.rootConfig||{};return config.fetch=config.fetch.concat(this.getRequiredFetchFields(config.model)),this.fetchWsapiRecordsWithPaging(config)},getChildPortfolioItemType:function(type){var idx=_.indexOf(this.portfolioItemTypes,type.toLowerCase());return idx>0?this.portfolioItemTypes[idx-1]:this.storyModelName},fetchPortfolioItems:function(parentRecords){if(parentRecords=parentRecords||this.rootRecords,!parentRecords||0===parentRecords.length)return this.fetchRoot();parentRecords=_.flatten(parentRecords);var parentType=parentRecords[0].get("_type");this.recordsHash[parentType]=parentRecords;var type=this.getChildPortfolioItemType(parentType),fetch=this.portfolioItemFetch.concat(this.getRequiredFetchFields(type)),chunks=this._getChunks(parentRecords,"Children","Count");return this.fetchChunks(type,fetch,chunks,"Parent.ObjectID",Ext.String.format("Please Wait... Loading Children for {0} Portfolio Items",parentRecords.length))},_getChunks:function(parentRecords,countField,countFieldAttribute){var chunks=[],childCount=0,maxListSize=this.maxListSize,idx=0;return chunks[idx]=[],_.each(parentRecords,function(r){var count=r.get(countField);countFieldAttribute&&count&&(count=count[countFieldAttribute]),count>0&&(chunks[idx].length>=maxListSize&&(idx++,chunks[idx]=[],childCount=0),childCount+=count,chunks[idx].push(r.get("ObjectID")))}),chunks},fetchUserStories:function(parentRecords){if(parentRecords=parentRecords||this.rootRecords,!parentRecords||0===parentRecords.length)return this.fetchRoot();parentRecords=_.flatten(parentRecords);var parentType=parentRecords[0].get("_type");this.recordsHash[parentType]=parentRecords;var type=this.storyModelName,fetch=this.storyFetch.concat(this.getRequiredFetchFields(type)),chunks=this._getChunks(parentRecords,"UserStories","Count"),featureParentName=this.featureName+".ObjectID";return this.fetchChunks(type,fetch,chunks,featureParentName,Ext.String.format("Please Wait... Loading User Stories for {0} Portfolio Items",parentRecords.length))},fetchChunks:function(type,fetch,chunks,chunkProperty,statusString){if(chunks&&chunks.length>0&&0===chunks[0].length)return Promise.resolve([]);this.fireEvent("statusupdate",statusString);var promises=[];return _.each(chunks,function(c){var filters=_.map(c,function(ids){return{property:chunkProperty,value:ids}}),config={model:type,fetch:fetch,filters:Rally.data.wsapi.Filter.or(filters)};promises.push(function(){return this.fetchWsapiRecords(config)})}),this.throttle(promises,this.maxParallelCalls,this)},fetchWsapiRecords:function(config){var deferred=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:config.model,fetch:config.fetch,filters:config.filters,limit:"Infinity"}).load({callback:function(records,operation){operation.wasSuccessful()?deferred.resolve(records):deferred.reject("fetchWsapiRecords error: "+operation.error.errors.join(","))},scope:this}),deferred},getRequiredFetchFields:function(type){return type.toLowerCase()===this.storyModelName?["Parent","PortfolioItem","ObjectID"]:["Children","UserStories","Parent","ObjectID"]},throttle:function(fns,maxParallelCalls,scope){if(0>=maxParallelCalls||maxParallelCalls>fns.length)return Deft.promise.Chain.parallel(fns,scope);for(var parallelFns=[],fnChunks=[],idx=-1,i=0;fns.length>i;i++)0===i%maxParallelCalls&&(idx++,fnChunks[idx]=[]),fnChunks[idx].push(fns[i]);return _.each(fnChunks,function(chunk){parallelFns.push(function(){return Deft.promise.Chain.parallel(chunk,scope)})}),Deft.Promise.reduce(parallelFns,function(groupResults,fnGroup){return Deft.Promise.when(fnGroup.call(scope)).then(function(results){return groupResults=groupResults.concat(results||[])})},[])},fetchWsapiCount:function(model,query_filters){var deferred=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",{model:model,fetch:["ObjectID"],filters:query_filters,limit:1,pageSize:1}).load({callback:function(records,operation,success){success?deferred.resolve(operation.resultSet.totalRecords):deferred.reject(Ext.String.format("Error getting {0} count for {1}: {2}",model,""+query_filters,operation.error.errors.join(",")))}}),deferred},fetchWsapiRecordsWithPaging:function(config){var deferred=Ext.create("Deft.Deferred"),promises=[],me=this;return this.fetchWsapiCount(config.model,config.filters).then({success:function(totalCount){var store=Ext.create("Rally.data.wsapi.Store",{model:config.model,fetch:config.fetch,filters:config.filters,pageSize:200}),totalPages=Math.ceil(totalCount/200),pages=_.range(1,totalPages+1,1);this.fireEvent("statusupdate",Ext.String.format(config.statusDisplayString||"Loading {0} artifacts",totalCount)),_.each(pages,function(page){promises.push(function(){return me.loadStorePage(page,store)})}),this.throttle(promises,12,me).then({success:function(results){deferred.resolve(_.flatten(results))},failure:function(msg){deferred.reject(msg)},scope:me})},failure:function(msg){deferred.reject(msg)},scope:me}),deferred},loadStorePage:function(pageNum,store){var deferred=Ext.create("Deft.Deferred");return store.loadPage(pageNum,{callback:function(records,operation){operation.wasSuccessful()?deferred.resolve(records):deferred.reject("loadStorePage error: "+operation.error.errors.join(","))},scope:this}),deferred}})})();
                Ext.override(Rally.ui.grid.TreeGrid,{_mergeColumnConfigs:function(newColumns,oldColumns){var mergedColumns=_.map(newColumns,function(newColumn){var oldColumn=_.find(oldColumns,{dataIndex:this._getColumnName(newColumn)});return oldColumn?this._getColumnConfigFromColumn(oldColumn):newColumn},this);return mergedColumns=mergedColumns.concat(this.config.derivedColumns)},_getPersistableColumnConfig:function(column){var columnConfig=this._getColumnConfigFromColumn(column),field=this._getModelField(columnConfig.dataIndex);return field&&field.getUUID&&field.getUUID()&&(columnConfig.dataIndex=field.getUUID()),columnConfig}});

            Rally.launchApp('Rally.apps.portfolioitemcosttracking.PortfolioItemCostTrackingApp', {
                name:"Portfolio Item Cost Tracking",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */
}

.lbl {

     text-transform: uppercase;
     font-family: ProximaNovaSemiBold, Helvetica, Arial;
     font-size: 10px;
}

.x-form-trigger-wrap {
     margin-top: 0px!important;
}

.x-column-header-text {
     margin-right: 0px!important;
}
.x-box-inner {
     overflow: visible;
}

p {
     color:#FAD200;
}
    </style>
</head>
<body></body>
</html>
